<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shamanAI - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò –ê–≥–µ–Ω—Ç</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #8A2BE2;
            --secondary: #00CED1;
            --accent: #FF1493;
            --dark: #1A1A2E;
            --light: #F0F8FF;
            --neon-glow: 0 0 10px var(--secondary), 0 0 20px var(--secondary), 0 0 30px var(--accent);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, #16213E 50%, #0F3460 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 3px solid var(--primary);
            margin-bottom: 30px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: var(--neon-glow); }
            to { text-shadow: 0 0 15px var(--accent), 0 0 25px var(--accent), 0 0 35px var(--primary); }
        }

        .shaman-title {
            font-size: 4rem;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 2px solid var(--primary);
            backdrop-filter: blur(10px);
            box-shadow: var(--neon-glow);
            overflow: hidden;
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 15px;
            position: relative;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), #9370DB);
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            align-self: flex-start;
            background: linear-gradient(135deg, var(--secondary), #20B2AA);
            border-bottom-left-radius: 5px;
        }

        .input-area {
            display: flex;
            padding: 20px;
            gap: 10px;
            border-top: 2px solid var(--primary);
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            box-shadow: 0 0 15px var(--secondary);
        }

        .tools-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 2px solid var(--secondary);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .tool-section {
            margin-bottom: 25px;
        }

        .tool-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid var(--secondary);
            padding-bottom: 5px;
        }

        .upload-area {
            border: 3px dashed var(--accent);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: rgba(255, 20, 147, 0.1);
            box-shadow: 0 0 20px var(--accent);
        }

        .preview-canvas {
            width: 100%;
            border: 2px solid var(--primary);
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .button {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: var(--neon-glow);
        }

        .math-output {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--secondary);
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            color: var(--secondary);
            font-style: italic;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="shaman-title">shamanAI</h1>
            <p class="tagline">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò –∞–≥–µ–Ω—Ç –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, —Ñ–∏–∑–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
        </div>

        <div class="main-grid">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        –ô–û–£, –∞–Ω—è, –¥–∞—Ä–æ–≤–∞
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    shamanAI –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"></span>
                </div>
                <div class="input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...">
                    <button class="button" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>

            <div class="tools-panel">
                <div class="tool-section">
                    <h3 class="tool-title">üì∑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
                        <p style="font-size: 0.9em; opacity: 0.7;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, —Ñ–æ—Ç–æ –∑–∞–¥–∞—á, –≥—Ä–∞—Ñ–∏–∫–∏, —Å—Ö–µ–º—ã</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <canvas id="previewCanvas" class="preview-canvas"></canvas>
                    <button class="button" onclick="analyzeImage()" style="width: 100%;">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>

                <div class="tool-section">
                    <h3 class="tool-title">üìä –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø</h3>
                    <button class="button" onclick="quickAction('graph')" style="width: 100%; margin-bottom: 10px;">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
                    <button class="button" onclick="quickAction('physics')" style="width: 100%; margin-bottom: 10px;">–§–æ—Ä–º—É–ª—ã —Ñ–∏–∑–∏–∫–∏</button>
                    <button class="button" onclick="quickAction('homework')" style="width: 100%; margin-bottom: 10px;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –î–ó</button>
                </div>

                <div class="tool-section">
                    <h3 class="tool-title">üßÆ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                    <div id="mathOutput" class="math-output">
                        –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ä–µ—à–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º—É–ª—ã...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å shamanAI
        class ShamanAI {
            constructor() {
                this.isInitialized = false;
                this.ocrWorker = null;
                this.mlModels = {};
                this.chatHistory = [];
                this.init();
            }

            async init() {
                await this.loadMLModels();
                await this.initOCR();
                this.isInitialized = true;
                this.addMessage("shamanAI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!", "ai");
            }

            async loadMLModels() {
                try {
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è
                    this.mlModels.objectDetection = await cocoSsd.load();
                    this.mlModels.imageClassification = await mobilenet.load();
                    console.log("ML –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ML –º–æ–¥–µ–ª–µ–π:", error);
                }
            }

            async initOCR() {
                this.ocrWorker = await Tesseract.createWorker('rus+eng', 1, {
                    logger: m => console.log(m)
                });
                await this.ocrWorker.setParameters({
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                    tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø .,!?+-=(){}[]'
                });
            }

            async processMessage(message, imageData = null) {
                this.showTypingIndicator();
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                let response = "";
                
                if (imageData) {
                    response = await this.analyzeImageContent(imageData);
                } else {
                    response = await this.generateTextResponse(message);
                }
                
                this.hideTypingIndicator();
                return response;
            }

            async analyzeImageContent(imageData) {
                let analysis = "–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n\n";
                
                try {
                    // OCR –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                    const { data: { text } } = await this.ocrWorker.recognize(imageData);
                    if (text.trim()) {
                        analysis += `üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n${text}\n\n`;
                    }

                    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
                    const objects = await this.mlModels.objectDetection.detect(imageData);
                    if (objects.length > 0) {
                        analysis += "üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:\n";
                        objects.forEach(obj => {
                            analysis += `- ${obj.class} (${Math.round(obj.score * 100)}%)\n`;
                        });
                        analysis += "\n";
                    }

                    // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const predictions = await this.mlModels.imageClassification.classify(imageData);
                    if (predictions.length > 0) {
                        analysis += "üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:\n";
                        predictions.slice(0, 3).forEach(pred => {
                            analysis += `- ${pred.className} (${Math.round(pred.probability * 100)}%)\n`;
                        });
                    }

                    if (!text.trim() && objects.length === 0) {
                        analysis += "–ù–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —á–µ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.";
                    }

                } catch (error) {
                    analysis = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.";
                }
                
                return analysis;
            }

            async generateTextResponse(message) {
                // –ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('–ø—Ä–∏–≤–µ—Ç') || lowerMessage.includes('hello')) {
                    return "–ü—Ä–∏–≤–µ—Ç! –Ø shamanAI. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π, —Ñ–∏–∑–∏–∫–æ–π, –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥—Ä—É–≥–∏–º–∏ –Ω–∞—É—á–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏.";
                }
                
                if (lowerMessage.includes('—Ñ–∏–∑–∏–∫') || lowerMessage.includes('—Ñ–æ—Ä–º—É–ª')) {
                    return this.getPhysicsFormulas(this.extractTopic(message));
                }
                
                if (lowerMessage.includes('–º–∞—Ç–µ–º–∞—Ç') || lowerMessage.includes('—Ä–µ—à–∏') || lowerMessage.includes('–≤—ã—á–∏—Å–ª')) {
                    return this.solveMathProblem(message);
                }
                
                if (lowerMessage.includes('–≥—Ä–∞—Ñ–∏–∫') || lowerMessage.includes('plot')) {
                    return this.handleGraphRequest(message);
                }
                
                if (lowerMessage.includes('–¥–∑') || lowerMessage.includes('–¥–æ–º–∞—à–Ω')) {
                    return this.generateHomework(this.extractGrade(message));
                }
                
                // –£–º–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                return this.generateSmartResponse(message);
            }

            getPhysicsFormulas(topic) {
                const formulas = {
                    '–º–µ—Ö–∞–Ω–∏–∫–∞': [
                        '–í—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞: F = ma',
                        '–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è: E‚Çñ = mv¬≤/2',
                        '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è: E‚Çö = mgh',
                        '–ò–º–ø—É–ª—å—Å: p = mv',
                        '–ó–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏: E‚ÇÅ = E‚ÇÇ'
                    ],
                    '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ': [
                        '–ó–∞–∫–æ–Ω –û–º–∞: I = U/R',
                        '–ú–æ—â–Ω–æ—Å—Ç—å: P = UI = I¬≤R = U¬≤/R',
                        '–ó–∞–∫–æ–Ω –ö—É–ª–æ–Ω–∞: F = k(q‚ÇÅq‚ÇÇ)/r¬≤',
                        '–ù–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å: E = F/q',
                        '–≠–ª–µ–∫—Ç—Ä–æ–µ–º–∫–æ—Å—Ç—å: C = q/U'
                    ],
                    '–æ–ø—Ç–∏–∫–∞': [
                        '–ó–∞–∫–æ–Ω –ø—Ä–µ–ª–æ–º–ª–µ–Ω–∏—è: n‚ÇÅsinŒ∏‚ÇÅ = n‚ÇÇsinŒ∏‚ÇÇ',
                        '–§–æ—Ä–º—É–ª–∞ –ª–∏–Ω–∑—ã: 1/F = 1/d + 1/f',
                        '–û–ø—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–ª–∞: D = 1/F',
                        '–°–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞: v = c/n'
                    ]
                };
                
                const selectedTopic = formulas[topic] ? topic : '–º–µ—Ö–∞–Ω–∏–∫–∞';
                return `üìö –§–æ—Ä–º—É–ª—ã –ø–æ —Ç–µ–º–µ "${selectedTopic}":\n${formulas[selectedTopic].join('\n')}`;
            }

            solveMathProblem(problem) {
                try {
                    // –ü—Ä–æ—Å—Ç—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
                    const cleanProblem = problem.replace(/[^0-9+\-*/().,]/g, '');
                    if (cleanProblem) {
                        const result = eval(cleanProblem);
                        return `üßÆ –†–µ—à–µ–Ω–∏–µ: ${cleanProblem} = ${result}`;
                    }
                    
                    // –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏
                    if (problem.includes('—É—Ä–∞–≤–Ω–µ–Ω–∏–µ') || problem.includes('—É—Ä–∞–≤–Ω–µ–Ω–∏—è')) {
                        return "–î–ª—è —Ä–µ—à–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É—é —á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã. –ü–æ–∫–∞–∂—É —Ä–µ—à–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏.";
                    }
                    
                    return "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏, —Ä–µ—à–µ–Ω–∏–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–π, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤. –£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–¥–∞—á—É.";
                    
                } catch (error) {
                    return "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∑–∞–¥–∞—á–µ–π.";
                }
            }

            handleGraphRequest(message) {
                return "–ì–æ—Ç–æ–≤ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫! –£–∫–∞–∂–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'y = x^2' –∏–ª–∏ 'sin(x)'";
            }

            generateHomework(grade) {
                const homework = {
                    '9': [
                        '1. –†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã –ù—å—é—Ç–æ–Ω–∞',
                        '2. –†–∞—Å—á–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è —Ç–µ–ª–∞ –ø–æ–¥ —É–≥–ª–æ–º –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç—É', 
                        '3. –ó–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏',
                        '4. –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ü–µ–ø–∏: —Ä–∞—Å—á–µ—Ç —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è'
                    ],
                    '10': [
                        '1. –ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∏–∑–∏–∫–∞: —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞-–ö–ª–∞–ø–µ–π—Ä–æ–Ω–∞',
                        '2. –¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞: —Ä–∞—Å—á–µ—Ç –ö–ü–î —Ç–µ–ø–ª–æ–≤—ã—Ö –º–∞—à–∏–Ω',
                        '3. –≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–µ—Ç–∏–∑–º: –∑–∞–∫–æ–Ω —ç–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–π –∏–Ω–¥—É–∫—Ü–∏–∏',
                        '4. –û–ø—Ç–∏–∫–∞: –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ª–∏–Ω–∑–∞—Ö'
                    ]
                };
                
                const selectedGrade = homework[grade] ? grade : '9';
                return `üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è ${selectedGrade} –∫–ª–∞—Å—Å–∞:\n${homework[selectedGrade].join('\n')}`;
            }

            generateSmartResponse(message) {
                const responses = [
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.",
                    "–ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ —Ä–µ—à–µ–Ω–∏—é —ç—Ç–æ–π –∑–∞–¥–∞—á–∏.",
                    "–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É—Å–ª–æ–≤–∏–µ–º –∑–∞–¥–∞—á–∏.",
                    "–≠—Ç–∞ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ–µ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω.",
                    "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∑–∞–∫–æ–Ω–æ–≤."
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }

            extractTopic(message) {
                const topics = ['–º–µ—Ö–∞–Ω–∏–∫–∞', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '–æ–ø—Ç–∏–∫–∞', '—Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞'];
                return topics.find(topic => message.toLowerCase().includes(topic)) || '–º–µ—Ö–∞–Ω–∏–∫–∞';
            }

            extractGrade(message) {
                const match = message.match(/\d+/);
                return match ? match[0] : '9';
            }

            addMessage(content, sender) {
                this.chatHistory.push({ content, sender, timestamp: new Date() });
            }

            showTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'block';
            }

            hideTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'none';
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let shamanAI;
        let currentImage = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async function() {
            shamanAI = new ShamanAI();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        };

        // –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (sender === 'ai') {
                shamanAI.addMessage(message, 'ai');
            } else {
                shamanAI.addMessage(message, 'user');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message && !currentImage) return;
            
            if (message) {
                addMessageToChat(message, 'user');
                input.value = '';
                
                const response = await shamanAI.processMessage(message, currentImage);
                addMessageToChat(response, 'ai');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥
                document.getElementById('mathOutput').textContent = response;
                
                currentImage = null;
                document.getElementById('previewCanvas').style.display = 'none';
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('previewCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const maxWidth = 400;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.style.display = 'block';
                    
                    currentImage = canvas;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!currentImage) {
                addMessageToChat("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", 'ai');
                return;
            }
            
            addMessageToChat("üñºÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...", 'user');
            
            const response = await shamanAI.processMessage("–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", currentImage);
            addMessageToChat(response, 'ai');
            
            document.getElementById('mathOutput').textContent = response;
        }

        function quickAction(action) {
            const actions = {
                'graph': "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤: —É–∫–∞–∂–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä 'y = sin(x)' –∏–ª–∏ 'x^2 + 2x + 1'",
                'physics': shamanAI.getPhysicsFormulas('–º–µ—Ö–∞–Ω–∏–∫–∞'),
                'homework': shamanAI.generateHomework('9')
            };
            
            addMessageToChat(actions[action], 'ai');
            document.getElementById('mathOutput').textContent = actions[action];
        }
    </script>
</body>
</html>
<!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π HTML –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ -->

<script>
// –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—à–∞—Ç–µ–ª—å shamanAI
class MathSolver {
    constructor() {
        this.complexity = 'advanced';
    }

    solveEquation(equation) {
        try {
            // –£–ø—Ä–æ—â–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
            equation = equation.replace(/[^0-9xX+\-*/().,=]/g, '');
            
            if (equation.includes('=')) {
                const sides = equation.split('=');
                return this.solveAlgebraic(sides[0], sides[1]);
            } else {
                return this.evaluateExpression(equation);
            }
        } catch (error) {
            return `–û—à–∏–±–∫–∞ —Ä–µ—à–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏—è: ${error.message}`;
        }
    }

    solveAlgebraic(left, right) {
        // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ—à–∞—Ç–µ–ª—å –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π
        const solutions = [];
        
        // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ x –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ -100 –¥–æ 100
        for (let x = -100; x <= 100; x++) {
            try {
                const leftVal = eval(left.replace(/x/gi, x));
                const rightVal = eval(right.replace(/x/gi, x));
                
                if (Math.abs(leftVal - rightVal) < 0.001) {
                    solutions.push(x);
                    if (solutions.length > 3) break;
                }
            } catch (e) {}
        }
        
        return solutions.length > 0 ? 
            `–†–µ—à–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏—è: x = ${solutions.join(', ')}` :
            '–†–µ—à–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ -100 –¥–æ 100';
    }

    evaluateExpression(expr) {
        try {
            const result = eval(expr);
            return `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${expr} = ${result}`;
        } catch (error) {
            return `–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: ${expr}`;
        }
    }

    derivative(func, point) {
        const h = 0.0001;
        try {
            const f1 = eval(func.replace(/x/g, `(${point + h})`));
            const f2 = eval(func.replace(/x/g, `(${point})`));
            const deriv = (f1 - f2) / h;
            return `–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è f'(${point}) = ${deriv.toFixed(4)}`;
        } catch (error) {
            return "–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π";
        }
    }
}

// –°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
class AdvancedGraphRenderer {
    constructor() {
        this.canvases = new Map();
    }

    createGraphCanvas(id, width = 600, height = 400) {
        const canvas = document.createElement('canvas');
        canvas.id = `graph-${id}`;
        canvas.width = width;
        canvas.height = height;
        canvas.style.border = '2px solid var(--secondary)';
        canvas.style.borderRadius = '10px';
        canvas.style.margin = '10px 0';
        return canvas;
    }

    plotFunction(func, xMin = -10, xMax = 10) {
        const canvas = this.createGraphCanvas('function');
        const ctx = canvas.getContext('2d');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
        const padding = 40;
        const graphWidth = canvas.width - 2 * padding;
        const graphHeight = canvas.height - 2 * padding;
        
        // –û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ–Ω
        ctx.fillStyle = 'rgba(26, 26, 46, 0.9)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –û—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        ctx.strokeStyle = 'var(--secondary)';
        ctx.lineWidth = 2;
        
        // –û—Å—å Y
        ctx.beginPath();
        ctx.moveTo(padding, 0);
        ctx.lineTo(padding, canvas.height);
        ctx.stroke();
        
        // –û—Å—å X
        ctx.beginPath();
        ctx.moveTo(0, canvas.height - padding);
        ctx.lineTo(canvas.width, canvas.height - padding);
        ctx.stroke();
        
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        ctx.strokeStyle = 'var(--accent)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        let firstPoint = true;
        
        for (let x = xMin; x <= xMax; x += 0.1) {
            try {
                const y = eval(func.replace(/x/g, `(${x})`));
                const pixelX = padding + (x - xMin) * (graphWidth / (xMax - xMin));
                const pixelY = canvas.height - padding - (y - this.getYMin(func, xMin, xMax)) * 
                              (graphHeight / (this.getYRange(func, xMin, xMax)));
                
                if (firstPoint) {
                    ctx.moveTo(pixelX, pixelY);
                    firstPoint = false;
                } else {
                    ctx.lineTo(pixelX, pixelY);
                }
            } catch (e) {
                firstPoint = true;
            }
        }
        
        ctx.stroke();
        return canvas;
    }

    getYMin(func, xMin, xMax) {
        let min = Infinity;
        for (let x = xMin; x <= xMax; x += 0.5) {
            try {
                const y = eval(func.replace(/x/g, `(${x})`));
                if (y < min) min = y;
            } catch (e) {}
        }
        return min === Infinity ? -10 : min;
    }

    getYRange(func, xMin, xMax) {
        let min = Infinity;
        let max = -Infinity;
        
        for (let x = xMin; x <= xMax; x += 0.5) {
            try {
                const y = eval(func.replace(/x/g, `(${x})`));
                if (y < min) min = y;
                if (y > max) max = y;
            } catch (e) {}
        }
        
        return max - min || 20;
    }

    plotPhysicsDiagram(type, parameters) {
        const canvas = this.createGraphCanvas('physics');
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = 'rgba(26, 26, 46, 0.9)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        switch(type) {
            case 'electrical':
                this.drawElectricalCircuit(ctx, parameters);
                break;
            case 'mechanics':
                this.drawMechanicalSystem(ctx, parameters);
                break;
            case 'optics':
                this.drawOpticalSystem(ctx, parameters);
                break;
        }
        
        return canvas;
    }

    drawElectricalCircuit(ctx, params) {
        ctx.strokeStyle = 'var(--secondary)';
        ctx.lineWidth = 3;
        ctx.fillStyle = 'var(--light)';
        
        // –ë–∞—Ç–∞—Ä–µ—è
        ctx.fillRect(50, 150, 40, 100);
        ctx.fillText('–ë–∞—Ç–∞—Ä–µ—è', 35, 140);
        
        // –†–µ–∑–∏—Å—Ç–æ—Ä
        ctx.fillRect(150, 150, 60, 20);
        ctx.fillText('R1', 165, 140);
        
        // –ö–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä
        ctx.fillRect(250, 130, 10, 60);
        ctx.fillRect(270, 130, 10, 60);
        ctx.fillText('C1', 255, 120);
        
        // –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        ctx.beginPath();
        ctx.moveTo(90, 150); ctx.lineTo(150, 150);
        ctx.moveTo(210, 160); ctx.lineTo(250, 160);
        ctx.moveTo(280, 160); ctx.lineTo(350, 160);
        ctx.moveTo(50, 250); ctx.lineTo(350, 250);
        ctx.stroke();
    }
}

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
class PhysicsEngine {
    constructor() {
        this.constants = {
            g: 9.81,
            c: 3e8,
            k: 8.99e9,
            h: 6.63e-34
        };
    }

    solveKinematics(problem) {
        const solutions = [];
        
        if (problem.includes('—Å–≤–æ–±–æ–¥–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ')) {
            const height = this.extractNumber(problem, '–≤—ã—Å–æ—Ç–∞');
            if (height) {
                const time = Math.sqrt(2 * height / this.constants.g);
                const velocity = this.constants.g * time;
                solutions.push(`–í—Ä–µ–º—è –ø–∞–¥–µ–Ω–∏—è: t = ${time.toFixed(2)} —Å`);
                solutions.push(`–°–∫–æ—Ä–æ—Å—Ç—å –≤ –º–æ–º–µ–Ω—Ç –ø–∞–¥–µ–Ω–∏—è: v = ${velocity.toFixed(2)} –º/—Å`);
            }
        }
        
        if (problem.includes('–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ–¥ —É–≥–ª–æ–º')) {
            const angle = this.extractNumber(problem, '—É–≥–æ–ª');
            const velocity = this.extractNumber(problem, '—Å–∫–æ—Ä–æ—Å—Ç—å');
            if (angle && velocity) {
                const rad = angle * Math.PI / 180;
                const range = (velocity * velocity * Math.sin(2 * rad)) / this.constants.g;
                const maxHeight = (velocity * velocity * Math.sin(rad) * Math.sin(rad)) / (2 * this.constants.g);
                solutions.push(`–î–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞: ${range.toFixed(2)} –º`);
                solutions.push(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞: ${maxHeight.toFixed(2)} –º`);
            }
        }
        
        return solutions.length > 0 ? solutions.join('\n') : '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ –∫–∏–Ω–µ–º–∞—Ç–∏–∫–µ';
    }

    solveDynamics(problem) {
        if (problem.includes('F = ma')) {
            const mass = this.extractNumber(problem, '–º–∞—Å—Å–∞');
            const acceleration = this.extractNumber(problem, '—É—Å–∫–æ—Ä–µ–Ω–∏–µ');
            if (mass && acceleration) {
                const force = mass * acceleration;
                return `–°–∏–ª–∞: F = ${force.toFixed(2)} –ù`;
            }
        }
        
        return '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ –¥–∏–Ω–∞–º–∏–∫–µ';
    }

    extractNumber(text, keyword) {
        const regex = new RegExp(`${keyword}[^0-9]*([0-9]+\\.?[0-9]*)`, 'i');
        const match = text.match(regex);
        return match ? parseFloat(match[1]) : null;
    }
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å ShamanAI
Object.assign(ShamanAI.prototype, {
    mathSolver: new MathSolver(),
    graphRenderer: new AdvancedGraphRenderer(),
    physicsEngine: new PhysicsEngine(),

    async processAdvancedQuery(message, imageData = null) {
        this.showTypingIndicator();
        
        // –ò–º–∏—Ç–∞—Ü–∏—è —Å–ª–æ–∂–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
        await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));
        
        let response = "";
        
        if (imageData) {
            response = await this.analyzeComplexImage(imageData);
        } else {
            response = await this.generateAdvancedResponse(message);
        }
        
        this.hideTypingIndicator();
        return response;
    },

    async analyzeComplexImage(imageData) {
        let analysis = "üîç **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**\n\n";
        
        try {
            // OCR —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            await this.ocrWorker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø .,!?+-=(){}[]/\\'
            });
            
            const { data: { text, lines } } = await this.ocrWorker.recognize(imageData);
            
            if (text.trim()) {
                analysis += `üìù **–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:**\n${text}\n\n`;
                
                // –ê–Ω–∞–ª–∏–∑ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç–µ
                const mathExpressions = this.extractMathFromText(text);
                if (mathExpressions.length > 0) {
                    analysis += "üßÆ **–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è:**\n";
                    mathExpressions.forEach(expr => {
                        try {
                            const result = this.mathSolver.evaluateExpression(expr);
                            analysis += `${expr} ‚Üí ${result}\n`;
                        } catch (e) {
                            analysis += `${expr} ‚Üí –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å\n`;
                        }
                    });
                    analysis += "\n";
                }
            }

            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤
            const objects = await this.mlModels.objectDetection.detect(imageData);
            if (objects.length > 0) {
                analysis += "üéØ **–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:**\n";
                objects.forEach(obj => {
                    analysis += `‚Ä¢ ${obj.class} (${Math.round(obj.score * 100)}% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)\n`;
                });
                analysis += "\n";
            }

            // –ê–Ω–∞–ª–∏–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Å—Ö–µ–º
            if (this.containsPhysicsElements(objects)) {
                analysis += "‚ö° **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞/–¥–∏–∞–≥—Ä–∞–º–º–∞**\n";
                analysis += "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∞–Ω–∞–ª–∏–∑–æ–º —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ø–µ–π, –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º –∏ —Ç.–¥.\n\n";
            }

        } catch (error) {
            analysis = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
        }
        
        return analysis;
    },

    extractMathFromText(text) {
        const mathPatterns = [
            /[0-9]+\s*[+\-*/]\s*[0-9]+/g,
            /[xy]\s*=\s*[^,\n]+/g,
            /[0-9]+\s*\/\s*[0-9]+/g,
            /sqrt\([^)]+\)/g,
            /sin\([^)]+\)|cos\([^)]+\)|tan\([^)]+\)/g
        ];
        
        const expressions = [];
        mathPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) expressions.push(...matches);
        });
        
        return expressions.slice(0, 5); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    },

    containsPhysicsElements(objects) {
        const physicsKeywords = ['circuit', 'battery', 'resistor', 'capacitor', 'spring', 'pulley'];
        return objects.some(obj => 
            physicsKeywords.some(keyword => 
                obj.class.toLowerCase().includes(keyword)
            )
        );
    },

    generateAdvancedResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        if (this.isMathQuery(lowerMessage)) {
            return this.handleMathQuery(message);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        if (this.isPhysicsQuery(lowerMessage)) {
            return this.handlePhysicsQuery(message);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏
        if (this.isGraphQuery(lowerMessage)) {
            return this.handleAdvancedGraphRequest(message);
        }
        
        return this.generateSmartResponse(message);
    },

    isMathQuery(message) {
        const mathKeywords = ['—Ä–µ—à–∏', '–≤—ã—á–∏—Å–ª–∏', '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ', '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è', '–∏–Ω—Ç–µ–≥—Ä–∞–ª', '–∞–ª–≥–µ–±—Ä–∞', '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'];
        return mathKeywords.some(keyword => message.includes(keyword));
    },

    isPhysicsQuery(message) {
        const physicsKeywords = ['—Ñ–∏–∑–∏–∫–∞', '–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∞', '–¥–∏–Ω–∞–º–∏–∫–∞', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '–æ–ø—Ç–∏–∫–∞', '—Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞'];
        return physicsKeywords.some(keyword => message.includes(keyword));
    },

    isGraphQuery(message) {
        const graphKeywords = ['–≥—Ä–∞—Ñ–∏–∫', '–ø–æ—Å—Ç—Ä–æ–π', '–¥–∏–∞–≥—Ä–∞–º–º–∞', 'plot', 'chart'];
        return graphKeywords.some(keyword => message.includes(keyword));
    },

    handleMathQuery(message) {
        try {
            // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –∫–∞–∫ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
            if (message.includes('=')) {
                return this.mathSolver.solveEquation(message);
            }
            
            // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã—á–∏—Å–ª–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
            const cleanExpr = message.replace(/[^0-9xX+\-*/().,]/g, '');
            if (cleanExpr) {
                return this.mathSolver.evaluateExpression(cleanExpr);
            }
            
            return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è";
        } catch (error) {
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å";
        }
    },

    handlePhysicsQuery(message) {
        let response = "";
        
        if (message.includes('–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∞') || message.includes('–ø–∞–¥–µ–Ω–∏–µ') || message.includes('–¥–≤–∏–∂–µ–Ω–∏–µ')) {
            response = this.physicsEngine.solveKinematics(message);
        } else if (message.includes('–¥–∏–Ω–∞–º–∏–∫–∞') || message.includes('—Å–∏–ª–∞') || message.includes('F = ma')) {
            response = this.physicsEngine.solveDynamics(message);
        } else {
            response = this.getPhysicsFormulas(this.extractTopic(message));
        }
        
        return response;
    },

    handleAdvancedGraphRequest(message) {
        const funcString = this.extractFunction(message);
        if (funcString) {
            try {
                const graphCanvas = this.graphRenderer.plotFunction(funcString);
                this.addGraphToChat(graphCanvas);
                return `‚úÖ –ü–æ—Å—Ç—Ä–æ–∏–ª –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏: ${funcString}`;
            } catch (error) {
                return `‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞: ${funcString}`;
            }
        }
        
        return "–£–∫–∞–∂–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'y = x^2' –∏–ª–∏ 'sin(x)*x'";
    },

    addGraphToChat(canvas) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        messageDiv.appendChild(canvas);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ processInput –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
async function processAdvancedInput() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message && !currentImage) return;
    
    if (message) {
        addMessageToChat(message, 'user');
        input.value = '';
        
        const response = await shamanAI.processAdvancedQuery(message, currentImage);
        addMessageToChat(response, 'ai');
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
        document.getElementById('mathOutput').innerHTML = response.replace(/\n/g, '<br>');
        
        currentImage = null;
        document.getElementById('previewCanvas').style.display = 'none';
    }
}

// –ó–∞–º–µ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
window.processInput = processAdvancedInput;

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const additionalStyles = `
    .advanced-math {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid var(--accent);
    }
    
    .physics-diagram {
        background: rgba(0, 206, 209, 0.1);
        border: 2px solid var(--secondary);
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
    }
    
    .solution-step {
        margin: 8px 0;
        padding-left: 20px;
        border-left: 3px solid var(--accent);
    }
    
    .error-message {
        color: #ff4444;
        background: rgba(255, 68, 68, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ff4444;
    }
    
    .success-message {
        color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #00ff88;
    }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);
</script>
<script>
// –°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram –¥–∞–Ω–Ω—ã–º–∏
class TelegramIntegration {
    constructor() {
        this.telegramChatId = "-2285349353";
        this.cachedData = {
            formulas: [],
            homeworks: [],
            pdfContents: []
        };
        this.init();
    }

    async init() {
        await this.loadCachedData();
        await this.simulateTelegramData();
    }

    async loadCachedData() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Telegram API
        // –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
        this.cachedData = {
            formulas: [
                "–ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞: v = v‚ÇÄ + at",
                "–ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞: s = v‚ÇÄt + at¬≤/2",
                "–ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞: v¬≤ = v‚ÇÄ¬≤ + 2as",
                "–î–∏–Ω–∞–º–∏–∫–∞: F = ma", 
                "–î–∏–Ω–∞–º–∏–∫–∞: F—Ç—Ä = ŒºN",
                "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: I = U/R",
                "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: P = UI",
                "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: Q = I¬≤Rt",
                "–û–ø—Ç–∏–∫–∞: n = c/v",
                "–û–ø—Ç–∏–∫–∞: 1/F = 1/d + 1/f",
                "–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞: Q = cmŒîT",
                "–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞: pV = ŒΩRT"
            ],
            homeworks: {
                "9": [
                    "¬ß15-16: –ó–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã –ù—å—é—Ç–æ–Ω–∞ ‚Ññ1-5",
                    "¬ß17: –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ–¥ —É–≥–ª–æ–º –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç—É ‚Ññ1-3",
                    "¬ß20: –ó–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ ‚Ññ2-6"
                ],
                "10": [
                    "¬ß25-26: –ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∏–∑–∏–∫–∞ ‚Ññ1-4",
                    "¬ß30: –ü–µ—Ä–≤—ã–π –∑–∞–∫–æ–Ω —Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∏ ‚Ññ3-7", 
                    "¬ß35: –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞—Ç–∏–∫–∞ ‚Ññ1-5"
                ],
                "11": [
                    "¬ß40-41: –ö–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞ ‚Ññ2-6",
                    "¬ß45: –Ø–¥–µ—Ä–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ ‚Ññ1-4",
                    "¬ß50: –û–ø—Ç–∏–∫–∞ ‚Ññ3-8"
                ]
            },
            pdfContents: [
                "–§–∏–∑–∏–∫–∞ 9 –∫–ª–∞—Å—Å: –ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞ –∏ –¥–∏–Ω–∞–º–∏–∫–∞",
                "–§–∏–∑–∏–∫–∞ 10 –∫–ª–∞—Å—Å: –ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∏–∑–∏–∫–∞",
                "–§–∏–∑–∏–∫–∞ 11 –∫–ª–∞—Å—Å: –ö–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞",
                "–°–±–æ—Ä–Ω–∏–∫ –∑–∞–¥–∞—á –ø–æ —Ñ–∏–∑–∏–∫–µ 9-11 –∫–ª–∞—Å—Å",
                "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ —Ñ–∏–∑–∏–∫–µ"
            ]
        };
    }

    async simulateTelegramData() {
        // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram
        console.log("–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram —á–∞—Ç–∞ —Ñ–∏–∑–∏–∫–∏");
    }

    searchFormulas(query) {
        const results = this.cachedData.formulas.filter(formula => 
            formula.toLowerCase().includes(query.toLowerCase())
        );
        return results.length > 0 ? results : ["–§–æ—Ä–º—É–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ Telegram"];
    }

    getHomeworkByGrade(grade) {
        return this.cachedData.homeworks[grade] || ["–î–ó –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"];
    }

    searchPDFs(query) {
        return this.cachedData.pdfContents.filter(pdf => 
            pdf.toLowerCase().includes(query.toLowerCase())
        );
    }

    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö PDF —Ñ–∞–π–ª–æ–≤
    async loadPDFContent(pdfName) {
        const pdfContents = {
            "–§–∏–∑–∏–∫–∞ 9 –∫–ª–∞—Å—Å: –ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞ –∏ –¥–∏–Ω–∞–º–∏–∫–∞": `
                –ö–ò–ù–ï–ú–ê–¢–ò–ö–ê
                1. –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ: s = vt
                2. –†–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ: 
                   v = v‚ÇÄ + at
                   s = v‚ÇÄt + at¬≤/2
                   v¬≤ = v‚ÇÄ¬≤ + 2as
                
                –î–ò–ù–ê–ú–ò–ö–ê  
                1. –í—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞: F = ma
                2. –°–∏–ª–∞ —Ç—Ä–µ–Ω–∏—è: F—Ç—Ä = ŒºN
                3. –°–∏–ª–∞ —É–ø—Ä—É–≥–æ—Å—Ç–∏: F—É–ø—Ä = kx
            `,
            "–°–±–æ—Ä–Ω–∏–∫ –∑–∞–¥–∞—á –ø–æ —Ñ–∏–∑–∏–∫–µ 9-11 –∫–ª–∞—Å—Å": `
                –ó–ê–î–ê–ß–ò –ü–û –§–ò–ó–ò–ö–ï
                
                9 –ö–õ–ê–°–°:
                1. –¢–µ–ª–æ –¥–≤–∏–∂–µ—Ç—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 5 –º/—Å. –ù–∞–π—Ç–∏ –ø—É—Ç—å –∑–∞ 10 —Å.
                2. –ù–∞–π—Ç–∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ç–µ–ª–∞ –º–∞—Å—Å–æ–π 2 –∫–≥ –ø–æ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º —Å–∏–ª—ã 10 –ù.
                
                10 –ö–õ–ê–°–°:
                1. –ù–∞–π—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–ø–ª–æ—Ç—ã –¥–ª—è –Ω–∞–≥—Ä–µ–≤–∞ 1 –∫–≥ –≤–æ–¥—ã –Ω–∞ 50¬∞C.
                2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –≥–∞–∑–∞ –ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.
            `
        };
        
        return pdfContents[pdfName] || "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ PDF –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
    }
}

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π —Å —É—á–µ—Ç–æ–º Telegram –¥–∞–Ω–Ω—ã—Ö
class AdvancedHomeworkSystem {
    constructor() {
        this.telegram = new TelegramIntegration();
    }

    generateHomework(grade, topic = null) {
        let homework = this.telegram.getHomeworkByGrade(grade);
        
        if (topic) {
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–º–µ
            homework = homework.filter(task => 
                task.toLowerCase().includes(topic.toLowerCase())
            );
            if (homework.length === 0) {
                homework = this.generateCustomHomework(grade, topic);
            }
        }

        return homework;
    }

    generateCustomHomework(grade, topic, difficulty = 'medium') {
        const templates = {
            'easy': [
                `–†–µ—à–∏—Ç–µ 5 –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á –ø–æ —Ç–µ–º–µ "${topic}"`,
                `–í—ã—É—á–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã –ø–æ —Ç–µ–º–µ "${topic}"`,
                `–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –ø–æ —Ç–µ–º–µ "${topic}" –∏ —Å–æ—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Å–ø–µ–∫—Ç`
            ],
            'medium': [
                `–†–µ—à–∏—Ç–µ 3 –∑–∞–¥–∞—á–∏ —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ —Ç–µ–º–µ "${topic}"`,
                `–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –¥–æ–∫–ª–∞–¥ –ø–æ —Ç–µ–º–µ "${topic}"`,
                `–ü—Ä–æ–≤–µ–¥–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ) –ø–æ —Ç–µ–º–µ "${topic}" –∏ –æ–ø–∏—à–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã`
            ],
            'hard': [
                `–†–µ—à–∏—Ç–µ 2 —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ —Ç–µ–º–µ "${topic}"`,
                `–ù–∞–ø–∏—à–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞—Ç –ø–æ —Ç–µ–º–µ "${topic}" —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤`,
                `–†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ "${topic}"`
            ]
        };

        return templates[difficulty] || templates['medium'];
    }

    analyzeHomeworkFromImage(imageData) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –î–ó
        return {
            subject: "—Ñ–∏–∑–∏–∫–∞",
            grade: "9",
            topics: ["–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∞", "–¥–∏–Ω–∞–º–∏–∫–∞"],
            tasks: [
                "–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ",
                "–í—ã—É—á–∏—Ç—å —Ñ–æ—Ä–º—É–ª—ã –∫–∏–Ω–µ–º–∞—Ç–∏–∫–∏"
            ]
        };
    }
}

// –°–∏—Å—Ç–µ–º–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –∏ —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
class VisualAnalysisSystem {
    constructor() {
        this.recognitionModels = {};
    }

    async analyzeScreenshot(imageData) {
        const analysis = {
            text: "",
            formulas: [],
            diagrams: [],
            homeworkInfo: null
        };

        try {
            // OCR –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const { data: { text } } = await Tesseract.recognize(imageData, 'rus+eng', {
                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø .,!?+-=(){}[]/\\'
            });
            
            analysis.text = text;

            // –ü–æ–∏—Å–∫ —Ñ–æ—Ä–º—É–ª –≤ —Ç–µ–∫—Å—Ç–µ
            analysis.formulas = this.extractFormulas(text);
            
            // –ê–Ω–∞–ª–∏–∑ –Ω–∞ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ
            if (this.isHomeworkRelated(text)) {
                analysis.homeworkInfo = this.extractHomeworkInfo(text);
            }

            // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ —Å—Ö–µ–º
            const objects = await cocoSsd.detect(imageData);
            analysis.diagrams = objects.filter(obj => 
                ['graph', 'chart', 'diagram', 'drawing'].some(keyword => 
                    obj.class.toLowerCase().includes(keyword)
                )
            );

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:", error);
        }

        return analysis;
    }

    extractFormulas(text) {
        const formulaPatterns = [
            /[a-zA-ZŒ±-œâŒë-Œ©]\s*=\s*[^,\n]+/g,
            /[a-zA-ZŒ±-œâŒë-Œ©]_{?[0-9a-zA-Z]+}?\s*=\s*[^,\n]+/g,
            /[0-9]+\s*[+\-*/^]\s*[0-9]+/g,
            /sin\([^)]+\)|cos\([^)]+\)|tan\([^)]+\)/g,
            /sqrt\([^)]+\)|‚à´[^,\n]+d[a-zA-Z]/g
        ];

        const formulas = [];
        formulaPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                formulas.push(...matches.slice(0, 3));
            }
        });

        return formulas;
    }

    isHomeworkRelated(text) {
        const keywords = ['–¥–∑', '–¥–æ–º–∞—à–Ω–µ–µ', 'homework', '–∑–∞–¥–∞–Ω–∏–µ', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', '–∑–∞–¥–∞—á–∞'];
        return keywords.some(keyword => text.toLowerCase().includes(keyword));
    }

    extractHomeworkInfo(text) {
        const gradeMatch = text.match(/(\d+)\s*(–∫–ª–∞—Å—Å|class)/i);
        const subjectMatch = text.match(/(—Ñ–∏–∑–∏–∫–∞|–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞|physics|math)/i);
        
        return {
            grade: gradeMatch ? gradeMatch[1] : null,
            subject: subjectMatch ? subjectMatch[1].toLowerCase() : null,
            tasks: this.extractTasks(text)
        };
    }

    extractTasks(text) {
        const taskPatterns = [
            /\d+\.\s*[^.\n]+/g,
            /‚Ññ\s*\d+[^.\n]*/g,
            /[–ó–∑]–∞–¥–∞—á–∞\s*\d+[^.\n]*/g
        ];

        const tasks = [];
        taskPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                tasks.push(...matches.slice(0, 5));
            }
        });

        return tasks.length > 0 ? tasks : ["–ó–∞–¥–∞—á–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ"];
    }

    async analyzeHandwrittenText(imageData) {
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        await Tesseract.setParameters({
            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
            tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø .,!?+-=()'
        });

        const { data: { text } } = await Tesseract.recognize(imageData);
        return {
            text: text,
            confidence: "–°—Ä–µ–¥–Ω—è—è", // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±—É–¥–µ—Ç –æ—Ü–µ–Ω–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            formulas: this.extractFormulas(text)
        };
    }
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å ShamanAI
Object.assign(ShamanAI.prototype, {
    telegramIntegration: new TelegramIntegration(),
    homeworkSystem: new AdvancedHomeworkSystem(),
    visualAnalysis: new VisualAnalysisSystem(),

    async processTelegramRequest(message) {
        let response = "üì° **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ Telegram —á–∞—Ç–∞:**\n\n";
        
        if (message.includes('—Ñ–æ—Ä–º—É–ª')) {
            const query = this.extractSearchQuery(message);
            const formulas = this.telegramIntegration.searchFormulas(query);
            response += `üìö –§–æ—Ä–º—É–ª—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}":\n${formulas.join('\n')}`;
        }
        else if (message.includes('–¥–∑') || message.includes('–¥–æ–º–∞—à–∫')) {
            const grade = this.extractGrade(message);
            const topic = this.extractTopic(message);
            const homework = this.homeworkSystem.generateHomework(grade, topic);
            response += `üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è ${grade} –∫–ª–∞—Å—Å–∞:\n${homework.join('\n')}`;
        }
        else if (message.includes('pdf') || message.includes('–ø–¥—Ñ')) {
            const query = this.extractSearchQuery(message);
            const pdfs = this.telegramIntegration.searchPDFs(query);
            response += `üìÑ PDF —Ñ–∞–π–ª—ã:\n${pdfs.join('\n')}`;
        }
        else {
            response += "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è Telegram:\n- '–ù–∞–π–¥–∏ —Ñ–æ—Ä–º—É–ª—ã –ø–æ ...'\n- '–î–ó –¥–ª—è 9 –∫–ª–∞—Å—Å–∞'\n- 'PDF –ø–æ —Ñ–∏–∑–∏–∫–µ'";
        }
        
        return response;
    },

    extractSearchQuery(message) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, —É–±–∏—Ä–∞—è —Å—Ç–æ–ø-—Å–ª–æ–≤–∞
        const stopWords = ['–Ω–∞–π–¥–∏', '—Ñ–æ—Ä–º—É–ª—ã', '–ø–æ', '–¥–ª—è', '—Ç–µ–º–µ', '–∫–∞–∫–∏–µ', '—á—Ç–æ', '–ø–æ–∫–∞–∂–∏'];
        const words = message.split(' ').filter(word => 
            !stopWords.includes(word.toLowerCase())
        );
        return words.join(' ') || '—Ñ–∏–∑–∏–∫–∞';
    },

    async analyzeComplexImage(imageData) {
        let analysis = "üîç **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**\n\n";
        
        try {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageType = await this.detectImageType(imageData);
            
            switch(imageType) {
                case 'screenshot':
                    analysis += await this.analyzeScreenshot(imageData);
                    break;
                case 'handwritten':
                    analysis += await this.analyzeHandwritten(imageData);
                    break;
                case 'graph':
                    analysis += await this.analyzeGraph(imageData);
                    break;
                case 'diagram':
                    analysis += await this.analyzeDiagram(imageData);
                    break;
                default:
                    analysis += await this.analyzeGeneralImage(imageData);
            }
            
        } catch (error) {
            analysis = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
        }
        
        return analysis;
    },

    async detectImageType(imageData) {
        const objects = await cocoSsd.detect(imageData);
        const text = await this.performOCR(imageData);
        
        if (text.includes('–¥–∑') || text.includes('–¥–æ–º–∞—à–Ω–µ–µ') || text.includes('–∑–∞–¥–∞–Ω–∏–µ')) {
            return 'screenshot';
        }
        
        if (objects.some(obj => ['graph', 'chart'].includes(obj.class))) {
            return 'graph';
        }
        
        if (objects.some(obj => ['diagram', 'drawing', 'circuit'].includes(obj.class))) {
            return 'diagram';
        }
        
        // –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        if (text.length > 0 && text.split('\n').length <= 5) {
            return 'handwritten';
        }
        
        return 'general';
    },

    async analyzeScreenshot(imageData) {
        const analysis = await this.visualAnalysis.analyzeScreenshot(imageData);
        let result = "üì± **–ê–Ω–∞–ª–∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:**\n\n";
        
        if (analysis.text) {
            result += `üìù –¢–µ–∫—Å—Ç: ${analysis.text.substring(0, 200)}...\n\n`;
        }
        
        if (analysis.formulas.length > 0) {
            result += `üßÆ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–æ—Ä–º—É–ª—ã:\n${analysis.formulas.join('\n')}\n\n`;
        }
        
        if (analysis.homeworkInfo) {
            result += `üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –î–ó:\n`;
            result += `–ö–ª–∞—Å—Å: ${analysis.homeworkInfo.grade || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}\n`;
            result += `–ü—Ä–µ–¥–º–µ—Ç: ${analysis.homeworkInfo.subject || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}\n`;
            result += `–ó–∞–¥–∞—á–∏: ${analysis.homeworkInfo.tasks.join(', ')}\n\n`;
        }
        
        return result;
    },

    async analyzeHandwritten(imageData) {
        const analysis = await this.visualAnalysis.analyzeHandwrittenText(imageData);
        let result = "‚úçÔ∏è **–ê–Ω–∞–ª–∏–∑ —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:**\n\n";
        
        result += `üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: ${analysis.text || '–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å'}\n`;
        result += `üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${analysis.confidence}\n`;
        
        if (analysis.formulas.length > 0) {
            result += `\nüßÆ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–æ—Ä–º—É–ª—ã:\n${analysis.formulas.join('\n')}\n`;
            
            // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
            analysis.formulas.forEach(formula => {
                try {
                    const solution = this.mathSolver.solveEquation(formula);
                    result += `‚û°Ô∏è ${formula} ‚Üí ${solution}\n`;
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Ä–µ—à–µ–Ω–∏—è
                }
            });
        }
        
        return result;
    },

    async analyzeGraph(imageData) {
        const objects = await cocoSsd.detect(imageData);
        let result = "üìä **–ê–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞:**\n\n";
        
        result += "–û–±–Ω–∞—Ä—É–∂–µ–Ω –≥—Ä–∞—Ñ–∏–∫/–¥–∏–∞–≥—Ä–∞–º–º–∞\n";
        result += `–¢–∏–ø: ${objects.map(obj => obj.class).join(', ')}\n\n`;
        result += "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:\n- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞\n- –ê–Ω–∞–ª–∏–∑–æ–º –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞\n- –†–µ—à–µ–Ω–∏–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–π –ø–æ –≥—Ä–∞—Ñ–∏–∫—É";
        
        return result;
    },

    async analyzeDiagram(imageData) {
        let result = "üîß **–ê–Ω–∞–ª–∏–∑ —Å—Ö–µ–º—ã/–¥–∏–∞–≥—Ä–∞–º–º—ã:**\n\n";
        
        result += "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞\n";
        result += "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:\n- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–∞ —Ä–∞–±–æ—Ç—ã\n- –†–∞—Å—á–µ—Ç–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–∏—Å—Ç–µ–º—ã\n- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Å—Ö–µ–º—ã";
        
        return result;
    },

    async performOCR(imageData) {
        try {
            const { data: { text } } = await Tesseract.recognize(imageData);
            return text;
        } catch (error) {
            return "";
        }
    }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
function addTelegramFeatures() {
    const toolsPanel = document.querySelector('.tools-panel');
    
    const telegramSection = document.createElement('div');
    telegramSection.className = 'tool-section';
    telegramSection.innerHTML = `
        <h3 class="tool-title">üì° Telegram –¥–∞–Ω–Ω—ã–µ</h3>
        <button class="button" onclick="quickTelegramAction('formulas')" style="width: 100%; margin-bottom: 10px;">–í—Å–µ —Ñ–æ—Ä–º—É–ª—ã</button>
        <button class="button" onclick="quickTelegramAction('homework')" style="width: 100%; margin-bottom: 10px;">–î–ó –∏–∑ —á–∞—Ç–∞</button>
        <button class="button" onclick="quickTelegramAction('pdf')" style="width: 100%; margin-bottom: 10px;">PDF —Ñ–∞–π–ª—ã</button>
    `;
    
    toolsPanel.appendChild(telegramSection);
}

function quickTelegramAction(action) {
    const actions = {
        'formulas': shamanAI.telegramIntegration.cachedData.formulas.join('\n'),
        'homework': shamanAI.homeworkSystem.generateHomework('9').join('\n'),
        'pdf': shamanAI.telegramIntegration.cachedData.pdfContents.join('\n')
    };
    
    addMessageToChat(actions[action], 'ai');
    document.getElementById('mathOutput').textContent = actions[action];
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    addTelegramFeatures();
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram —Ä–∞–∑–¥–µ–ª–∞
const telegramStyles = `
    .telegram-data {
        background: linear-gradient(135deg, var(--primary), #9370DB);
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border: 1px solid var(--accent);
    }
    
    .homework-list {
        list-style-type: none;
        padding-left: 0;
    }
    
    .homework-list li {
        margin: 8px 0;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border-left: 3px solid var(--secondary);
    }
    
    .formula-item {
        font-family: 'Courier New', monospace;
        margin: 5px 0;
        padding: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }
    
    .analysis-result {
        background: rgba(0, 206, 209, 0.1);
        border: 1px solid var(--secondary);
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
    }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = telegramStyles;
document.head.appendChild(styleSheet);
</script>
<script>
// –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å ShamanAI —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
class CompleteShamanAI {
    constructor() {
        this.isInitialized = false;
        this.optimizer = new PerformanceOptimizer();
        this.mathSolver = new AdvancedMathSolver();
        this.physicsEngine = new PhysicsEngine();
        this.graphRenderer = new AdvancedGraphRenderer();
        this.telegramIntegration = new TelegramIntegration();
        this.homeworkSystem = new AdvancedHomeworkSystem();
        this.visualAnalysis = new VisualAnalysisSystem();
        this.ocrWorker = null;
        this.mlModels = {};
        this.chatHistory = [];
        this.userContext = {
            currentSubject: 'general',
            gradeLevel: '9',
            preferredLanguage: 'ru'
        };
        
        this.init();
    }

    async init() {
        try {
            await this.loadAllModels();
            await this.telegramIntegration.init();
            await this.setupOCR();
            this.isInitialized = true;
            this.addMessage("üöÄ ShamanAI –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ì–æ—Ç–æ–≤ —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, —Ñ–∏–∑–∏–∫–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Telegram.", "ai");
            console.log("ShamanAI: –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã");
        } catch (error) {
            console.error("ShamanAI: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏", error);
            this.addMessage("‚ö†Ô∏è –ß–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç.", "ai");
        }
    }

    async loadAllModels() {
        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
        await Promise.all([
            this.loadMLModels(),
            this.loadMathModels(),
            this.loadPhysicsData()
        ]);
    }

    async loadMLModels() {
        try {
            this.mlModels = {
                objectDetection: await cocoSsd.load(),
                imageClassification: await mobilenet.load()
            };
            console.log("ShamanAI: ML –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
        } catch (error) {
            console.warn("ShamanAI: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ML –º–æ–¥–µ–ª–∏");
        }
    }

    async loadMathModels() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π
        await this.mathSolver.init();
    }

    async loadPhysicsData() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
        await this.physicsEngine.loadConstants();
    }

    async setupOCR() {
        try {
            this.ocrWorker = await Tesseract.createWorker('rus+eng', 1, {
                logger: m => console.log(m)
            });
            await this.ocrWorker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø .,!?+-=(){}[]/\\^'
            });
        } catch (error) {
            console.warn("ShamanAI: OCR –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
        }
    }

    async processMessage(message, imageData = null) {
        if (!this.isInitialized) {
            return "–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...";
        }

        this.showTypingIndicator();
        
        try {
            let response;
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
            const queryType = this.analyzeQueryType(message, imageData);
            
            switch(queryType) {
                case 'math_problem':
                    response = await this.solveMathProblem(message);
                    break;
                case 'physics_problem':
                    response = await this.solvePhysicsProblem(message);
                    break;
                case 'image_analysis':
                    response = await this.analyzeImageContent(imageData);
                    break;
                case 'graph_request':
                    response = await this.handleGraphRequest(message);
                    break;
                case 'homework_request':
                    response = await this.generateHomeworkResponse(message);
                    break;
                case 'telegram_query':
                    response = await this.processTelegramRequest(message);
                    break;
                case 'general_question':
                default:
                    response = await this.generateSmartResponse(message);
            }
            
            this.hideTypingIndicator();
            this.updateUserContext(message);
            return response;
            
        } catch (error) {
            this.hideTypingIndicator();
            return this.handleError(error, message);
        }
    }

    analyzeQueryType(message, imageData) {
        if (imageData) return 'image_analysis';
        
        const lowerMessage = message.toLowerCase();
        
        if (this.containsMathKeywords(lowerMessage)) return 'math_problem';
        if (this.containsPhysicsKeywords(lowerMessage)) return 'physics_problem';
        if (this.containsGraphKeywords(lowerMessage)) return 'graph_request';
        if (this.containsHomeworkKeywords(lowerMessage)) return 'homework_request';
        if (this.containsTelegramKeywords(lowerMessage)) return 'telegram_query';
        
        return 'general_question';
    }

    containsMathKeywords(message) {
        const keywords = ['—Ä–µ—à–∏', '–≤—ã—á–∏—Å–ª–∏', '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ', '–ø—Ä–∏–º–µ—Ä', '–ø–æ—Å—á–∏—Ç–∞–π', '–∞–ª–≥–µ–±—Ä–∞', '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '—Ñ–æ—Ä–º—É–ª–∞', '–≤—ã—Ä–∞–∂–µ–Ω–∏–µ'];
        return keywords.some(keyword => message.includes(keyword));
    }

    containsPhysicsKeywords(message) {
        const keywords = ['—Ñ–∏–∑–∏–∫–∞', '–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∞', '–¥–∏–Ω–∞–º–∏–∫–∞', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '–æ–ø—Ç–∏–∫–∞', '—Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞', '–º–µ—Ö–∞–Ω–∏–∫–∞', '–∑–∞–∫–æ–Ω'];
        return keywords.some(keyword => message.includes(keyword));
    }

    containsGraphKeywords(message) {
        const keywords = ['–≥—Ä–∞—Ñ–∏–∫', '–ø–æ—Å—Ç—Ä–æ–π', '–¥–∏–∞–≥—Ä–∞–º–º–∞', 'chart', 'plot', '—Ñ—É–Ω–∫—Ü–∏—è'];
        return keywords.some(keyword => message.includes(keyword));
    }

    containsHomeworkKeywords(message) {
        const keywords = ['–¥–∑', '–¥–æ–º–∞—à–Ω–µ–µ', 'homework', '–∑–∞–¥–∞–Ω–∏–µ', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'];
        return keywords.some(keyword => message.includes(keyword));
    }

    containsTelegramKeywords(message) {
        const keywords = ['—Ç–µ–ª–µ–≥—Ä–∞–º', 'telegram', '—á–∞—Ç', '–∫–∞–Ω–∞–ª'];
        return keywords.some(keyword => message.includes(keyword));
    }

    async solveMathProblem(message) {
        try {
            let response = "üßÆ **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**\n\n";
            
            // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
            const expressions = this.extractMathExpressions(message);
            
            if (expressions.length > 0) {
                expressions.forEach(expr => {
                    try {
                        const solution = this.mathSolver.solve(expr);
                        response += `üìù ${expr}\n‚û°Ô∏è ${solution}\n\n`;
                    } catch (error) {
                        response += `üìù ${expr}\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å\n\n`;
                    }
                });
            } else {
                // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –∫–∞–∫ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
                if (message.includes('=')) {
                    const solution = this.mathSolver.solveEquation(message);
                    response += solution;
                } else {
                    response += "–£–∫–∞–∂–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è.";
                }
            }
            
            return response;
        } catch (error) {
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ.";
        }
    }

    async solvePhysicsProblem(message) {
        let response = "‚ö° **–†–µ—à–µ–Ω–∏–µ –ø–æ —Ñ–∏–∑–∏–∫–µ:**\n\n";
        
        const topic = this.extractTopic(message);
        const formulas = this.telegramIntegration.searchFormulas(topic);
        
        response += `üìö –§–æ—Ä–º—É–ª—ã –ø–æ —Ç–µ–º–µ "${topic}":\n`;
        formulas.slice(0, 5).forEach(formula => {
            response += `‚Ä¢ ${formula}\n`;
        });
        response += "\n";
        
        // –ü–æ–ø—ã—Ç–∫–∞ —á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è
        try {
            const numericalSolution = this.physicsEngine.solveProblem(message);
            if (numericalSolution) {
                response += `üî¢ –ß–∏—Å–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:\n${numericalSolution}\n`;
            }
        } catch (error) {
            response += "–î–ª—è —á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.\n";
        }
        
        return response;
    }

    async analyzeImageContent(imageData) {
        let response = "üîç **–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**\n\n";
        
        try {
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageType = await this.detectImageType(imageData);
            response += `üìä –¢–∏–ø: ${this.getImageTypeName(imageType)}\n\n`;
            
            // –ê–Ω–∞–ª–∏–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            switch(imageType) {
                case 'handwritten':
                    const handwrittenAnalysis = await this.visualAnalysis.analyzeHandwrittenText(imageData);
                    response += this.formatHandwrittenAnalysis(handwrittenAnalysis);
                    break;
                    
                case 'screenshot':
                    const screenshotAnalysis = await this.visualAnalysis.analyzeScreenshot(imageData);
                    response += this.formatScreenshotAnalysis(screenshotAnalysis);
                    break;
                    
                case 'graph':
                    response += "üìà –û–±–Ω–∞—Ä—É–∂–µ–Ω –≥—Ä–∞—Ñ–∏–∫. –ú–æ–≥—É –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –∏–ª–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.\n";
                    break;
                    
                case 'diagram':
                    response += "üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Ö–µ–º–∞/–¥–∏–∞–≥—Ä–∞–º–º–∞. –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é.\n";
                    break;
                    
                default:
                    const generalAnalysis = await this.performGeneralImageAnalysis(imageData);
                    response += generalAnalysis;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤
            if (this.mlModels.objectDetection) {
                const objects = await this.mlModels.objectDetection.detect(imageData);
                if (objects.length > 0) {
                    response += "\nüéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:\n";
                    objects.slice(0, 5).forEach(obj => {
                        response += `‚Ä¢ ${obj.class} (${Math.round(obj.score * 100)}%)\n`;
                    });
                }
            }
            
        } catch (error) {
            response += "‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.\n";
        }
        
        return response;
    }

    async detectImageType(imageData) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é OCR –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è
        let text = "";
        try {
            const { data: { text: ocrText } } = await this.ocrWorker.recognize(imageData);
            text = ocrText;
        } catch (error) {
            console.warn("OCR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
        }
        
        let objects = [];
        if (this.mlModels.objectDetection) {
            objects = await this.mlModels.objectDetection.detect(imageData);
        }
        
        // –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
        if (text.length > 0) {
            if (text.includes('–¥–∑') || text.includes('–¥–æ–º–∞—à–Ω–µ–µ') || text.includes('–∑–∞–¥–∞–Ω–∏–µ')) {
                return 'screenshot';
            }
            
            const lineCount = text.split('\n').length;
            if (lineCount <= 3 && text.length < 100) {
                return 'handwritten';
            }
        }
        
        if (objects.some(obj => ['graph', 'chart'].includes(obj.class))) {
            return 'graph';
        }
        
        if (objects.some(obj => ['diagram', 'drawing', 'circuit'].includes(obj.class))) {
            return 'diagram';
        }
        
        return 'general';
    }

    getImageTypeName(type) {
        const names = {
            'handwritten': '–†—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç',
            'screenshot': '–°–∫—Ä–∏–Ω—à–æ—Ç/–¥–æ–∫—É–º–µ–Ω—Ç',
            'graph': '–ì—Ä–∞—Ñ–∏–∫/–¥–∏–∞–≥—Ä–∞–º–º–∞',
            'diagram': '–°—Ö–µ–º–∞/—á–µ—Ä—Ç–µ–∂',
            'general': '–û–±—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'
        };
        return names[type] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø';
    }

    formatHandwrittenAnalysis(analysis) {
        let response = "‚úçÔ∏è **–†—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç:**\n";
        response += `üìù ${analysis.text || "–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω"}\n\n`;
        
        if (analysis.formulas && analysis.formulas.length > 0) {
            response += "üßÆ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–æ—Ä–º—É–ª—ã:\n";
            analysis.formulas.forEach(formula => {
                response += `‚Ä¢ ${formula}\n`;
            });
        }
        
        return response;
    }

    formatScreenshotAnalysis(analysis) {
        let response = "üì± **–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞:**\n";
        
        if (analysis.text) {
            const preview = analysis.text.length > 150 ? 
                analysis.text.substring(0, 150) + "..." : analysis.text;
            response += `üìÑ ${preview}\n\n`;
        }
        
        if (analysis.homeworkInfo) {
            response += "üìö **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏–∏:**\n";
            if (analysis.homeworkInfo.grade) {
                response += `üè´ –ö–ª–∞—Å—Å: ${analysis.homeworkInfo.grade}\n`;
            }
            if (analysis.homeworkInfo.subject) {
                response += `üìñ –ü—Ä–µ–¥–º–µ—Ç: ${analysis.homeworkInfo.subject}\n`;
            }
            if (analysis.homeworkInfo.tasks) {
                response += `üìù –ó–∞–¥–∞—á–∏: ${analysis.homeworkInfo.tasks.join(', ')}\n`;
            }
        }
        
        return response;
    }

    async performGeneralImageAnalysis(imageData) {
        let response = "";
        
        try {
            if (this.ocrWorker) {
                const { data: { text } } = await this.ocrWorker.recognize(imageData);
                if (text.trim()) {
                    response += `üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n${text.substring(0, 200)}...\n\n`;
                }
            }
            
            if (this.mlModels.imageClassification) {
                const predictions = await this.mlModels.imageClassification.classify(imageData);
                if (predictions.length > 0) {
                    response += "üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n";
                    predictions.slice(0, 3).forEach(pred => {
                        response += `‚Ä¢ ${pred.className} (${Math.round(pred.probability * 100)}%)\n`;
                    });
                }
            }
        } catch (error) {
            response += "‚ÑπÔ∏è –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω\n";
        }
        
        return response;
    }

    async handleGraphRequest(message) {
        const funcString = this.extractFunction(message);
        if (funcString) {
            try {
                const graphCanvas = this.graphRenderer.plotFunction(funcString);
                this.addGraphToChat(graphCanvas);
                return `‚úÖ –ü–æ—Å—Ç—Ä–æ–∏–ª –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏: ${funcString}`;
            } catch (error) {
                return `‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞: ${funcString}`;
            }
        }
        
        return "–£–∫–∞–∂–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞. –ü—Ä–∏–º–µ—Ä: 'y = x^2' –∏–ª–∏ 'sin(x)*x'";
    }

    async generateHomeworkResponse(message) {
        const grade = this.extractGrade(message);
        const topic = this.extractTopic(message);
        
        let response = `üìù **–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è ${grade} –∫–ª–∞—Å—Å–∞:**\n\n`;
        
        // –ü–æ–ª—É—á–∞–µ–º –î–ó –∏–∑ Telegram
        const telegramHomework = this.homeworkSystem.generateHomework(grade, topic);
        response += "üì° –ò–∑ Telegram —á–∞—Ç–∞:\n";
        telegramHomework.forEach(task => {
            response += `‚Ä¢ ${task}\n`;
        });
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
        response += "\nüéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏:\n";
        const customHomework = this.homeworkSystem.generateCustomHomework(grade, topic || '—Ñ–∏–∑–∏–∫–∞');
        customHomework.forEach(task => {
            response += `‚Ä¢ ${task}\n`;
        });
        
        return response;
    }

    extractMathExpressions(text) {
        const patterns = [
            /[0-9]+\s*[+\-*/^]\s*[0-9]+/g,
            /[xy]\s*=\s*[^,\n]+/gi,
            /[a-z]+\s*=\s*[^,\n]+/gi,
            /sqrt\([^)]+\)/g,
            /sin\([^)]+\)|cos\([^)]+\)|tan\([^)]+\)/g,
            /[0-9]+\s*\/\s*[0-9]+/g
        ];
        
        const expressions = [];
        patterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                expressions.push(...matches.slice(0, 2));
            }
        });
        
        return [...new Set(expressions)]; // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    }

    extractFunction(message) {
        const patterns = [
            /[yY]\s*=\s*([^,\n]+)/,
            /—Ñ—É–Ω–∫—Ü–∏—è:\s*([^,\n]+)/i,
            /–≥—Ä–∞—Ñ–∏–∫\s+([^,\n]+)/i,
            /plot\s+([^,\n]+)/i
        ];
        
        for (let pattern of patterns) {
            const match = message.match(pattern);
            if (match) return match[1].trim();
        }
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
        const mathExpr = this.extractMathExpressions(message)[0];
        return mathExpr || null;
    }

    extractTopic(message) {
        const topics = ['–∫–∏–Ω–µ–º–∞—Ç–∏–∫–∞', '–¥–∏–Ω–∞–º–∏–∫–∞', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '–æ–ø—Ç–∏–∫–∞', '—Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞', '–º–µ—Ö–∞–Ω–∏–∫–∞'];
        const found = topics.find(topic => message.toLowerCase().includes(topic));
        return found || '—Ñ–∏–∑–∏–∫–∞';
    }

    extractGrade(message) {
        const match = message.match(/(\d+)\s*(?:–∫–ª–∞—Å—Å|class)/i);
        return match ? match[1] : '9';
    }

    generateSmartResponse(message) {
        const responses = [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ —Ä–µ—à–µ–Ω–∏—é.",
            "–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —É—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏.",
            "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º —Ç–µ–æ—Ä–∏–∏.",
            "–≠—Ç–∞ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ—ë –ø–æ–¥—Ä–æ–±–Ω–µ–µ.",
            "–ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ —Å –ø–æ—à–∞–≥–æ–≤—ã–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º."
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
    }

    handleError(error, context) {
        console.error(`ShamanAI error in ${context}:`, error);
        
        const errorMessages = {
            'math': "‚ùå –û—à–∏–±–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è.",
            'physics': "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É. –£—Ç–æ—á–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.",
            'image': "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.",
            'general': "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        };
        
        return errorMessages[context] || errorMessages['general'];
    }

    updateUserContext(message) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        if (this.containsMathKeywords(message.toLowerCase())) {
            this.userContext.currentSubject = 'math';
        } else if (this.containsPhysicsKeywords(message.toLowerCase())) {
            this.userContext.currentSubject = 'physics';
        }
        
        const gradeMatch = message.match(/(\d+)\s*–∫–ª–∞—Å—Å/i);
        if (gradeMatch) {
            this.userContext.gradeLevel = gradeMatch[1];
        }
    }

    addMessage(content, sender) {
        this.chatHistory.push({
            content,
            sender,
            timestamp: new Date(),
            context: { ...this.userContext }
        });
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (this.chatHistory.length > 50) {
            this.chatHistory = this.chatHistory.slice(-50);
        }
    }

    showTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.style.display = 'block';
    }

    hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.style.display = 'none';
    }

    addGraphToChat(canvas) {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            messageDiv.appendChild(canvas);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
}

// –°–∏—Å—Ç–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
class PerformanceOptimizer {
    constructor() {
        this.cache = new Map();
        this.cacheDuration = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
    }

    set(key, value) {
        this.cache.set(key, {
            value,
            timestamp: Date.now()
        });
    }

    get(key) {
        const item = this.cache.get(key);
        if (item && Date.now() - item.timestamp < this.cacheDuration) {
            return item.value;
        }
        this.cache.delete(key);
        return null;
    }

    clear() {
        this.cache.clear();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
let shamanAI;
let currentImage = null;

window.onload = async function() {
    shamanAI = new CompleteShamanAI();
    setupEventListeners();
    setupAdvancedUI();
};

function setupEventListeners() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            processInput();
        }
    });

    // Drag and drop –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const uploadArea = document.querySelector('.upload-area');
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.background = 'rgba(255, 20, 147, 0.2)';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.background = '';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.background = '';
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('fileInput').files = files;
            handleImageUpload({ target: document.getElementById('fileInput') });
        }
    });
}

function setupAdvancedUI() {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const toolsPanel = document.querySelector('.tools-panel');
    
    const advancedSection = document.createElement('div');
    advancedSection.className = 'tool-section';
    advancedSection.innerHTML = `
        <h3 class="tool-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3>
        <button class="button" onclick="quickCommand('solve_equation')" style="width: 100%; margin-bottom: 10px;">–†–µ—à–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
        <button class="button" onclick="quickCommand('physics_formulas')" style="width: 100%; margin-bottom: 10px;">–§–æ—Ä–º—É–ª—ã —Ñ–∏–∑–∏–∫–∏</button>
        <button class="button" onclick="quickCommand('generate_homework')" style="width: 100%; margin-bottom: 10px;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –î–ó</button>
        <button class="button" onclick="quickCommand('clear_chat')" style="width: 100%; margin-bottom: 10px; background: linear-gradient(45deg, #FF4444, #FF1493);">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    `;
    
    toolsPanel.appendChild(advancedSection);
}

function quickCommand(command) {
    const commands = {
        'solve_equation': '–†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: 2*x + 5 = 15',
        'physics_formulas': '–ü–æ–∫–∞–∂–∏ —Ñ–æ—Ä–º—É–ª—ã –ø–æ –∫–∏–Ω–µ–º–∞—Ç–∏–∫–µ',
        'generate_homework': '–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –î–ó –ø–æ —Ñ–∏–∑–∏–∫–µ –¥–ª—è 9 –∫–ª–∞—Å—Å–∞',
        'clear_chat': 'clear'
    };
    
    if (command === 'clear_chat') {
        clearChat();
    } else {
        document.getElementById('chatInput').value = commands[command];
    }
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="message ai-message">–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>';
}

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function addMessageToChat(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    messageDiv.textContent = message;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function processInput() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message && !currentImage) return;
    
    if (message) {
        addMessageToChat(message, 'user');
        input.value = '';
        
        const response = await shamanAI.processMessage(message, currentImage);
        addMessageToChat(response, 'ai');
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
        document.getElementById('mathOutput').innerHTML = response.replace(/\n/g, '<br>');
        
        currentImage = null;
        const previewCanvas = document.getElementById('previewCanvas');
        if (previewCanvas) previewCanvas.style.display = 'none';
    }
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
            const maxWidth = 400;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.style.display = 'block';
            
            currentImage = canvas;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function analyzeImage() {
    if (!currentImage) {
        addMessageToChat("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", 'ai');
        return;
    }
    
    addMessageToChat("üñºÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...", 'user');
    processInput();
}
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ */
.enhanced-features {
    background: rgba(138, 43, 226, 0.1);
    border: 1px solid var(--primary);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.feature-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--secondary);
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online {
    background: #00ff00;
    box-shadow: 0 0 10px #00ff00;
}

.status-offline {
    background: #ff4444;
}

.system-status {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--secondary);
    font-size: 0.8em;
}

@media (max-width: 768px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
    
    .shaman-title {
        font-size: 2.5rem;
    }
    
    .chat-messages {
        height: 400px;
    }
    
    .system-status {
        position: static;
        margin-top: 20px;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s infinite;
}

/* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π */
.math-solution {
    border-left: 4px solid #8A2BE2;
    background: rgba(138, 43, 226, 0.1);
}

.physics-solution {
    border-left: 4px solid #00CED1;
    background: rgba(0, 206, 209, 0.1);
}

.image-analysis {
    border-left: 4px solid #FF1493;
    background: rgba(255, 20, 147, 0.1);
}
</style>

<div class="system-status">
    <span class="status-indicator status-online"></span>
    ShamanAI: <span id="systemStatus">–í—Å–µ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–Ω—ã</span>
</div>
