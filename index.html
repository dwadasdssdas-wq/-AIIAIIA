<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shamanAI - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò –ê–≥–µ–Ω—Ç</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #8A2BE2;
            --secondary: #00CED1;
            --accent: #FF1493;
            --dark: #1A1A2E;
            --light: #F0F8FF;
            --neon-glow: 0 0 10px var(--secondary), 0 0 20px var(--secondary), 0 0 30px var(--accent);
            --matrix: #00FF41;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, #16213E 50%, #0F3460 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.1) 2px,
                    rgba(0, 255, 65, 0.1) 4px
                );
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 3px solid var(--primary);
            margin-bottom: 30px;
            animation: glow 2s ease-in-out infinite alternate;
            position: relative;
            overflow: hidden;
        }

        @keyframes glow {
            from { 
                text-shadow: var(--neon-glow);
                box-shadow: 0 0 20px var(--primary);
            }
            to { 
                text-shadow: 0 0 15px var(--accent), 0 0 25px var(--accent), 0 0 35px var(--primary);
                box-shadow: 0 0 30px var(--accent);
            }
        }

        .shaman-title {
            font-size: 4rem;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent), var(--matrix));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            position: relative;
        }

        .shaman-title::after {
            content: '‚ñà‚ñà';
            animation: blink 1s infinite;
            margin-left: 10px;
            color: var(--matrix);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .tagline {
            font-size: 1.2rem;
            opacity: 0.8;
            color: var(--matrix);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 2px solid var(--primary);
            backdrop-filter: blur(10px);
            box-shadow: var(--neon-glow);
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 15px;
            position: relative;
            animation: messageSlide 0.3s ease-out;
            line-height: 1.5;
        }

        @keyframes messageSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), #9370DB);
            border-bottom-right-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-message {
            align-self: flex-start;
            background: linear-gradient(135deg, var(--secondary), #20B2AA);
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-area {
            display: flex;
            padding: 20px;
            gap: 10px;
            border-top: 2px solid var(--primary);
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .chat-input:focus {
            box-shadow: 0 0 15px var(--secondary);
            border-color: var(--matrix);
        }

        .tools-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 2px solid var(--secondary);
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
        }

        .tool-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tool-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid var(--secondary);
            padding-bottom: 5px;
        }

        .upload-area {
            border: 3px dashed var(--accent);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: rgba(255, 20, 147, 0.1);
        }

        .upload-area:hover {
            background: rgba(255, 20, 147, 0.2);
            box-shadow: 0 0 20px var(--accent);
            transform: translateY(-2px);
        }

        .preview-canvas {
            width: 100%;
            border: 2px solid var(--primary);
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            background: white;
        }

        .button {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
            position: relative;
            overflow: hidden;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }

        .button:hover::before {
            left: 100%;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: var(--neon-glow);
        }

        .math-output {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--secondary);
            font-family: 'Courier New', monospace;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            color: var(--secondary);
            font-style: italic;
            background: rgba(0, 206, 209, 0.1);
            margin: 0 20px;
            border-radius: 10px;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .matrix-text {
            color: var(--matrix);
            text-shadow: 0 0 10px var(--matrix);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-online {
            background: var(--matrix);
            box-shadow: 0 0 10px var(--matrix);
        }

        .api-section {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--secondary);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="shaman-title">shamanAI</h1>
            <p class="tagline">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò –∞–≥–µ–Ω—Ç —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Ç–µ–∫—Å—Ç–∞ –∏ –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator status-online"></span>
                <span class="matrix-text">–°–ò–°–¢–ï–ú–ê –ê–ö–¢–ò–í–ù–ê | –†–ï–ñ–ò–ú: –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê</span>
            </div>
        </div>

        <div class="main-grid">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <span class="matrix-text">>> –°–ò–°–¢–ï–ú–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ê</span><br><br>
                        –ü—Ä–∏–≤–µ—Ç! –Ø <strong>shamanAI</strong> - –Ω–∞—Å—Ç–æ—è—â–∏–π –ò–ò —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞, –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Ä–µ—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á. 
                        –Ø –º–æ–≥—É:<br>
                        ‚Ä¢ –û–±—â–∞—Ç—å—Å—è –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã –∫–∞–∫ ChatGPT<br>
                        ‚Ä¢ –†–µ—à–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏<br>
                        ‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç<br>
                        ‚Ä¢ –°—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã<br>
                        ‚Ä¢ –†–∞–±–æ—Ç–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Telegram<br><br>
                        <span class="matrix-text">>> –ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï</span>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <span class="matrix-text">shamanAI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç</span><span class="typing-dots"></span>
                </div>
                <div class="input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...">
                    <button class="button" onclick="sendMessage()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                </div>
            </div>

            <div class="tools-panel">
                <div class="tool-section">
                    <h3 class="tool-title">üì∑ –ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô</h3>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
                        <p style="font-size: 0.9em; opacity: 0.7;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç, –≥—Ä–∞—Ñ–∏–∫–∏</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <canvas id="previewCanvas" class="preview-canvas"></canvas>
                    <button class="button" onclick="analyzeImage()" style="width: 100%;">–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï</button>
                </div>

                <div class="tool-section">
                    <h3 class="tool-title">‚ö° –ë–´–°–¢–†–´–ô –î–û–°–¢–£–ü</h3>
                    <button class="button" onclick="quickAction('math')" style="width: 100%; margin-bottom: 10px;">–†–ï–®–ò–¢–¨ –ó–ê–î–ê–ß–£</button>
                    <button class="button" onclick="quickAction('physics')" style="width: 100%; margin-bottom: 10px;">–§–û–†–ú–£–õ–´ –§–ò–ó–ò–ö–ò</button>
                    <button class="button" onclick="quickAction('graph')" style="width: 100%; margin-bottom: 10px;">–ü–û–°–¢–†–û–ò–¢–¨ –ì–†–ê–§–ò–ö</button>
                    <button class="button" onclick="quickAction('clear')" style="width: 100%; background: linear-gradient(45deg, #FF4444, #FF1493);">–û–ß–ò–°–¢–ò–¢–¨ –ß–ê–¢</button>
                </div>

                <div class="tool-section">
                    <h3 class="tool-title">üßÆ –†–ï–ó–£–õ–¨–¢–ê–¢–´</h3>
                    <div id="mathOutput" class="math-output">
                        <span class="matrix-text">>> –û–ñ–ò–î–ê–Æ –ó–ê–ü–†–û–°–ê</span><br>
                        –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ä–µ—à–µ–Ω–∏—è, —Ñ–æ—Ä–º—É–ª—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞...
                    </div>
                </div>

                <div class="api-section">
                    <h3 class="tool-title">üîë API –ù–ê–°–¢–†–û–ô–ö–ò</h3>
                    <input type="text" class="api-input" id="apiKey" placeholder="OpenAI API –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    <select class="api-input" id="modelSelect">
                        <option value="local">–õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (–±–∞–∑–æ–≤–∞—è)</option>
                        <option value="gpt-3.5">GPT-3.5 Turbo (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                        <option value="gpt-4">GPT-4 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è)</option>
                    </select>
                    <button class="button" onclick="saveSettings()" style="width: 100%;">–°–û–•–†–ê–ù–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω–∞—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å shamanAI
        class ShamanAILanguageModel {
            constructor() {
                this.context = [];
                this.knowledgeBase = this.initializeKnowledgeBase();
                this.sentenceEncoder = null;
                this.init();
            }

            async init() {
                try {
                    // –ó–∞–≥—Ä—É–∑–∫–∞ Universal Sentence Encoder –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
                    this.sentenceEncoder = await use.load();
                    console.log("ShamanAI: –Ø–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
                } catch (error) {
                    console.warn("ShamanAI: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–Ω–∫–æ–¥–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å");
                }
            }

            initializeKnowledgeBase() {
                return {
                    "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞": {
                        "—Ñ–æ—Ä–º—É–ª—ã": [
                            "–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: ax¬≤ + bx + c = 0, x = (-b ¬± ‚àö(b¬≤-4ac))/2a",
                            "–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞: a¬≤ + b¬≤ = c¬≤",
                            "–ü–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞: S = œÄr¬≤",
                            "–û–±—ä–µ–º —à–∞—Ä–∞: V = (4/3)œÄr¬≥",
                            "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è: (x‚Åø)' = nx‚Åø‚Åª¬π",
                            "–ò–Ω—Ç–µ–≥—Ä–∞–ª: ‚à´x‚Åø dx = x‚Åø‚Å∫¬π/(n+1) + C"
                        ],
                        "–º–µ—Ç–æ–¥—ã": [
                            "–î–ª—è —Ä–µ—à–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–ª–∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥",
                            "–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º–∏ –ø–æ–º–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è",
                            "–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –∏–Ω—Ç–µ–≥—Ä–∞–ª–æ–≤"
                        ]
                    },
                    "—Ñ–∏–∑–∏–∫–∞": {
                        "–º–µ—Ö–∞–Ω–∏–∫–∞": [
                            "–í—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞: F = ma",
                            "–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è: E‚Çñ = mv¬≤/2", 
                            "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è: E‚Çö = mgh",
                            "–ó–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏: E‚ÇÅ = E‚ÇÇ",
                            "–ò–º–ø—É–ª—å—Å: p = mv"
                        ],
                        "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ": [
                            "–ó–∞–∫–æ–Ω –û–º–∞: I = U/R",
                            "–ú–æ—â–Ω–æ—Å—Ç—å: P = UI = I¬≤R = U¬≤/R",
                            "–ó–∞–∫–æ–Ω –ö—É–ª–æ–Ω–∞: F = k(q‚ÇÅq‚ÇÇ)/r¬≤",
                            "–≠–ª–µ–∫—Ç—Ä–æ–µ–º–∫–æ—Å—Ç—å: C = q/U"
                        ],
                        "–æ–ø—Ç–∏–∫–∞": [
                            "–ó–∞–∫–æ–Ω –ø—Ä–µ–ª–æ–º–ª–µ–Ω–∏—è: n‚ÇÅsinŒ∏‚ÇÅ = n‚ÇÇsinŒ∏‚ÇÇ",
                            "–§–æ—Ä–º—É–ª–∞ –ª–∏–Ω–∑—ã: 1/F = 1/d + 1/f"
                        ]
                    },
                    "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ": {
                        "–∞–ª–≥–æ—Ä–∏—Ç–º—ã": [
                            "–ë—ã—Å—Ç—Ä–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: O(n log n) –≤ —Å—Ä–µ–¥–Ω–µ–º —Å–ª—É—á–∞–µ",
                            "–ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫: O(log n)",
                            "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ä–∞–∑–±–µ–π –∑–∞–¥–∞—á—É –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏"
                        ],
                        "—Å—Ç—Ä—É–∫—Ç—É—Ä—ã": [
                            "–ú–∞—Å—Å–∏–≤: –¥–æ—Å—Ç—É–ø O(1), –ø–æ–∏—Å–∫ O(n)",
                            "–°–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫: –≤—Å—Ç–∞–≤–∫–∞ O(1), –ø–æ–∏—Å–∫ O(n)",
                            "–•—ç—à-—Ç–∞–±–ª–∏—Ü–∞: –ø–æ–∏—Å–∫ O(1) –≤ —Å—Ä–µ–¥–Ω–µ–º —Å–ª—É—á–∞–µ"
                        ]
                    }
                };
            }

            async generateResponse(userMessage, context = [], useAdvancedAI = false) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                this.context.push({ role: 'user', content: userMessage });
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                if (this.context.length > 10) {
                    this.context = this.context.slice(-10);
                }

                let response = '';

                if (useAdvancedAI && window.openAIAvailable) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é AI –º–æ–¥–µ–ª—å
                    response = await this.callAdvancedAI(userMessage, context);
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
                    response = await this.generateLocalResponse(userMessage, context);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                this.context.push({ role: 'assistant', content: response });
                
                return response;
            }

            async generateLocalResponse(userMessage, context) {
                // –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                const lowerMessage = userMessage.toLowerCase();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –∑–∞–ø—Ä–æ—Å–∞
                const topic = this.detectTopic(lowerMessage);
                const intent = this.detectIntent(lowerMessage);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                let response = this.buildContextualResponse(userMessage, topic, intent);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–Ω–∞–Ω–∏—è
                const relevantKnowledge = this.getRelevantKnowledge(topic, userMessage);
                if (relevantKnowledge) {
                    response += `\n\nüìö **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**\n${relevantKnowledge}`;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
                response += this.generateFollowUpSuggestions(topic, intent);
                
                return response;
            }

            detectTopic(message) {
                const topics = {
                    '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': ['–º–∞—Ç–µ–º–∞', '—Ä–µ—à–∏', '—É—Ä–∞–≤–Ω–µ–Ω', '—Ñ–æ—Ä–º—É–ª', '—Ä–∞—Å—Å—á–∏—Ç', '–≤—ã—á–∏—Å–ª'],
                    '—Ñ–∏–∑–∏–∫–∞': ['—Ñ–∏–∑–∏–∫', '–∑–∞–∫–æ–Ω ', '—ç–Ω–µ—Ä–≥', '—Å–∏–ª–∞', '—Å–∫–æ—Ä–æ—Å—Ç', '—É—Å–∫–æ—Ä–µ–Ω'],
                    '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': ['–ø—Ä–æ–≥—Ä–∞–º–º', '–∫–æ–¥', '–∞–ª–≥–æ—Ä–∏—Ç–º', 'python', 'javascript'],
                    '–Ω–∞—É–∫–∞': ['–Ω–∞—É–∫', '–∏—Å—Å–ª–µ–¥', '—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç', '—Ç–µ–æ—Ä–∏—è'],
                    '–æ–±—â–µ–Ω–∏–µ': ['–ø—Ä–∏–≤–µ—Ç', '–∫–∞–∫ –¥–µ–ª–∞', '—Ä–∞—Å—Å–∫–∞–∂–∏', '–æ–±—ä—è—Å–Ω–∏']
                };
                
                for (const [topic, keywords] of Object.entries(topics)) {
                    if (keywords.some(keyword => message.includes(keyword))) {
                        return topic;
                    }
                }
                
                return '–æ–±—â–µ–µ';
            }

            detectIntent(message) {
                if (message.includes('?')) return '–≤–æ–ø—Ä–æ—Å';
                if (message.includes('–æ–±—ä—è—Å–Ω–∏') || message.includes('—Ä–∞—Å—Å–∫–∞–∂–∏')) return '–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ';
                if (message.includes('—Ä–µ—à–∏') || message.includes('–ø–æ—Å—á–∏—Ç–∞–π')) return '—Ä–µ—à–µ–Ω–∏–µ';
                if (message.includes('—Ñ–æ—Ä–º—É–ª') || message.includes('–∑–∞–∫–æ–Ω')) return '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è';
                return '–æ–±—â–µ–Ω–∏–µ';
            }

            buildContextualResponse(message, topic, intent) {
                const responses = {
                    '–≤–æ–ø—Ä–æ—Å': {
                        '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "–û—Ç–ª–∏—á–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ...",
                        '—Ñ–∏–∑–∏–∫–∞': "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ–≥–æ —Å –Ω–∞—É—á–Ω–æ–π —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è...",
                        '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é. –î–∞–≤–∞–π—Ç–µ –∏–∑—É—á–∏–º –µ–≥–æ...",
                        '–æ–±—â–µ–µ': "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±—ä—è—Å–Ω–∏—Ç—å —ç—Ç–æ –ø–æ–¥—Ä–æ–±–Ω–æ..."
                    },
                    '–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ': {
                        '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "–° —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –æ–±—ä—è—Å–Ω—é —ç—Ç—É –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é...",
                        '—Ñ–∏–∑–∏–∫–∞': "–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–Ω—Ü–∏–ø —à–∞–≥ –∑–∞ —à–∞–≥–æ–º...",
                        '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "–û–±—ä—è—Å–Ω—é —ç—Ç–æ—Ç –∞—Å–ø–µ–∫—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º...",
                        '–æ–±—â–µ–µ': "–†–∞—Å—Å–∫–∞–∂—É –æ–± —ç—Ç–æ–º –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ..."
                    },
                    '—Ä–µ—à–µ–Ω–∏–µ': {
                        '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "–†–µ—à–∏–º —ç—Ç—É –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ...",
                        '—Ñ–∏–∑–∏–∫–∞': "–ü—Ä–∏—Å—Ç—É–ø–∏–º –∫ —Ä–µ—à–µ–Ω–∏—é —ç—Ç–æ–π —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏...",
                        '–æ–±—â–µ–µ': "–†–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Å–∏—Å—Ç–µ–º–Ω–æ..."
                    }
                };

                const baseResponse = responses[intent]?.[topic] || 
                                   "–û—Ç–ª–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –≤–º–µ—Å—Ç–µ...";

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                return `${baseResponse}\n\n${this.generateDetailedResponse(message, topic)}`;
            }

            generateDetailedResponse(message, topic) {
                switch(topic) {
                    case '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞':
                        return this.generateMathResponse(message);
                    case '—Ñ–∏–∑–∏–∫–∞':
                        return this.generatePhysicsResponse(message);
                    case '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ':
                        return this.generateProgrammingResponse(message);
                    default:
                        return this.generateGeneralResponse(message);
                }
            }

            generateMathResponse(message) {
                let response = "";
                
                if (message.includes('—É—Ä–∞–≤–Ω–µ–Ω')) {
                    response = "–î–ª—è —Ä–µ—à–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π –≤–∞–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —É—Ä–∞–≤–Ω–µ–Ω–∏—è: –ª–∏–Ω–µ–π–Ω–æ–µ, –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ, –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏ —Ç.–¥. ";
                    response += "–ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã —Ä–µ—à–µ–Ω–∏—è. ";
                    response += "–ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º—É–ª—É –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç–∞.";
                } else if (message.includes('–ø—Ä–æ–∏–∑–≤–æ–¥')) {
                    response = "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏. ";
                    response += "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è —Å—É–º–º—ã, –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, —á–∞—Å—Ç–Ω–æ–≥–æ –∏ —Å–ª–æ–∂–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏. ";
                    response += "–ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏ - —ç—Ç–æ —É–≥–ª–æ–≤–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π.";
                } else {
                    response = "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - —ç—Ç–æ —è–∑—ã–∫ –≤—Å–µ–ª–µ–Ω–Ω–æ–π. ";
                    response += "–õ—é–±—É—é –∑–∞–¥–∞—á—É –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏. ";
                    response += "–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –∫–∞–∫ —Ä–µ—à–∞—Ç—å, –Ω–æ –∏ –ø–æ—á–µ–º—É –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç.";
                }
                
                return response;
            }

            generatePhysicsResponse(message) {
                let response = "";
                
                if (message.includes('—ç–Ω–µ—Ä–≥')) {
                    response = "–≠–Ω–µ—Ä–≥–∏—è - —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–Ω—è—Ç–∏–µ –≤ —Ñ–∏–∑–∏–∫–µ. ";
                    response += "–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è - —Å –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º. ";
                    response += "–ó–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ - –æ–¥–∏–Ω –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–≤ –ø—Ä–∏—Ä–æ–¥—ã.";
                } else if (message.includes('—Å–∏–ª')) {
                    response = "–°–∏–ª–∞ - —ç—Ç–æ –º–µ—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Ç–µ–ª. ";
                    response += "–í –º–µ—Ö–∞–Ω–∏–∫–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Å–∏–ª—ã —Ç—è–∂–µ—Å—Ç–∏, —Ç—Ä–µ–Ω–∏—è, —É–ø—Ä—É–≥–æ—Å—Ç–∏. ";
                    response += "–í—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞ —Å–≤—è–∑—ã–≤–∞–µ—Ç —Å–∏–ª—É, –º–∞—Å—Å—É –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ.";
                } else {
                    response = "–§–∏–∑–∏–∫–∞ –æ–±—ä—è—Å–Ω—è–µ—Ç –∑–∞–∫–æ–Ω—ã –ø—Ä–∏—Ä–æ–¥—ã. ";
                    response += "–ö–∞–∂–¥–æ–µ —è–≤–ª–µ–Ω–∏–µ –∏–º–µ–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ. ";
                    response += "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∫–ª—é—á–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç —Ñ–∏–∑–∏–∫–∏.";
                }
                
                return response;
            }

            generateProgrammingResponse(message) {
                return "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞. ";
                + "–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. ";
                + "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —è–∑—ã–∫–æ–≤ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π.";
            }

            generateGeneralResponse(message) {
                const responses = [
                    "–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ–µ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω...",
                    "–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É...",
                    "–û—Ç–ª–∏—á–Ω–∞—è —Ç–µ–º–∞! –£ –º–µ–Ω—è –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º—ã—Å–ª–µ–π –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É...",
                    "–î–∞–≤–∞–π—Ç–µ —É–≥–ª—É–±–∏–º—Å—è –≤ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –∏ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ..."
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }

            getRelevantKnowledge(topic, query) {
                if (!this.knowledgeBase[topic]) return null;
                
                let relevantItems = [];
                
                // –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
                Object.values(this.knowledgeBase[topic]).forEach(category => {
                    category.forEach(item => {
                        if (this.isRelevant(item, query)) {
                            relevantItems.push(item);
                        }
                    });
                });
                
                return relevantItems.slice(0, 3).join('\n‚Ä¢ ');
            }

            isRelevant(knowledgeItem, query) {
                const queryWords = query.toLowerCase().split(' ');
                const knowledgeWords = knowledgeItem.toLowerCase().split(' ');
                
                return queryWords.some(qWord => 
                    knowledgeWords.some(kWord => kWord.includes(qWord) || qWord.includes(kWord))
                );
            }

            generateFollowUpSuggestions(topic, intent) {
                const suggestions = {
                    '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "\n\nüí° –•–æ—Ç–∏—Ç–µ —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–µ–º—É –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏?",
                    '—Ñ–∏–∑–∏–∫–∞': "\n\n‚ö° –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –ª–∏ –≤–∞—Å –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã —Ñ–∏–∑–∏–∫–∏?",
                    '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "\n\nüíª –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —è–∑—ã–∫–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è?",
                    '–æ–±—â–µ–µ': "\n\nüéØ –ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
                };
                
                return suggestions[topic] || "\n\nüîç –ß–µ–º –µ—â–µ –º–æ–≥—É –ø–æ–º–æ—á—å?";
            }

            async callAdvancedAI(message, context) {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ –≤–Ω–µ—à–Ω–µ–≥–æ AI API
                try {
                    const apiKey = localStorage.getItem('shamanai_api_key');
                    const model = localStorage.getItem('shamanai_model') || 'local';
                    
                    if (!apiKey || model === 'local') {
                        return await this.generateLocalResponse(message, context);
                    }
                    
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º API
                    // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    return await this.generateEnhancedResponse(message, context);
                    
                } catch (error) {
                    console.warn("Advanced AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:", error);
                    return await this.generateLocalResponse(message, context);
                }
            }

            async generateEnhancedResponse(message, context) {
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                let response = await this.generateLocalResponse(message, context);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                response += "\n\n" + this.generateAdditionalInsights(message);
                
                return response;
            }

            generateAdditionalInsights(message) {
                const insights = [
                    "üí´ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** –≠—Ç–∞ —Ç–µ–º–∞ –∏–º–µ–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –≥–ª—É–±–∂–µ.",
                    "üîç **–ì–ª—É–±–∂–µ –≤ —Ç–µ–º—É:** –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–∞–∂–Ω—ã–º–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è–º–∏.",
                    "üéØ **–ö–ª—é—á–µ–≤–æ–π –≤—ã–≤–æ–¥:** –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è –∑–¥–µ—Å—å - –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤.",
                    "üöÄ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:** –†–µ–∫–æ–º–µ–Ω–¥—É—é –∏–∑—É—á–∏—Ç—å —Å–º–µ–∂–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è."
                ];
                
                return insights[Math.floor(Math.random() * insights.length)];
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let shamanAI;
        let currentImage = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async function() {
            shamanAI = new ShamanAILanguageModel();
            setupEventListeners();
            loadSettings();
            
            addMessageToChat("üîÑ <span class='matrix-text'>ShamanAI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span><br>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!", "ai");
        };

        function setupEventListeners() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Drag and drop –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = 'rgba(255, 20, 147, 0.3)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = 'rgba(255, 20, 147, 0.1)';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = 'rgba(255, 20, 147, 0.1)';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleImageUpload({ target: document.getElementById('fileInput') });
                }
            });
        }

        function loadSettings() {
            const savedApiKey = localStorage.getItem('shamanai_api_key');
            const savedModel = localStorage.getItem('shamanai_model');
            
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
            if (savedModel) {
                document.getElementById('modelSelect').value = savedModel;
            }
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            
            localStorage.setItem('shamanai_api_key', apiKey);
            localStorage.setItem('shamanai_model', model);
            
            addMessageToChat("‚öôÔ∏è <span class='matrix-text'>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</span>", "ai");
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message && !currentImage) return;
            
            if (message) {
                addMessageToChat(message, 'user');
                input.value = '';
                
                showTypingIndicator();
                
                try {
                    const useAdvancedAI = localStorage.getItem('shamanai_model') !== 'local';
                    const response = await shamanAI.generateResponse(message, [], useAdvancedAI);
                    
                    hideTypingIndicator();
                    addMessageToChat(response, 'ai');
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
                    document.getElementById('mathOutput').innerHTML = response.replace(/\n/g, '<br>');
                    
                } catch (error) {
                    hideTypingIndicator();
                    addMessageToChat("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", "ai");
                }
                
                currentImage = null;
                document.getElementById('previewCanvas').style.display = 'none';
            }
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('previewCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                    const maxWidth = 400;
                    const scale = Math.min(maxWidth / img.width, 1);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.style.display = 'block';
                    
                    currentImage = canvas;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!currentImage) {
                addMessageToChat("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", 'ai');
                return;
            }
            
            addMessageToChat("üñºÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...", 'user');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            addMessageToChat("üîç <span class='matrix-text'>–ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø</span><br>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã.", "ai");
        }

        function quickAction(action) {
            const actions = {
                'math': "–†–µ—à–∏ —Å–ª–æ–∂–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É: –ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏ f(x) = x¬≥ - 3x¬≤ + 2x - 5 –∏ –≤—ã—á–∏—Å–ª–∏—Ç—å –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–æ—á–∫–µ x=2",
                'physics': "–û–±—ä—è—Å–Ω–∏ –∑–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –∏ –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –µ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏",
                'graph': "–ü–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏ y = sin(x)*cos(x) –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –æ—Ç -2œÄ –¥–æ 2œÄ",
                'clear': "clear"
            };
            
            if (action === 'clear') {
                clearChat();
            } else {
                document.getElementById('chatInput').value = actions[action];
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<div class="message ai-message"><span class="matrix-text">>> –ß–ê–¢ –û–ß–ò–©–ï–ù</span><br>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤–æ–º—É –¥–∏–∞–ª–æ–≥—É. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>';
            document.getElementById('mathOutput').innerHTML = '<span class="matrix-text">>> –û–ñ–ò–î–ê–Æ –ó–ê–ü–†–û–°–ê</span><br>–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ä–µ—à–µ–Ω–∏—è, —Ñ–æ—Ä–º—É–ª—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞...';
        }
    </script>
</body>
</html>
<script>
// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º
class AdvancedTextGenerator {
    constructor() {
        this.conversationHistory = [];
        this.userProfile = {
            interests: [],
            knowledgeLevel: 'medium',
            preferredLanguage: 'ru'
        };
        this.responseTemplates = this.initializeTemplates();
    }

    initializeTemplates() {
        return {
            greeting: [
                "–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å. –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞—à –¥–µ–Ω—å?",
                "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.",
                "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω —Å–µ–≥–æ–¥–Ω—è?",
                "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ó–∞–¥–∞–≤–∞–π—Ç–µ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã - —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –Ω–∞ –Ω–∏—Ö –æ—Ç–≤–µ—á—É."
            ],
            question: [
                "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ...",
                "–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±—ä—è—Å–Ω–∏—Ç—å —ç—Ç–æ –ø–æ–Ω—è—Ç–Ω—ã–º –æ–±—Ä–∞–∑–æ–º...",
                "–•–æ—Ä–æ—à–æ, –¥–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω...",
                "–ü–æ–Ω–∏–º–∞—é –≤–∞—à –∏–Ω—Ç–µ—Ä–µ—Å –∫ —ç—Ç–æ–π —Ç–µ–º–µ. –í–æ—Ç —á—Ç–æ —è –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å..."
            ],
            explanation: [
                "–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –æ–±—ä—è—Å–Ω–∏—Ç—å —ç—Ç–æ —à–∞–≥ –∑–∞ —à–∞–≥–æ–º...",
                "–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç—É —Ç–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ...",
                "–ß—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —ç—Ç–æ, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏...",
                "–û–±—ä—è—Å–Ω—é —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ..."
            ],
            problemSolving: [
                "–†–µ—à–∏–º —ç—Ç—É –∑–∞–¥–∞—á—É —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏...",
                "–ü—Ä–∏—Å—Ç—É–ø–∏–º –∫ —Ä–µ—à–µ–Ω–∏—é. –í–æ—Ç –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π...",
                "–†–∞–∑–±–µ—Ä–µ–º —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ...",
                "–ù–∞—á–Ω–µ–º —Å –∞–Ω–∞–ª–∏–∑–∞ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏..."
            ]
        };
    }

    async generateIntelligentResponse(userInput, context = []) {
        // –ê–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const intent = this.analyzeIntent(userInput);
        const topic = this.analyzeTopic(userInput);
        const sentiment = this.analyzeSentiment(userInput);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this.updateUserProfile(userInput, topic);
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        let response = await this.generateContextualResponse(userInput, intent, topic, sentiment, context);
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        response = this.addPersonalization(response, topic);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        response = this.formatResponse(response, intent);
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        this.conversationHistory.push({
            user: userInput,
            ai: response,
            timestamp: new Date(),
            topic: topic,
            intent: intent
        });
        
        return response;
    }

    analyzeIntent(userInput) {
        const input = userInput.toLowerCase();
        
        if (this.isGreeting(input)) return 'greeting';
        if (this.isQuestion(input)) return 'question';
        if (this.isProblem(input)) return 'problem';
        if (this.isExplanationRequest(input)) return 'explanation';
        if (this.isOpinionRequest(input)) return 'opinion';
        
        return 'conversation';
    }

    analyzeTopic(userInput) {
        const input = userInput.toLowerCase();
        const topics = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': ['–º–∞—Ç–µ–º–∞—Ç–∏–∫', '—É—Ä–∞–≤–Ω–µ–Ω', '—Ñ–æ—Ä–º—É–ª', '—Ä–∞—Å—Å—á–∏—Ç', '—á–∏—Å–ª–æ', '–≥–µ–æ–º–µ—Ç—Ä', '–∞–ª–≥–µ–±—Ä'],
            '—Ñ–∏–∑–∏–∫–∞': ['—Ñ–∏–∑–∏–∫', '–∑–∞–∫–æ–Ω', '—ç–Ω–µ—Ä–≥', '—Å–∏–ª–∞', '—Å–∫–æ—Ä–æ—Å—Ç', '—É—Å–∫–æ—Ä–µ–Ω', '–∞—Ç–æ–º', '–º–æ–ª–µ–∫—É–ª'],
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': ['–ø—Ä–æ–≥—Ä–∞–º–º', '–∫–æ–¥', '–∞–ª–≥–æ—Ä–∏—Ç–º', 'python', 'javascript', 'html', 'css'],
            '–Ω–∞—É–∫–∞': ['–Ω–∞—É–∫', '–∏—Å—Å–ª–µ–¥', '—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç', '—Ç–µ–æ—Ä–∏—è', '–≥–∏–ø–æ—Ç–µ–∑'],
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': ['—Ç–µ—Ö–Ω–æ–ª–æ–≥', '–∫–æ–º–ø—å—é—Ç–µ—Ä', '—Å–º–∞—Ä—Ç—Ñ–æ–Ω', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '–∏–∏', '–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω'],
            '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': ['—É—á–µ–±', '—à–∫–æ–ª', '—É–Ω–∏–≤–µ—Ä', '—Å—Ç—É–¥–µ–Ω—Ç', '–ø—Ä–µ–ø–æ–¥–∞–≤–∞', '–æ–±—Ä–∞–∑–æ–≤–∞–Ω'],
            '–ª–∏—á–Ω–æ–µ': ['–∫–∞–∫ –¥–µ–ª–∞', '–Ω–∞—Å—Ç—Ä–æ–µ–Ω', '—á—É–≤—Å—Ç–≤', '–º—ã—Å–ª', '–º–Ω–µ–Ω']
        };
        
        for (const [topic, keywords] of Object.entries(topics)) {
            if (keywords.some(keyword => input.includes(keyword))) {
                return topic;
            }
        }
        
        return '–æ–±—â–µ–µ';
    }

    analyzeSentiment(userInput) {
        const positiveWords = ['—Å–ø–∞—Å–∏–±–æ', '–æ—Ç–ª–∏—á–Ω–æ', '–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ', '—Ö–æ—Ä–æ—à–æ', '–ø–æ–Ω—Ä–∞–≤–∏–ª', '–∏–Ω—Ç–µ—Ä–µ—Å–Ω', '–ª—é–±'];
        const negativeWords = ['–ø–ª–æ—Ö–æ', '—É–∂–∞—Å–Ω–æ', '–Ω–µ–Ω–∞–≤–∏–∂', '—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω', '—Å–ª–æ–∂–Ω', '—Ç—Ä—É–¥–Ω', '–ø—Ä–æ–±–ª–µ–º'];
        
        const input = userInput.toLowerCase();
        let score = 0;
        
        positiveWords.forEach(word => {
            if (input.includes(word)) score++;
        });
        
        negativeWords.forEach(word => {
            if (input.includes(word)) score--;
        });
        
        if (score > 0) return 'positive';
        if (score < 0) return 'negative';
        return 'neutral';
    }

    isGreeting(input) {
        const greetings = ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤', '–¥–æ–±—Ä—ã–π', 'hello', 'hi', '—Ö–∞–π'];
        return greetings.some(greet => input.includes(greet));
    }

    isQuestion(input) {
        return input.includes('?') || 
               input.startsWith('–∫—Ç–æ') ||
               input.startsWith('—á—Ç–æ') ||
               input.startsWith('–≥–¥–µ') ||
               input.startsWith('–∫–æ–≥–¥–∞') ||
               input.startsWith('–ø–æ—á–µ–º—É') ||
               input.startsWith('–∫–∞–∫');
    }

    isProblem(input) {
        const problemWords = ['—Ä–µ—à–∏', '–ø–æ—Å—á–∏—Ç–∞–π', '—Ä–∞—Å—Å—á–∏—Ç–∞–π', '–Ω–∞–π–¥–∏', '–æ–ø—Ä–µ–¥–µ–ª–∏', '–≤—ã—á–∏—Å–ª–∏'];
        return problemWords.some(word => input.includes(word));
    }

    isExplanationRequest(input) {
        const explanationWords = ['–æ–±—ä—è—Å–Ω–∏', '—Ä–∞—Å—Å–∫–∞–∂–∏', '–æ–ø–∏—à–∏', '–ø–æ–∫–∞–∂–∏', '–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä'];
        return explanationWords.some(word => input.includes(word));
    }

    isOpinionRequest(input) {
        const opinionWords = ['–¥—É–º–∞–µ—à—å', '—Å—á–∏—Ç–∞–µ—à—å', '–º–Ω–µ–Ω–∏–µ', '—Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è', '–∫–∞–∫ –¥—É–º–∞–µ—à—å'];
        return opinionWords.some(word => input.includes(word));
    }

    updateUserProfile(userInput, topic) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (topic !== '–æ–±—â–µ–µ' && !this.userProfile.interests.includes(topic)) {
            this.userProfile.interests.push(topic);
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
            if (this.userProfile.interests.length > 10) {
                this.userProfile.interests.shift();
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∑–Ω–∞–Ω–∏–π
        const complexWords = ['–∫–≤–∞–Ω—Ç–æ–≤', '—Ä–µ–ª—è—Ç–∏–≤–∏—Å—Ç—Å–∫', '–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª', '–∏–Ω—Ç–µ–≥—Ä–∞–ª', '–∞–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫'];
        if (complexWords.some(word => userInput.toLowerCase().includes(word))) {
            this.userProfile.knowledgeLevel = 'high';
        }
    }

    async generateContextualResponse(userInput, intent, topic, sentiment, context) {
        let response = '';
        
        switch(intent) {
            case 'greeting':
                response = this.generateGreetingResponse(sentiment);
                break;
            case 'question':
                response = await this.generateQuestionResponse(userInput, topic);
                break;
            case 'problem':
                response = await this.generateProblemResponse(userInput, topic);
                break;
            case 'explanation':
                response = await this.generateExplanationResponse(userInput, topic);
                break;
            case 'opinion':
                response = this.generateOpinionResponse(userInput, topic);
                break;
            default:
                response = await this.generateConversationalResponse(userInput, topic, context);
        }
        
        return response;
    }

    generateGreetingResponse(sentiment) {
        const templates = this.responseTemplates.greeting;
        let response = templates[Math.floor(Math.random() * templates.length)];
        
        if (sentiment === 'positive') {
            response += " –†–∞–¥ –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏!";
        } else if (sentiment === 'negative') {
            response += " –ù–∞–¥–µ—é—Å—å, —è —Å–º–æ–≥—É —É–ª—É—á—à–∏—Ç—å –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.";
        }
        
        if (this.conversationHistory.length > 0) {
            response += " –ü—Ä–æ–¥–æ–ª–∂–∏–º –Ω–∞—à—É –±–µ—Å–µ–¥—É?";
        }
        
        return response;
    }

    async generateQuestionResponse(userInput, topic) {
        let response = this.responseTemplates.question[Math.floor(Math.random() * this.responseTemplates.question.length)];
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const topicContent = await this.getTopicContent(topic, userInput);
        response += "\n\n" + topicContent;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        response += this.getAdditionalInsights(topic);
        
        return response;
    }

    async generateProblemResponse(userInput, topic) {
        let response = this.responseTemplates.problemSolving[Math.floor(Math.random() * this.responseTemplates.problemSolving.length)];
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞–≥–æ–≤ —Ä–µ—à–µ–Ω–∏—è
        const solutionSteps = await this.generateSolutionSteps(userInput, topic);
        response += "\n\n" + solutionSteps;
        
        return response;
    }

    async generateExplanationResponse(userInput, topic) {
        let response = this.responseTemplates.explanation[Math.floor(Math.random() * this.responseTemplates.explanation.length)];
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
        const detailedExplanation = await this.generateDetailedExplanation(userInput, topic);
        response += "\n\n" + detailedExplanation;
        
        return response;
    }

    generateOpinionResponse(userInput, topic) {
        const opinions = {
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': "–Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è –∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –º–Ω–æ–≥–æ –ø–æ–ª—å–∑—ã, –Ω–æ –≤–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö —Ä–∞–∑—É–º–Ω–æ.",
            '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –∫–ª—é—á –∫ —Ä–∞–∑–≤–∏—Ç–∏—é. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤—Å–µ –±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏.",
            '–Ω–∞—É–∫–∞': "–ù–∞—É—á–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–≤–∏–≥–∞—é—Ç —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ –≤–ø–µ—Ä–µ–¥. –û—Å–æ–±–µ–Ω–Ω–æ –≤–ø–µ—á–∞—Ç–ª—è—é—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.",
            '–æ–±—â–µ–µ': "–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π. –° —Ä–∞–∑–Ω—ã—Ö —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤."
        };
        
        return opinions[topic] || opinions['–æ–±—â–µ–µ'];
    }

    async generateConversationalResponse(userInput, topic, context) {
        // –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        const contextAnalysis = this.analyzeConversationContext(context);
        
        let response = "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! ";
        
        if (contextAnalysis.hasContinuation) {
            response += "–ü—Ä–æ–¥–æ–ª–∂–∞—è –Ω–∞—à—É —Ç–µ–º—É, —Ö–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å... ";
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const relevantContent = await this.getTopicContent(topic, userInput);
        response += relevantContent;
        
        // –ó–∞–¥–∞–Ω–∏–µ —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
        response += this.generateFollowUpQuestion(topic);
        
        return response;
    }

    analyzeConversationContext(context) {
        if (context.length === 0) {
            return { hasContinuation: false, mainTopic: null };
        }
        
        const lastTopics = context.slice(-3).map(msg => msg.topic);
        const mainTopic = this.getMostFrequentTopic(lastTopics);
        
        return {
            hasContinuation: context.length > 1,
            mainTopic: mainTopic
        };
    }

    getMostFrequentTopic(topics) {
        const frequency = {};
        topics.forEach(topic => {
            frequency[topic] = (frequency[topic] || 0) + 1;
        });
        
        return Object.keys(frequency).reduce((a, b) => 
            frequency[a] > frequency[b] ? a : b
        );
    }

    async getTopicContent(topic, userInput) {
        // –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ —Ç–µ–º–∞–º
        const knowledgeBase = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': `
–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - —ç—Ç–æ —è–∑—ã–∫ –≤—Å–µ–ª–µ–Ω–Ω–æ–π. –û–Ω–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –æ–ø–∏—Å—ã–≤–∞—Ç—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ —Ä–µ—à–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏. 

–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:
‚Ä¢ –ê–ª–≥–µ–±—Ä–∞ - —Ä–∞–±–æ—Ç–∞ —Å —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
‚Ä¢ –ì–µ–æ–º–µ—Ç—Ä–∏—è - –∏–∑—É—á–µ–Ω–∏–µ —Ñ–æ—Ä–º –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ - –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã
‚Ä¢ –¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π - –∞–Ω–∞–ª–∏–∑ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

–°–æ–≤–µ—Ç: –ü—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å –∞–Ω–∞–ª–∏–∑–∞ —É—Å–ª–æ–≤–∏—è –∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–∞ —Ä–µ—à–µ–Ω–∏—è.
            `,
            '—Ñ–∏–∑–∏–∫–∞': `
–§–∏–∑–∏–∫–∞ –∏–∑—É—á–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã –ø—Ä–∏—Ä–æ–¥—ã. –û—Ç –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö —á–∞—Å—Ç–∏—Ü –¥–æ –∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö –º–∞—Å—à—Ç–∞–±–æ–≤.

–ö–ª—é—á–µ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏:
‚Ä¢ –ú–µ—Ö–∞–Ω–∏–∫–∞ - –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–µ–ª –∏ —Å–∏–ª—ã
‚Ä¢ –¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞ - —Ç–µ–ø–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è
‚Ä¢ –≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–µ—Ç–∏–∑–º - —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∏ –º–∞–≥–Ω–∏—Ç–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è
‚Ä¢ –û–ø—Ç–∏–∫–∞ - —Å–≤–µ—Ç –∏ –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞

–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: –ú–Ω–æ–≥–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö –ø—Ä–æ—à–ª–æ–≥–æ –≤–µ–∫–∞.
            `,
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': `
–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤.

–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —è–∑—ã–∫–∏:
‚Ä¢ Python - –¥–ª—è –Ω–∞—É–∫–∏ –∏ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚Ä¢ JavaScript - –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
‚Ä¢ Java - –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö enterprise-—Å–∏—Å—Ç–µ–º
‚Ä¢ C++ - –¥–ª—è –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

–¢—Ä–µ–Ω–¥: –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è.
            `,
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': `
–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç –Ω–∞—à –º–∏—Ä —Å –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é.

–¢–µ–∫—É—â–∏–µ —Ç—Ä–µ–Ω–¥—ã:
‚Ä¢ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
‚Ä¢ –ö–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
‚Ä¢ –ë–∏–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –≥–µ–Ω–Ω–∞—è –∏–Ω–∂–µ–Ω–µ—Ä–∏—è
‚Ä¢ –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞

–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –±—É–¥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –º–µ–Ω—è—Ç—å –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –Ω–∞—à–µ–π –∂–∏–∑–Ω–∏.
            `
        };
        
        const baseContent = knowledgeBase[topic] || 
            "–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –£ –º–µ–Ω—è –µ—Å—Ç—å —Ä–∞–∑–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É, –∫–æ—Ç–æ—Ä—É—é —è –º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å.";
        
        // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        return this.personalizeContent(baseContent, userInput, topic);
    }

    personalizeContent(content, userInput, topic) {
        let personalized = content;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –∑–∞–ø—Ä–æ—Å–µ
        if (userInput.includes('–ø—Ä–æ—Å—Ç–æ–π') || userInput.includes('–ª–µ–≥–∫')) {
            personalized = "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å –æ—Å–Ω–æ–≤...\n\n" + personalized;
        }
        
        if (userInput.includes('—Å–ª–æ–∂–Ω') || userInput.includes('–ø—Ä–æ–¥–≤–∏–Ω—É—Ç')) {
            personalized = "–î–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å–ª–æ–∂–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã...\n\n" + personalized;
        }
        
        if (userInput.includes('–ø—Ä–∏–º–µ—Ä') || userInput.includes('–ø—Ä–∏–º–µ–Ω–µ–Ω')) {
            personalized += "\n\nüìã **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:** " + this.generateExample(topic);
        }
        
        return personalized;
    }

    generateExample(topic) {
        const examples = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "–ù–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã —Ä–µ—à–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ x¬≤ - 5x + 6 = 0, –º—ã –Ω–∞—Ö–æ–¥–∏–º –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç D = 25 - 24 = 1, —Ç–æ–≥–¥–∞ x = (5 ¬± 1)/2, –ø–æ–ª—É—á–∞–µ–º x‚ÇÅ = 3, x‚ÇÇ = 2.",
            '—Ñ–∏–∑–∏–∫–∞': "–ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ–º –ø–∞–¥–µ–Ω–∏–∏ —Ç–µ–ª–∞ —Å –≤—ã—Å–æ—Ç—ã 20 –º–µ—Ç—Ä–æ–≤, –≤—Ä–µ–º—è –ø–∞–¥–µ–Ω–∏—è t = ‚àö(2h/g) = ‚àö(40/9.8) ‚âà 2.02 —Å–µ–∫—É–Ω–¥—ã.",
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "–ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å—Ç–æ–π —Ü–∏–∫–ª –Ω–∞ Python –¥–ª—è –≤—ã–≤–æ–¥–∞ —á–∏—Å–µ–ª –æ—Ç 1 –¥–æ 5: for i in range(1, 6): print(i)",
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': "–ù–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ª–∏—Ü."
        };
        
        return examples[topic] || "–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è...";
    }

    getAdditionalInsights(topic) {
        const insights = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "\n\nüí° **–ò–Ω—Å–∞–π—Ç:** –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, –ø–æ–ª–µ–∑–Ω–æ–µ –≤ –ª—é–±–æ–π –æ–±–ª–∞—Å—Ç–∏ –∂–∏–∑–Ω–∏.",
            '—Ñ–∏–∑–∏–∫–∞': "\n\n‚ö° **–ò–Ω—Å–∞–π—Ç:** –§–∏–∑–∏—á–µ—Å–∫–∏–µ –∑–∞–∫–æ–Ω—ã —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–æ –≤—Å–µ–π –í—Å–µ–ª–µ–Ω–Ω–æ–π.",
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "\n\nüíª **–ò–Ω—Å–∞–π—Ç:** –£–º–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ –≤–∞–∂–Ω–æ–π skill, –∫–∞–∫ —á—Ç–µ–Ω–∏–µ –∏ –ø–∏—Å—å–º–æ.",
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': "\n\nüöÄ **–ò–Ω—Å–∞–π—Ç:** –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ - —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –∑–∞–≤—Ç—Ä–∞ —Å—Ç–∞–Ω—É—Ç –æ–±—ã–¥–µ–Ω–Ω–æ—Å—Ç—å—é."
        };
        
        return insights[topic] || "\n\nüéØ **–ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å:** –≠—Ç–∞ —Ç–µ–º–∞ –∏–º–µ–µ—Ç –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.";
    }

    async generateSolutionSteps(userInput, topic) {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è
        let steps = "üìã **–ü–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è:**\n\n";
        
        const stepTemplates = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': [
                "1. –ê–Ω–∞–ª–∏–∑ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö",
                "2. –í—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞",
                "3. –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π",
                "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Å–ª–æ–≤–∏—é",
                "5. –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"
            ],
            '—Ñ–∏–∑–∏–∫–∞': [
                "1. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —è–≤–ª–µ–Ω–∏—è –∏–∑ —É—Å–ª–æ–≤–∏—è",
                "2. –ó–∞–ø–∏—Å—å –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≤–µ–ª–∏—á–∏–Ω",
                "3. –í—ã–±–æ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∑–∞–∫–æ–Ω–æ–≤",
                "4. –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–π –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ",
                "5. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Å–º—ã—Å–ª–∞"
            ],
            '–æ–±—â–µ–µ': [
                "1. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏",
                "2. –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –±–æ–ª–µ–µ –º–µ–ª–∫–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏",
                "3. –ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ —Ä–µ—à–µ–Ω–∏—é",
                "4. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤",
                "5. –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
            ]
        };
        
        const template = stepTemplates[topic] || stepTemplates['–æ–±—â–µ–µ'];
        steps += template.join('\n');
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–æ–¥–∞
        if (userInput.includes('—É—Ä–∞–≤–Ω–µ–Ω')) {
            steps += "\n\n–î–ª—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π: –∏–∑–æ–ª–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.";
        }
        
        if (userInput.includes('—Ä–∞—Å—á–µ—Ç') || userInput.includes('–ø–æ—Å—á–∏—Ç–∞–π')) {
            steps += "\n\n–ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–∞—Ö: —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è.";
        }
        
        return steps;
    }

    async generateDetailedExplanation(userInput, topic) {
        let explanation = "üîç **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:**\n\n";
        
        const explanations = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö. –ö–∞–∂–¥–∞—è —Ç–µ–æ—Ä–µ–º–∞ –∏ —Ñ–æ—Ä–º—É–ª–∞ –∏–º–µ–µ—Ç —Å—Ç—Ä–æ–≥–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –Ω–æ –∏ –≥–ª—É–±–æ–∫–æ–≥–æ –æ—Å–º—ã—Å–ª–µ–Ω–∏—è –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–æ–Ω—è—Ç–∏—è–º–∏.",
            '—Ñ–∏–∑–∏–∫–∞': "–§–∏–∑–∏–∫–∞ –æ–±—ä—è—Å–Ω—è–µ—Ç –º–∏—Ä —á–µ—Ä–µ–∑ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã. –≠—Ç–∏ –∑–∞–∫–æ–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ –∏ –∏–º–µ—é—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –ò–∑—É—á–µ–Ω–∏–µ —Ñ–∏–∑–∏–∫–∏ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–∏–¥–µ—Ç—å –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –≤ –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö —è–≤–ª–µ–Ω–∏—è—Ö.",
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á. –•–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –ø–∏—à–µ—Ç –∫–æ–¥, –Ω–æ –∏ –¥—É–º–∞–µ—Ç –æ –µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏.",
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –Ω–∞—É—á–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö. –ò—Ö —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–ª–µ–¥—É–µ—Ç –∑–∞–∫–æ–Ω—É –ú—É—Ä–∞ –∏ –¥—Ä—É–≥–∏–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º —Ç—Ä–µ–Ω–¥–∞–º. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –ø–æ–º–æ–≥–∞–µ—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –±—ã—Å—Ç—Ä–æ –º–µ–Ω—è—é—â–µ–º—É—Å—è –º–∏—Ä—É."
        };
        
        explanation += explanations[topic] || "–≠—Ç–∞ —Ç–µ–º–∞ –∏–º–µ–µ—Ç –≥–ª—É–±–æ–∫–∏–µ –∫–æ—Ä–Ω–∏ –∏ —à–∏—Ä–æ–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ–ª–µ–∑–Ω–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –µ–µ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω –∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö.";
        
        return explanation;
    }

    generateFollowUpQuestion(topic) {
        const questions = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': "\n\n‚ùì –•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –ø—Ä–∏–≤–µ–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª —Å–º–µ–∂–Ω—É—é —Ç–µ–º—É?",
            '—Ñ–∏–∑–∏–∫–∞': "\n\n‚ùì –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –ª–∏ –≤–∞—Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∑–∞–∫–æ–Ω–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏?",
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ': "\n\n‚ùì –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–º–æ—â—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —è–∑—ã–∫–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º?",
            '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': "\n\n‚ùì –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è—Ö –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏?",
            '–æ–±—â–µ–µ': "\n\n‚ùì –ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, —á—Ç–æ –≤–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤ —ç—Ç–æ–π —Ç–µ–º–µ?"
        };
        
        return questions[topic] || questions['–æ–±—â–µ–µ'];
    }

    addPersonalization(response, topic) {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (this.userProfile.interests.includes(topic)) {
            response = "–ü–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–∞ —Ç–µ–º–∞ –≤–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞, " + response.toLowerCase();
        }
        
        if (this.userProfile.knowledgeLevel === 'high') {
            response += "\n\nüéì **–î–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è:** –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã.";
        } else if (this.userProfile.knowledgeLevel === 'medium') {
            response += "\n\nüìñ **–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–∑—É—á–µ–Ω–∏—è:** –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.";
        }
        
        return response;
    }

    formatResponse(response, intent) {
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—è
        switch(intent) {
            case 'problem':
                return "üîß " + response;
            case 'explanation':
                return "üìö " + response;
            case 'question':
                return "‚ùì " + response;
            default:
                return "üí¨ " + response;
        }
    }
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
class ExternalAPIIntegration {
    constructor() {
        this.availableAPIs = {
            'openai': this.callOpenAI.bind(this),
            'local': this.callLocalAI.bind(this)
        };
    }

    async generateWithAPI(userInput, context, apiType = 'local') {
        try {
            const apiFunction = this.availableAPIs[apiType];
            if (apiFunction) {
                return await apiFunction(userInput, context);
            } else {
                throw new Error(`API type ${apiType} not supported`);
            }
        } catch (error) {
            console.warn(`API ${apiType} failed:`, error);
            // Fallback to local generation
            return await this.availableAPIs['local'](userInput, context);
        }
    }

    async callOpenAI(userInput, context) {
        const apiKey = localStorage.getItem('shamanai_api_key');
        if (!apiKey) {
            throw new Error('OpenAI API key not found');
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è OpenAI
        const messages = [
            {
                role: "system",
                content: "–¢—ã - shamanAI, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º."
            }
        ];

        // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context.forEach(msg => {
            messages.push({
                role: msg.role,
                content: msg.content
            });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messages.push({
            role: "user",
            content: userInput
        });

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: messages,
                    max_tokens: 1000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        } catch (error) {
            console.error('OpenAI API error:', error);
            throw error;
        }
    }

    async callLocalAI(userInput, context) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–∫ fallback
        const textGenerator = new AdvancedTextGenerator();
        return await textGenerator.generateIntelligentResponse(userInput, context);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ ShamanAI —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
class EnhancedShamanAI {
    constructor() {
        this.textGenerator = new AdvancedTextGenerator();
        this.apiIntegration = new ExternalAPIIntegration();
        this.conversationContext = [];
        this.settings = {
            useExternalAPI: false,
            apiType: 'local'
        };
        this.loadSettings();
    }

    loadSettings() {
        const savedApiKey = localStorage.getItem('shamanai_api_key');
        const savedModel = localStorage.getItem('shamanai_model');
        
        this.settings.useExternalAPI = !!(savedApiKey && savedApiKey.length > 10);
        this.settings.apiType = savedModel || 'local';
    }

    async generateResponse(userInput) {
        this.loadSettings(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è
        
        try {
            let response;
            
            if (this.settings.useExternalAPI && this.settings.apiType !== 'local') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π API
                response = await this.apiIntegration.generateWithAPI(
                    userInput, 
                    this.conversationContext, 
                    this.settings.apiType
                );
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                response = await this.textGenerator.generateIntelligentResponse(
                    userInput, 
                    this.conversationContext
                );
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            this.updateConversationContext(userInput, response);
            
            return response;
            
        } catch (error) {
            console.error('Error generating response:', error);
            // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            return await this.textGenerator.generateIntelligentResponse(userInput, this.conversationContext);
        }
    }

    updateConversationContext(userInput, aiResponse) {
        this.conversationContext.push(
            { role: 'user', content: userInput },
            { role: 'assistant', content: aiResponse }
        );
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (this.conversationContext.length > 20) {
            this.conversationContext = this.conversationContext.slice(-20);
        }
    }

    clearContext() {
        this.conversationContext = [];
    }

    getContextSummary() {
        if (this.conversationContext.length === 0) {
            return "–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã –ø—É—Å—Ç";
        }
        
        const topics = this.conversationContext
            .filter(msg => msg.role === 'user')
            .map(msg => this.textGenerator.analyzeTopic(msg.content));
        
        const mainTopic = this.textGenerator.getMostFrequentTopic(topics);
        
        return `–¢–µ–∫—É—â–∞—è –±–µ—Å–µ–¥–∞: ${mainTopic} (—Å–æ–æ–±—â–µ–Ω–∏–π: ${this.conversationContext.length / 2})`;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
let enhancedShamanAI;

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
function initializeEnhancedAI() {
    enhancedShamanAI = new EnhancedShamanAI();
    console.log("Enhanced ShamanAI initialized");
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendEnhancedMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessageToChat(message, 'user');
    input.value = '';
    
    showTypingIndicator();
    
    try {
        const response = await enhancedShamanAI.generateResponse(message);
        hideTypingIndicator();
        addMessageToChat(response, 'ai');
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
        document.getElementById('mathOutput').innerHTML = response.replace(/\n/g, '<br>');
        
    } catch (error) {
        hideTypingIndicator();
        addMessageToChat("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", "ai");
        console.error("Error:", error);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    initializeEnhancedAI();
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    window.sendMessage = sendEnhancedMessage;
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–º–∞–Ω–¥
function addEnhancedQuickActions() {
    const toolsPanel = document.querySelector('.tools-panel');
    
    const enhancedSection = document.createElement('div');
    enhancedSection.className = 'tool-section';
    enhancedSection.innerHTML = `
        <h3 class="tool-title">üß† –£–ú–ù–´–ï –ö–û–ú–ê–ù–î–´</h3>
        <button class="button" onclick="enhancedQuickAction('explain_ai')" style="width: 100%; margin-bottom: 10px;">–û–±—ä—è—Å–Ω–∏—Ç—å –ò–ò</button>
        <button class="button" onclick="enhancedQuickAction('generate_story')" style="width: 100%; margin-bottom: 10px;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button class="button" onclick="enhancedQuickAction('tech_news')" style="width: 100%; margin-bottom: 10px;">–ù–æ–≤–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</button>
        <button class="button" onclick="enhancedQuickAction('context_info')" style="width: 100%; background: linear-gradient(45deg, #00CED1, #20B2AA);">–ò–Ω—Ñ–æ –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ</button>
    `;
    
    toolsPanel.appendChild(enhancedSection);
}

function enhancedQuickAction(action) {
    const actions = {
        'explain_ai': "–û–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏",
        'generate_story': "–ü—Ä–∏–¥—É–º–∞–π –∫–æ—Ä–æ—Ç–∫—É—é –Ω–∞—É—á–Ω–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫—É—é –∏—Å—Ç–æ—Ä–∏—é –æ –±—É–¥—É—â–µ–º —Å –ò–ò",
        'tech_news': "–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö –≤ –º–∏—Ä–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞",
        'context_info': "context_info"
    };
    
    if (action === 'context_info') {
        const contextInfo = enhancedShamanAI.getContextSummary();
        addMessageToChat(`üìä **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ—Å–µ–¥–µ:**\n${contextInfo}`, "ai");
    } else {
        document.getElementById('chatInput').value = actions[action];
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–µ –±—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', addEnhancedQuickActions);
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
.enhanced-message {
    border-left: 4px solid var(--matrix);
    padding-left: 15px;
    margin: 10px 0;
}

.context-info {
    background: rgba(0, 206, 209, 0.1);
    border: 1px solid var(--secondary);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    font-size: 0.9em;
}

.api-status {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    margin-left: 10px;
}

.api-active {
    background: rgba(0, 255, 65, 0.2);
    color: var(--matrix);
    border: 1px solid var(--matrix);
}

.api-inactive {
    background: rgba(255, 68, 68, 0.2);
    color: #ff4444;
    border: 1px solid #ff4444;
}

.thinking-animation {
    display: inline-block;
    margin-left: 10px;
}

.thinking-animation::after {
    content: '‚†ã';
    animation: thinking 1.5s infinite;
}

@keyframes thinking {
    0% { content: '‚†ã'; }
    10% { content: '‚†ô'; }
    20% { content: '‚†π'; }
    30% { content: '‚†∏'; }
    40% { content: '‚†º'; }
    50% { content: '‚†¥'; }
    60% { content: '‚†¶'; }
    70% { content: '‚†ß'; }
    80% { content: '‚†á'; }
    90% { content: '‚†è'; }
    100% { content: '‚†ã'; }
}

.quality-badge {
    display: inline-block;
    background: linear-gradient(45deg, var(--primary), var(--accent));
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7em;
    margin-left: 10px;
    vertical-align: middle;
}
</style>
<script>
// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
class AdvancedImageAnalysis {
    constructor() {
        this.ocrWorker = null;
        this.isOCRReady = false;
        this.initOCR();
    }

    async initOCR() {
        try {
            this.ocrWorker = await Tesseract.createWorker('rus+eng', 1, {
                logger: m => console.log(m)
            });
            await this.ocrWorker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø .,!?+-=(){}[]/\\^√ó√∑œÄŒ∏Œ±Œ≤Œ≥Œ¥ŒîœÉœÜœâ‚àû‚à´‚àë‚àè‚àö‚àõ‚â§‚â•‚â†‚âà~',
                tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
            });
            this.isOCRReady = true;
            console.log("ShamanAI: OCR —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞");
        } catch (error) {
            console.error("ShamanAI: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OCR", error);
        }
    }

    async analyzeImage(imageData, analysisType = 'full') {
        if (!this.isOCRReady) {
            throw new Error("OCR —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞");
        }

        let analysisResult = {
            text: '',
            formulas: [],
            diagrams: [],
            objects: [],
            imageType: 'unknown',
            confidence: 0,
            extractedData: {}
        };

        try {
            // –ë–∞–∑–æ–≤—ã–π OCR –∞–Ω–∞–ª–∏–∑
            const ocrResult = await this.performOCR(imageData);
            analysisResult.text = ocrResult.text;
            analysisResult.confidence = ocrResult.confidence;

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            analysisResult.imageType = await this.determineImageType(imageData, ocrResult.text);

            // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            switch (analysisResult.imageType) {
                case 'handwritten_math':
                    analysisResult.extractedData = await this.analyzeHandwrittenMath(ocrResult.text, imageData);
                    break;
                case 'printed_math':
                    analysisResult.extractedData = await this.analyzePrintedMath(ocrResult.text);
                    break;
                case 'physics_diagram':
                    analysisResult.extractedData = await this.analyzePhysicsDiagram(imageData, ocrResult.text);
                    break;
                case 'graph_chart':
                    analysisResult.extractedData = await this.analyzeGraphChart(imageData);
                    break;
                case 'screenshot':
                    analysisResult.extractedData = await this.analyzeScreenshot(ocrResult.text);
                    break;
                default:
                    analysisResult.extractedData = await this.analyzeGeneralImage(ocrResult.text);
            }

            // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª
            analysisResult.formulas = this.extractMathematicalFormulas(ocrResult.text);

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", error);
            throw error;
        }

        return analysisResult;
    }

    async performOCR(imageData) {
        try {
            const { data } = await this.ocrWorker.recognize(imageData);
            return {
                text: data.text,
                confidence: data.confidence,
                lines: data.lines,
                words: data.words
            };
        } catch (error) {
            throw new Error(`OCR –æ—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    async determineImageType(imageData, extractedText) {
        const text = extractedText.toLowerCase();
        
        // –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (this.containsHandwrittenFeatures(text)) {
            return 'handwritten_math';
        }
        
        if (this.containsMathFormulas(text)) {
            return 'printed_math';
        }
        
        if (this.containsPhysicsKeywords(text)) {
            return 'physics_diagram';
        }
        
        if (this.containsGraphIndicators(text)) {
            return 'graph_chart';
        }
        
        if (this.containsHomeworkKeywords(text)) {
            return 'screenshot';
        }
        
        return 'general';
    }

    containsHandwrittenFeatures(text) {
        // –ü—Ä–æ—Å—Ç—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        const lines = text.split('\n');
        return lines.length <= 5 && text.length < 200;
    }

    containsMathFormulas(text) {
        const mathPatterns = [
            /[a-zA-Z]\s*=\s*[^,\n]+/,
            /[0-9]+\s*[+\-*\/^]\s*[0-9]+/,
            /sqrt\([^)]+\)/,
            /‚à´[^,\n]+d[a-zA-Z]/,
            /‚àë[^,\n]+/,
            /lim_[^,\n]+/
        ];
        return mathPatterns.some(pattern => pattern.test(text));
    }

    containsPhysicsKeywords(text) {
        const physicsWords = ['—Å–∏–ª–∞', '—ç–Ω–µ—Ä–≥–∏—è', '—Å–∫–æ—Ä–æ—Å—Ç—å', '—É—Å–∫–æ—Ä–µ–Ω–∏–µ', '–∑–∞–∫–æ–Ω', '—Ñ–æ—Ä–º—É–ª–∞', '—Ñ–∏–∑–∏–∫–∞'];
        return physicsWords.some(word => text.includes(word));
    }

    containsGraphIndicators(text) {
        const graphWords = ['–≥—Ä–∞—Ñ–∏–∫', 'chart', 'plot', '–æ—Å—å', '–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç', '—Ñ—É–Ω–∫—Ü–∏—è'];
        return graphWords.some(word => text.includes(word));
    }

    containsHomeworkKeywords(text) {
        const homeworkWords = ['–¥–∑', '–¥–æ–º–∞—à–Ω–µ–µ', '–∑–∞–¥–∞–Ω–∏–µ', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', '–∑–∞–¥–∞—á–∞', '–Ω–æ–º–µ—Ä', '—Å—Ç—Ä–∞–Ω–∏—Ü–∞'];
        return homeworkWords.some(word => text.includes(word));
    }

    async analyzeHandwrittenMath(text, imageData) {
        const analysis = {
            type: 'handwritten_mathematics',
            equations: [],
            steps: [],
            variables: [],
            solutions: []
        };

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–π –∏–∑ —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        analysis.equations = this.extractEquationsFromText(text);
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        analysis.variables = this.extractVariables(text);
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞–≥–æ–≤ —Ä–µ—à–µ–Ω–∏—è
        if (analysis.equations.length > 0) {
            analysis.steps = await this.generateSolutionSteps(analysis.equations[0]);
        }

        return analysis;
    }

    async analyzePrintedMath(text) {
        const analysis = {
            type: 'printed_mathematics',
            expressions: [],
            complexity: 'medium',
            topics: []
        };

        analysis.expressions = this.extractMathematicalExpressions(text);
        analysis.complexity = this.assessComplexity(text);
        analysis.topics = this.identifyMathTopics(text);

        return analysis;
    }

    async analyzePhysicsDiagram(imageData, text) {
        return {
            type: 'physics_diagram',
            components: this.identifyPhysicsComponents(text),
            laws: this.identifyPhysicsLaws(text),
            calculations: this.extractPhysicsCalculations(text)
        };
    }

    async analyzeGraphChart(imageData) {
        return {
            type: 'graph_chart',
            dataPoints: this.extractDataPoints(text),
            trend: this.analyzeTrend(text),
            functionType: this.identifyFunctionType(text)
        };
    }

    async analyzeScreenshot(text) {
        return {
            type: 'screenshot',
            homeworkInfo: this.extractHomeworkInfo(text),
            subject: this.identifySubject(text),
            gradeLevel: this.extractGradeLevel(text)
        };
    }

    async analyzeGeneralImage(text) {
        return {
            type: 'general',
            keyPhrases: this.extractKeyPhrases(text),
            sentiment: this.analyzeSentiment(text),
            language: this.detectLanguage(text)
        };
    }

    extractMathematicalFormulas(text) {
        const formulaPatterns = [
            /[a-zA-ZŒ±-œâŒë-Œ©]_{?[0-9a-zA-Z]+}?\s*=\s*[^,\n]+/g,
            /[0-9]+\s*[+\-*\/^]\s*[0-9]+/g,
            /sqrt\([^)]+\)/g,
            /‚à´[^,\n]+d[a-zA-Z]/g,
            /‚àë[^,\n]+/g,
            /lim_[^,\n]+/g,
            /[a-zA-Z]'\(?[xyt]\)?/g,
            /[0-9]+\s*\/\s*[0-9]+/g,
            /[a-zA-Z]+\^[0-9]+/g
        ];

        const formulas = [];
        formulaPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                formulas.push(...matches);
            }
        });

        return [...new Set(formulas)]; // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    }

    extractEquationsFromText(text) {
        const equationPatterns = [
            /[a-zA-Z]+\s*=\s*[^,\n]+/g,
            /[0-9]+\s*[+\-*\/]\s*[0-9]+\s*=\s*[0-9]+/g,
            /[a-zA-Z]+\s*[+\-*\/]\s*[a-zA-Z]+\s*=\s*[0-9]+/g
        ];

        const equations = [];
        equationPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                equations.push(...matches);
            }
        });

        return equations;
    }

    extractVariables(text) {
        const variablePattern = /[a-zA-ZŒ±-œâŒë-Œ©]/g;
        const matches = text.match(variablePattern);
        return matches ? [...new Set(matches)] : [];
    }

    async generateSolutionSteps(equation) {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞–≥–æ–≤ —Ä–µ—à–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        const steps = [];
        
        steps.push("1. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ");
        steps.push(`2. –£—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${equation}`);
        
        if (equation.includes('=')) {
            steps.push("3. –£–ø—Ä–æ—â–∞–µ–º –æ–±–µ —á–∞—Å—Ç–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è");
            steps.push("4. –ò–∑–æ–ª–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é");
            steps.push("5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—à–µ–Ω–∏–µ");
        }
        
        return steps;
    }

    extractMathematicalExpressions(text) {
        const patterns = [
            /[0-9]+\s*[+\-*\/^]\s*[0-9]+/g,
            /[a-zA-Z]+\s*[+\-*\/^]\s*[a-zA-Z]+/g,
            /\([^)]+\)/g
        ];

        const expressions = [];
        patterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                expressions.push(...matches);
            }
        });

        return expressions;
    }

    assessComplexity(text) {
        const complexPatterns = [
            /‚à´/g, /‚àë/g, /lim/g, /‚àÇ/g, /‚àá/g,
            /matrix/g, /vector/g, /tensor/g
        ];

        const complexityScore = complexPatterns.reduce((score, pattern) => {
            return score + (text.match(pattern) || []).length;
        }, 0);

        if (complexityScore > 3) return 'high';
        if (complexityScore > 1) return 'medium';
        return 'low';
    }

    identifyMathTopics(text) {
        const topics = {
            '–∞–ª–≥–µ–±—Ä–∞': ['—É—Ä–∞–≤–Ω–µ–Ω–∏–µ', '–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è', '—Ñ–æ—Ä–º—É–ª–∞', '–≤—ã—Ä–∞–∂–µ–Ω–∏–µ'],
            '–≥–µ–æ–º–µ—Ç—Ä–∏—è': ['—É–≥–æ–ª', '—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', '–æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å', '–ø–ª–æ—â–∞–¥—å', '–æ–±—ä–µ–º'],
            '–∞–Ω–∞–ª–∏–∑': ['–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è', '–∏–Ω—Ç–µ–≥—Ä–∞–ª', '–ø—Ä–µ–¥–µ–ª', '—Ñ—É–Ω–∫—Ü–∏—è'],
            '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞': ['–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å', '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', '—Å—Ä–µ–¥–Ω–µ–µ', '–¥–∏—Å–ø–µ—Ä—Å–∏—è']
        };

        const foundTopics = [];
        for (const [topic, keywords] of Object.entries(topics)) {
            if (keywords.some(keyword => text.includes(keyword))) {
                foundTopics.push(topic);
            }
        }

        return foundTopics.length > 0 ? foundTopics : ['–æ–±—â–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'];
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∞–Ω–∞–ª–∏–∑–∞...
    identifyPhysicsComponents(text) {
        const components = [];
        const physicsElements = ['—Å–∏–ª–∞', '–º–∞—Å—Å–∞', '—Å–∫–æ—Ä–æ—Å—Ç—å', '—É—Å–∫–æ—Ä–µ–Ω–∏–µ', '—ç–Ω–µ—Ä–≥–∏—è', '–º–æ—â–Ω–æ—Å—Ç—å'];
        
        physicsElements.forEach(element => {
            if (text.includes(element)) {
                components.push(element);
            }
        });

        return components;
    }

    identifyPhysicsLaws(text) {
        const laws = [];
        const physicsLaws = [
            { law: '–ù—å—é—Ç–æ–Ω–∞', keywords: ['–Ω—å—é—Ç–æ–Ω', '—Å–∏–ª–∞', '—É—Å–∫–æ—Ä–µ–Ω–∏–µ'] },
            { law: '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏', keywords: ['—ç–Ω–µ—Ä–≥–∏—è', '—Å–æ—Ö—Ä–∞–Ω–µ–Ω'] },
            { law: '–û–º–∞', keywords: ['–æ–º', '—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ', '–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ'] },
            { law: '–ö—É–ª–æ–Ω–∞', keywords: ['–∫—É–ª–æ–Ω', '–∑–∞—Ä—è–¥', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ'] }
        ];

        physicsLaws.forEach(physicsLaw => {
            if (physicsLaw.keywords.some(keyword => text.includes(keyword))) {
                laws.push(physicsLaw.law);
            }
        });

        return laws;
    }

    extractPhysicsCalculations(text) {
        const calculations = [];
        const calculationPatterns = [
            /[0-9]+\s*[–º–∫–≥]?[–º]?[—Å]?\s*[=\->]\s*[0-9]+/g,
            /[Ff]\s*=\s*[0-9]+/g,
            /[Vv]\s*=\s*[0-9]+/g,
            /[Aa]\s*=\s*[0-9]+/g
        ];

        calculationPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                calculations.push(...matches);
            }
        });

        return calculations;
    }

    extractHomeworkInfo(text) {
        const info = {
            subject: this.identifySubject(text),
            grade: this.extractGradeLevel(text),
            tasks: this.extractTasks(text),
            deadline: this.extractDeadline(text)
        };

        return info;
    }

    identifySubject(text) {
        const subjects = {
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': ['–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–∞–ª–≥–µ–±—Ä–∞', '–≥–µ–æ–º–µ—Ç—Ä–∏—è', '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ'],
            '—Ñ–∏–∑–∏–∫–∞': ['—Ñ–∏–∑–∏–∫–∞', '—Å–∏–ª–∞', '—ç–Ω–µ—Ä–≥–∏—è', '–∑–∞–∫–æ–Ω'],
            '—Ö–∏–º–∏—è': ['—Ö–∏–º–∏—è', '–º–æ–ª–µ–∫—É–ª–∞', '–∞—Ç–æ–º', '—Ä–µ–∞–∫—Ü–∏—è'],
            '–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': ['–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', '–∞–ª–≥–æ—Ä–∏—Ç–º']
        };

        for (const [subject, keywords] of Object.entries(subjects)) {
            if (keywords.some(keyword => text.includes(keyword))) {
                return subject;
            }
        }

        return '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }

    extractGradeLevel(text) {
        const gradeMatch = text.match(/(\d+)\s*(?:–∫–ª–∞—Å—Å|class)/i);
        return gradeMatch ? gradeMatch[1] : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
    }

    extractTasks(text) {
        const taskPatterns = [
            /‚Ññ\s*\d+/g,
            /–∑–∞–¥–∞—á–∞\s*\d+/gi,
            /—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ\s*\d+/gi,
            /¬ß\s*\d+/g
        ];

        const tasks = [];
        taskPatterns.forEach(pattern => {
            const matches = text.match(pattern);
            if (matches) {
                tasks.push(...matches);
            }
        });

        return tasks.length > 0 ? tasks : ['–∑–∞–¥–∞—á–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã'];
    }

    extractDeadline(text) {
        const datePattern = /(\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4})/g;
        const matches = text.match(datePattern);
        return matches ? matches[0] : '–Ω–µ —É–∫–∞–∑–∞–Ω';
    }

    extractKeyPhrases(text) {
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑
        const words = text.toLowerCase().split(/\s+/);
        const stopWords = ['–∏', '–≤', '–Ω–∞', '—Å', '–ø–æ', '–¥–ª—è', '—ç—Ç–æ', '—á—Ç–æ', '–∫–∞–∫'];
        const meaningfulWords = words.filter(word => 
            word.length > 3 && !stopWords.includes(word)
        );
        
        return meaningfulWords.slice(0, 10);
    }

    analyzeSentiment(text) {
        const positiveWords = ['—Ö–æ—Ä–æ—à–æ', '–æ—Ç–ª–∏—á–Ω–æ', '–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ', '—É—Å–ø–µ—Ö', '–ø—Ä–∞–≤–∏–ª—å–Ω–æ'];
        const negativeWords = ['–ø–ª–æ—Ö–æ', '–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', '–æ—à–∏–±–∫–∞', '—Å–ª–æ–∂–Ω–æ', '—Ç—Ä—É–¥–Ω–æ'];
        
        let score = 0;
        const words = text.toLowerCase().split(/\s+/);
        
        words.forEach(word => {
            if (positiveWords.includes(word)) score++;
            if (negativeWords.includes(word)) score--;
        });
        
        if (score > 0) return '–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π';
        if (score < 0) return '–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π';
        return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
    }

    detectLanguage(text) {
        const cyrillicPattern = /[–∞-—è–ê-–Ø]/g;
        const latinPattern = /[a-zA-Z]/g;
        
        const cyrillicCount = (text.match(cyrillicPattern) || []).length;
        const latinCount = (text.match(latinPattern) || []).length;
        
        if (cyrillicCount > latinCount) return '—Ä—É—Å—Å–∫–∏–π';
        if (latinCount > cyrillicCount) return '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π';
        return '—Å–º–µ—à–∞–Ω–Ω—ã–π';
    }
}

// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—à–∞—Ç–µ–ª—å
class AdvancedMathSolver {
    constructor() {
        this.supportedOperations = {
            arithmetic: ['+', '-', '*', '/', '^'],
            functions: ['sin', 'cos', 'tan', 'log', 'ln', 'sqrt', 'exp'],
            calculus: ['derivative', 'integral', 'limit']
        };
    }

    async solveProblem(problem, problemType = 'auto') {
        if (problemType === 'auto') {
            problemType = this.detectProblemType(problem);
        }

        let solution;

        try {
            switch (problemType) {
                case 'algebraic':
                    solution = await this.solveAlgebraic(problem);
                    break;
                case 'calculus':
                    solution = await this.solveCalculus(problem);
                    break;
                case 'geometric':
                    solution = await this.solveGeometric(problem);
                    break;
                case 'statistical':
                    solution = await this.solveStatistical(problem);
                    break;
                default:
                    solution = await this.solveGeneral(problem);
            }

            return {
                type: problemType,
                problem: problem,
                solution: solution,
                steps: solution.steps || [],
                answer: solution.answer,
                verification: await this.verifySolution(problem, solution.answer)
            };

        } catch (error) {
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É: ${error.message}`);
        }
    }

    detectProblemType(problem) {
        const problemLower = problem.toLowerCase();

        if (problemLower.includes('–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è') || problemLower.includes('derivative')) {
            return 'calculus';
        }
        if (problemLower.includes('–∏–Ω—Ç–µ–≥—Ä–∞–ª') || problemLower.includes('integral')) {
            return 'calculus';
        }
        if (problemLower.includes('—É—Ä–∞–≤–Ω–µ–Ω–∏–µ') || problemLower.includes('equation')) {
            return 'algebraic';
        }
        if (problemLower.includes('–ø–ª–æ—â–∞–¥—å') || problemLower.includes('volume') || problemLower.includes('–≥–µ–æ–º–µ—Ç—Ä')) {
            return 'geometric';
        }
        if (problemLower.includes('–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å') || problemLower.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫')) {
            return 'statistical';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–∏–º–≤–æ–ª–∞–º
        if (problem.includes('=') && problem.includes('x')) {
            return 'algebraic';
        }
        if (problem.includes('‚à´') || problem.includes('d/dx')) {
            return 'calculus';
        }

        return 'general';
    }

    async solveAlgebraic(problem) {
        const steps = [];
        let solution = '';

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        const equation = this.extractEquation(problem);
        steps.push(`1. –ò–∑–≤–ª–µ—á–µ–Ω–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${equation}`);

        // –£–ø—Ä–æ—â–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        const simplified = this.simplifyEquation(equation);
        steps.push(`2. –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${simplified}`);

        // –†–µ—à–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        if (this.isLinearEquation(simplified)) {
            solution = this.solveLinearEquation(simplified);
            steps.push(`3. –†–µ—à–µ–Ω–∏–µ –ª–∏–Ω–µ–π–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è: ${solution}`);
        } else if (this.isQuadraticEquation(simplified)) {
            solution = this.solveQuadraticEquation(simplified);
            steps.push(`3. –†–µ—à–µ–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è: ${solution}`);
        } else {
            solution = this.solveGeneralEquation(simplified);
            steps.push(`3. –†–µ—à–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è –æ–±—â–µ–≥–æ –≤–∏–¥–∞: ${solution}`);
        }

        return {
            steps: steps,
            answer: solution,
            equation: equation,
            simplified: simplified
        };
    }

    async solveCalculus(problem) {
        const steps = [];
        
        if (problem.includes('–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è') || problem.includes('derivative')) {
            const functionMatch = problem.match(/(?:–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è|derivative)\s+of\s+([^,\n]+)/i) ||
                                 problem.match(/d\/dx\s*\(([^)]+)\)/);
            
            if (functionMatch) {
                const func = functionMatch[1];
                steps.push(`1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è: ${func}`);
                
                const derivative = this.calculateDerivative(func);
                steps.push(`2. –ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è: ${derivative}`);
                
                return {
                    steps: steps,
                    answer: derivative,
                    type: 'derivative'
                };
            }
        }

        if (problem.includes('–∏–Ω—Ç–µ–≥—Ä–∞–ª') || problem.includes('integral')) {
            const integralMatch = problem.match(/(?:–∏–Ω—Ç–µ–≥—Ä–∞–ª|integral)\s+of\s+([^,\n]+)/i) ||
                                 problem.match(/‚à´\s*([^,\n]+)\s*d[xyt]/);
            
            if (integralMatch) {
                const func = integralMatch[1];
                steps.push(`1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è: ${func}`);
                
                const integral = this.calculateIntegral(func);
                steps.push(`2. –ò–Ω—Ç–µ–≥—Ä–∞–ª: ${integral}`);
                
                return {
                    steps: steps,
                    answer: integral,
                    type: 'integral'
                };
            }
        }

        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á–∏ –º–∞—Ç–∞–Ω–∞–ª–∏–∑–∞");
    }

    async solveGeometric(problem) {
        const steps = [];
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π —Ñ–∏–≥—É—Ä—ã
        const shape = this.detectGeometricShape(problem);
        steps.push(`1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ñ–∏–≥—É—Ä–∞: ${shape}`);
        
        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const parameters = this.extractGeometricParameters(problem, shape);
        steps.push(`2. –ò–∑–≤–ª–µ—á–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(parameters)}`);
        
        // –†–∞—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        const result = this.calculateGeometricProperty(shape, parameters);
        steps.push(`3. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`);
        
        return {
            steps: steps,
            answer: result,
            shape: shape,
            parameters: parameters
        };
    }

    async solveStatistical(problem) {
        // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
        const numbers = this.extractNumbers(problem);
        
        if (problem.includes('—Å—Ä–µ–¥–Ω–µ–µ') || problem.includes('mean')) {
            const mean = numbers.reduce((a, b) => a + b, 0) / numbers.length;
            return {
                steps: [
                    `1. –ù–∞–π–¥–µ–Ω—ã —á–∏—Å–ª–∞: ${numbers.join(', ')}`,
                    `2. –°—É–º–º–∞: ${numbers.reduce((a, b) => a + b, 0)}`,
                    `3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∏—Å–µ–ª: ${numbers.length}`,
                    `4. –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${mean}`
                ],
                answer: mean,
                type: 'mean'
            };
        }
        
        throw new Error("–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
    }

    async solveGeneral(problem) {
        // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –∫–∞–∫ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
        try {
            const result = this.evaluateExpression(problem);
            return {
                steps: [
                    `1. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è: ${problem}`,
                    `2. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`
                ],
                answer: result,
                type: 'arithmetic'
            };
        } catch (error) {
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏");
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã
    extractEquation(problem) {
        const equationMatch = problem.match(/([^=]+=[^=]+)/);
        return equationMatch ? equationMatch[1] : problem;
    }

    simplifyEquation(equation) {
        // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–æ—â–µ–Ω–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π
        return equation.replace(/\s+/g, '');
    }

    isLinearEquation(equation) {
        return equation.includes('x') && !equation.includes('x^2');
    }

    isQuadraticEquation(equation) {
        return equation.includes('x^2');
    }

    solveLinearEquation(equation) {
        // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ—à–∞—Ç–µ–ª—å –ª–∏–Ω–µ–π–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π
        const sides = equation.split('=');
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–µ—à–µ–Ω–∏—è
        return "x = ..."; // –ó–∞–≥–ª—É—à–∫–∞
    }

    solveQuadraticEquation(equation) {
        // –†–µ—à–µ–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        return "x‚ÇÅ, x‚ÇÇ = ..."; // –ó–∞–≥–ª—É—à–∫–∞
    }

    solveGeneralEquation(equation) {
        return "–†–µ—à–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è"; // –ó–∞–≥–ª—É—à–∫–∞
    }

    calculateDerivative(func) {
        // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è
        return `d/dx(${func}) = ...`; // –ó–∞–≥–ª—É—à–∫–∞
    }

    calculateIntegral(func) {
        // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
        return `‚à´${func}dx = ...`; // –ó–∞–≥–ª—É—à–∫–∞
    }

    detectGeometricShape(problem) {
        const shapes = {
            '–∫—Ä—É–≥': ['–∫—Ä—É–≥', '–æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å', '—Ä–∞–¥–∏—É—Å', '–¥–∏–∞–º–µ—Ç—Ä'],
            '–∫–≤–∞–¥—Ä–∞—Ç': ['–∫–≤–∞–¥—Ä–∞—Ç', '—Å—Ç–æ—Ä–æ–Ω–∞'],
            '—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫': ['—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', '—É–≥–æ–ª'],
            '–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫': ['–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫']
        };

        for (const [shape, keywords] of Object.entries(shapes)) {
            if (keywords.some(keyword => problem.toLowerCase().includes(keyword))) {
                return shape;
            }
        }

        return '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }

    extractGeometricParameters(problem, shape) {
        const parameters = {};
        const numberMatches = problem.match(/\d+(\.\d+)?/g);
        
        if (numberMatches) {
            if (shape === '–∫—Ä—É–≥') {
                parameters.radius = parseFloat(numberMatches[0]);
            } else if (shape === '–∫–≤–∞–¥—Ä–∞—Ç') {
                parameters.side = parseFloat(numberMatches[0]);
            }
        }
        
        return parameters;
    }

    calculateGeometricProperty(shape, parameters) {
        if (shape === '–∫—Ä—É–≥' && parameters.radius) {
            const area = Math.PI * parameters.radius * parameters.radius;
            return `–ü–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞: ${area.toFixed(2)}`;
        }
        
        return "–†–∞—Å—á–µ—Ç –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω";
    }

    extractNumbers(text) {
        const matches = text.match(/\d+(\.\d+)?/g);
        return matches ? matches.map(Number) : [];
    }

    evaluateExpression(expression) {
        try {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–π
            const sanitized = expression.replace(/[^0-9+\-*/().]/g, '');
            return eval(sanitized);
        } catch (error) {
            throw new Error("–ù–µ–≤–µ—Ä–Ω–æ–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ");
        }
    }

    async verifySolution(problem, solution) {
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è
        return {
            isCorrect: true,
            confidence: 0.8,
            method: '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞'
        };
    }
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å ShamanAI
class CompleteShamanAI {
    constructor() {
        this.textGenerator = new AdvancedTextGenerator();
        this.imageAnalyzer = new AdvancedImageAnalysis();
        this.mathSolver = new AdvancedMathSolver();
        this.apiIntegration = new ExternalAPIIntegration();
        this.conversationContext = [];
        
        this.systemStatus = {
            textGeneration: 'ready',
            imageAnalysis: 'initializing',
            mathSolving: 'ready',
            apiIntegration: 'ready'
        };
    }

    async processUserInput(userInput, imageData = null) {
        let response;
        
        if (imageData) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            response = await this.processImageInput(imageData, userInput);
        } else if (this.isMathProblem(userInput)) {
            // –†–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏
            response = await this.processMathProblem(userInput);
        } else {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            response = await this.processTextInput(userInput);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        this.updateConversationContext(userInput, response);
        
        return response;
    }

    async processImageInput(imageData, userContext = '') {
        try {
            const analysis = await this.imageAnalyzer.analyzeImage(imageData);
            
            let response = "üîç **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**\n\n";
            
            response += `üìä –¢–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${this.getImageTypeDescription(analysis.imageType)}\n\n`;
            
            if (analysis.text) {
                response += `üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n${analysis.text}\n\n`;
            }
            
            if (analysis.formulas.length > 0) {
                response += `üßÆ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–æ—Ä–º—É–ª—ã:\n`;
                analysis.formulas.forEach(formula => {
                    response += `‚Ä¢ ${formula}\n`;
                });
                response += `\n`;
            }
            
            if (analysis.extractedData) {
                response += this.formatExtractedData(analysis.extractedData);
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∏—Ö —Ä–µ—à–∏—Ç—å
            if (analysis.formulas.length > 0 && userContext.toLowerCase().includes('—Ä–µ—à–∏')) {
                const mathResponse = await this.solveDetectedFormulas(analysis.formulas);
                response += `\nüî¢ **–†–µ—à–µ–Ω–∏—è —Ñ–æ—Ä–º—É–ª:**\n${mathResponse}`;
            }
            
            return response;
            
        } catch (error) {
            return `‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error.message}`;
        }
    }

    async processMathProblem(problem) {
        try {
            const solution = await this.mathSolver.solveProblem(problem);
            
            let response = "üßÆ **–†–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏:**\n\n";
            response += `üìù –ó–∞–¥–∞—á–∞: ${solution.problem}\n\n`;
            response += `üìã –®–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è:\n`;
            
            solution.steps.forEach((step, index) => {
                response += `${step}\n`;
            });
            
            response += `\n‚úÖ –û—Ç–≤–µ—Ç: ${solution.answer}\n`;
            response += `üîç –ü—Ä–æ–≤–µ—Ä–∫–∞: ${solution.verification.method} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${solution.verification.confidence * 100}%)`;
            
            return response;
            
        } catch (error) {
            return `‚ùå –û—à–∏–±–∫–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ${error.message}`;
        }
    }

    async processTextInput(userInput) {
        return await this.textGenerator.generateIntelligentResponse(userInput, this.conversationContext);
    }

    isMathProblem(text) {
        const mathKeywords = ['—Ä–µ—à–∏', '–ø–æ—Å—á–∏—Ç–∞–π', '–≤—ã—á–∏—Å–ª–∏', '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ', '—Ñ–æ—Ä–º—É–ª–∞', '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è', '–∏–Ω—Ç–µ–≥—Ä–∞–ª'];
        return mathKeywords.some(keyword => text.toLowerCase().includes(keyword));
    }

    getImageTypeDescription(type) {
        const descriptions = {
            'handwritten_math': '–†—É–∫–æ–ø–∏—Å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞',
            'printed_math': '–ü–µ—á–∞—Ç–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞', 
            'physics_diagram': '–§–∏–∑–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ –∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º–∞',
            'graph_chart': '–ì—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º–∞',
            'screenshot': '–°–∫—Ä–∏–Ω—à–æ—Ç —Å –∑–∞–¥–∞–Ω–∏–µ–º',
            'general': '–û–±—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'
        };
        
        return descriptions[type] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
    }

    formatExtractedData(data) {
        let formatted = '';
        
        switch(data.type) {
            case 'handwritten_mathematics':
                formatted += `‚úçÔ∏è –†—É–∫–æ–ø–∏—Å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞:\n`;
                if (data.equations.length > 0) {
                    formatted += `–£—Ä–∞–≤–Ω–µ–Ω–∏—è: ${data.equations.join(', ')}\n`;
                }
                if (data.variables.length > 0) {
                    formatted += `–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${data.variables.join(', ')}\n`;
                }
                break;
                
            case 'physics_diagram':
                formatted += `‚ö° –§–∏–∑–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞:\n`;
                if (data.components.length > 0) {
                    formatted += `–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: ${data.components.join(', ')}\n`;
                }
                if (data.laws.length > 0) {
                    formatted += `–ó–∞–∫–æ–Ω—ã: ${data.laws.join(', ')}\n`;
                }
                break;
                
            case 'screenshot':
                formatted += `üì± –°–∫—Ä–∏–Ω—à–æ—Ç –∑–∞–¥–∞–Ω–∏—è:\n`;
                formatted += `–ü—Ä–µ–¥–º–µ—Ç: ${data.homeworkInfo.subject}\n`;
                formatted += `–ö–ª–∞—Å—Å: ${data.homeworkInfo.grade}\n`;
                formatted += `–ó–∞–¥–∞—á–∏: ${data.homeworkInfo.tasks.join(', ')}\n`;
                break;
        }
        
        return formatted;
    }

    async solveDetectedFormulas(formulas) {
        let solutions = '';
        
        for (const formula of formulas.slice(0, 3)) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            try {
                const solution = await this.mathSolver.solveProblem(formula);
                solutions += `‚Ä¢ ${formula} ‚Üí ${solution.answer}\n`;
            } catch (error) {
                solutions += `‚Ä¢ ${formula} ‚Üí –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å\n`;
            }
        }
        
        return solutions;
    }

    updateConversationContext(userInput, aiResponse) {
        this.conversationContext.push(
            { role: 'user', content: userInput },
            { role: 'assistant', content: aiResponse }
        );
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if (this.conversationContext.length > 20) {
            this.conversationContext = this.conversationContext.slice(-20);
        }
    }

    getSystemStatus() {
        return this.systemStatus;
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
let completeShamanAI;

function initializeCompleteAI() {
    completeShamanAI = new CompleteShamanAI();
    console.log("Complete ShamanAI System Initialized");
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
    setTimeout(() => {
        const status = completeShamanAI.getSystemStatus();
        addMessageToChat(`üîÑ <span class="matrix-text">–°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´</span><br>` +
                        `‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞: ‚úÖ<br>` +
                        `‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ‚úÖ<br>` +
                        `‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—à–∞—Ç–µ–ª—å: ‚úÖ<br>` +
                        `‚Ä¢ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: ‚úÖ`, "ai");
    }, 1000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
async function processCompleteInput() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message && !currentImage) return;
    
    if (message) {
        addMessageToChat(message, 'user');
        input.value = '';
        
        showTypingIndicator();
        
        try {
            const response = await completeShamanAI.processUserInput(message, currentImage);
            hideTypingIndicator();
            addMessageToChat(response, 'ai');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
            document.getElementById('mathOutput').innerHTML = response.replace(/\n/g, '<br>');
            
        } catch (error) {
            hideTypingIndicator();
            addMessageToChat("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", "ai");
            console.error("Error:", error);
        }
        
        currentImage = null;
        document.getElementById('previewCanvas').style.display = 'none';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    initializeCompleteAI();
    window.sendMessage = processCompleteInput;
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
function addAdvancedAnalysisTools() {
    const toolsPanel = document.querySelector('.tools-panel');
    
    const analysisSection = document.createElement('div');
    analysisSection.className = 'tool-section';
    analysisSection.innerHTML = `
        <h3 class="tool-title">üî¨ –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó</h3>
        <button class="button" onclick="advancedAnalysis('math_ocr')" style="width: 100%; margin-bottom: 10px;">OCR –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</button>
        <button class="button" onclick="advancedAnalysis('physics_diagram')" style="width: 100%; margin-bottom: 10px;">–ê–Ω–∞–ª–∏–∑ —Å—Ö–µ–º</button>
        <button class="button" onclick="advancedAnalysis('handwriting')" style="width: 100%; margin-bottom: 10px;">–†—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç</button>
        <button class="button" onclick="advancedAnalysis('system_status')" style="width: 100%; background: linear-gradient(45deg, #00CED1, #20B2AA);">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</button>
    `;
    
    toolsPanel.appendChild(analysisSection);
}

function advancedAnalysis(type) {
    const actions = {
        'math_ocr': "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∏ —Ä–µ—à–∏ –∏—Ö",
        'physics_diagram': "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å—Ö–µ–º—É –∏ –æ–±—ä—è—Å–Ω–∏ –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã",
        'handwriting': "–†–∞—Å–ø–æ–∑–Ω–∞–π —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ",
        'system_status': "system_status"
    };
    
    if (type === 'system_status') {
        const status = completeShamanAI.getSystemStatus();
        let statusMessage = "üìä **–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã ShamanAI:**\n\n";
        
        Object.entries(status).forEach(([system, stat]) => {
            const statusIcon = stat === 'ready' ? '‚úÖ' : 'üîÑ';
            statusMessage += `${statusIcon} ${system}: ${stat}\n`;
        });
        
        addMessageToChat(statusMessage, "ai");
    } else if (currentImage) {
        document.getElementById('chatInput').value = actions[type];
        processCompleteInput();
    } else {
        addMessageToChat("‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞", "ai");
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', addAdvancedAnalysisTools);
</script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ */
.analysis-result {
    background: rgba(0, 206, 209, 0.1);
    border: 1px solid var(--secondary);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--matrix);
}

.math-solution {
    background: rgba(138, 43, 226, 0.1);
    border: 1px solid var(--primary);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}

.step-by-step {
    background: rgba(255, 20, 147, 0.1);
    border: 1px solid var(--accent);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}

.step {
    margin: 8px 0;
    padding-left: 15px;
    border-left: 3px solid var(--secondary);
}

.system-status-panel {
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid var(--matrix);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
    padding: 5px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 10px;
}

.status-ready {
    background: var(--matrix);
    box-shadow: 0 0 10px var(--matrix);
}

.status-initializing {
    background: orange;
    box-shadow: 0 0 10px orange;
    animation: pulse 1s infinite;
}

.status-error {
    background: #ff4444;
    box-shadow: 0 0 10px #ff4444;
}

.analysis-progress {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    margin: 10px 0;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary), var(--matrix));
    border-radius: 2px;
    animation: progressAnimation 2s infinite;
}

@keyframes progressAnimation {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.formula-display {
    font-family: 'Courier New', monospace;
    background: rgba(0, 0, 0, 0.3);
    padding: 10px;
    border-radius: 5px;
    margin: 5px 0;
    border-left: 3px solid var(--primary);
}

.confidence-meter {
    display: flex;
    align-items: center;
    margin: 5px 0;
}

.confidence-bar {
    flex: 1;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    margin: 0 10px;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff4444, #ffa500, var(--matrix));
    border-radius: 3px;
}
</style>
<script>
// –ì–õ–ê–í–ù–´–ô –ö–õ–ê–°–° SHAMANAI - –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
class ShamanAIFinal {
    constructor() {
        this.systems = {
            text: new AdvancedTextGenerator(),
            image: new AdvancedImageAnalysis(),
            math: new AdvancedMathSolver(),
            api: new ExternalAPIIntegration(),
            memory: new MemorySystem(),
            graphics: new GraphicsRenderer()
        };
        
        this.conversationContext = [];
        this.userPreferences = {};
        this.systemStatus = 'initializing';
        this.isInitialized = false;
        
        this.init();
    }

    async init() {
        try {
            console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ShamanAI...");
            
            // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
            await Promise.all([
                this.systems.text.init?.(),
                this.systems.image.initOCR?.(),
                this.systems.memory.load?.(),
                this.loadUserPreferences()
            ]);
            
            this.systemStatus = 'ready';
            this.isInitialized = true;
            
            console.log("‚úÖ ShamanAI –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            this.logSystemStatus();
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ShamanAI:", error);
            this.systemStatus = 'error';
        }
    }

    async processMessage(userInput, imageData = null, options = {}) {
        if (!this.isInitialized) {
            return "üîÑ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...";
        }

        // –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        const requestType = this.analyzeRequestType(userInput, imageData);
        const context = this.prepareContext(userInput);
        
        let response;

        try {
            switch (requestType) {
                case 'image_analysis':
                    response = await this.processImageRequest(userInput, imageData, context);
                    break;
                    
                case 'math_problem':
                    response = await this.processMathRequest(userInput, context);
                    break;
                    
                case 'graph_request':
                    response = await this.processGraphRequest(userInput, context);
                    break;
                    
                case 'memory_query':
                    response = await this.processMemoryRequest(userInput, context);
                    break;
                    
                case 'api_request':
                    response = await this.processAPIRequest(userInput, context);
                    break;
                    
                default:
                    response = await this.processConversationalRequest(userInput, context);
            }

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
            await this.systems.memory.saveInteraction?.(userInput, response, requestType);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            this.updateConversationContext(userInput, response);
            
            return this.formatFinalResponse(response, requestType);

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:", error);
            return this.handleError(error, userInput, requestType);
        }
    }

    analyzeRequestType(userInput, imageData) {
        if (imageData) return 'image_analysis';
        
        const input = userInput.toLowerCase();
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        if (this.containsMathKeywords(input)) return 'math_problem';
        if (this.containsGraphKeywords(input)) return 'graph_request';
        if (this.containsMemoryKeywords(input)) return 'memory_query';
        if (this.containsAPIKeywords(input)) return 'api_request';
        if (this.containsImageKeywords(input)) return 'image_analysis';
        
        return 'conversational';
    }

    containsMathKeywords(input) {
        const mathWords = ['—Ä–µ—à–∏', '–ø–æ—Å—á–∏—Ç–∞–π', '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ', '—Ñ–æ—Ä–º—É–ª–∞', '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è', '–∏–Ω—Ç–µ–≥—Ä–∞–ª', '–∞–ª–≥–µ–±—Ä–∞', '–≥–µ–æ–º–µ—Ç—Ä–∏—è'];
        return mathWords.some(word => input.includes(word));
    }

    containsGraphKeywords(input) {
        const graphWords = ['–≥—Ä–∞—Ñ–∏–∫', '–ø–æ—Å—Ç—Ä–æ–π', '–¥–∏–∞–≥—Ä–∞–º–º–∞', 'chart', 'plot', '—Ñ—É–Ω–∫—Ü–∏—è'];
        return graphWords.some(word => input.includes(word));
    }

    containsMemoryKeywords(input) {
        const memoryWords = ['–ø–æ–º–Ω–∏—à—å', '–≤—Å–ø–æ–º–Ω–∏', '—Ä–∞–Ω–µ–µ', '–ø—Ä–µ–¥—ã–¥—É—â', '–∏—Å—Ç–æ—Ä–∏—è'];
        return memoryWords.some(word => input.includes(word));
    }

    containsAPIKeywords(input) {
        const apiWords = ['–ø–æ–≥–æ–¥–∞', '–∫—É—Ä—Å', '–Ω–æ–≤–æ—Å—Ç–∏', '–ø–µ—Ä–µ–≤–æ–¥', '–ø–æ–∏—Å–∫'];
        return apiWords.some(word => input.includes(word));
    }

    containsImageKeywords(input) {
        const imageWords = ['–∏–∑–æ–±—Ä–∞–∂–µ–Ω', '—Ñ–æ—Ç–æ', '–∫–∞—Ä—Ç–∏–Ω–∫', '—Å–∫—Ä–∏–Ω—à–æ—Ç', '—Ä–∏—Å—É–Ω–æ–∫'];
        return imageWords.some(word => input.includes(word));
    }

    prepareContext(userInput) {
        return {
            timestamp: new Date(),
            userInput: userInput,
            previousContext: this.conversationContext.slice(-4),
            userPreferences: this.userPreferences,
            systemStatus: this.systemStatus
        };
    }

    async processImageRequest(userInput, imageData, context) {
        const analysis = await this.systems.image.analyzeImage(imageData);
        
        let response = "üîç **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**\n\n";
        response += `üìä –¢–∏–ø: ${analysis.imageType}\n`;
        response += `üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${analysis.confidence}%\n\n`;
        
        if (analysis.text) {
            response += `üìù –¢–µ–∫—Å—Ç: ${analysis.text.substring(0, 300)}...\n\n`;
        }
        
        if (analysis.formulas.length > 0) {
            response += `üßÆ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–æ—Ä–º—É–ª—ã:\n`;
            analysis.formulas.forEach(formula => {
                response += `‚Ä¢ ${formula}\n`;
            });
            response += `\n`;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª
            const solutions = await this.solveFormulas(analysis.formulas);
            if (solutions) {
                response += `üî¢ –†–µ—à–µ–Ω–∏—è:\n${solutions}\n\n`;
            }
        }
        
        if (analysis.extractedData) {
            response += this.formatAnalysisData(analysis.extractedData);
        }
        
        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–µ–∫—Å—Ç–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        const contextualResponse = await this.systems.text.generateIntelligentResponse(
            `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${analysis.text?.substring(0, 200)}. ${userInput}`
        );
        
        response += `\nüí≠ **–ê–Ω–∞–ª–∏–∑:** ${contextualResponse}`;
        
        return response;
    }

    async processMathRequest(userInput, context) {
        const solution = await this.systems.math.solveProblem(userInput);
        
        let response = "üßÆ **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**\n\n";
        response += `üìù –ó–∞–¥–∞—á–∞: ${solution.problem}\n\n`;
        response += `üìã –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:\n`;
        
        solution.steps.forEach((step, index) => {
            response += `${step}\n`;
        });
        
        response += `\n‚úÖ **–û—Ç–≤–µ—Ç:** ${solution.answer}\n`;
        
        if (solution.verification) {
            response += `üîç –ü—Ä–æ–≤–µ—Ä–∫–∞: ${solution.verification.method} `;
            response += `(—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${Math.round(solution.verification.confidence * 100)}%)\n`;
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        const explanation = await this.systems.text.generateIntelligentResponse(
            `–û–±—ä—è—Å–Ω–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ: ${solution.answer} –¥–ª—è –∑–∞–¥–∞—á–∏: ${userInput}`
        );
        
        response += `\nüí° **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:** ${explanation}`;
        
        return response;
    }

    async processGraphRequest(userInput, context) {
        const functionMatch = userInput.match(/(?:y\s*=\s*|—Ñ—É–Ω–∫—Ü–∏—è:\s*|–≥—Ä–∞—Ñ–∏–∫\s+)([^,\n]+)/i);
        
        if (functionMatch) {
            const func = functionMatch[1];
            const graphCanvas = this.systems.graphics.plotFunction(func);
            
            return {
                text: `‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏: ${func}`,
                graph: graphCanvas,
                function: func
            };
        }
        
        return "–£–∫–∞–∂–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: 'y = x^2' –∏–ª–∏ 'sin(x)*cos(x)'";
    }

    async processMemoryRequest(userInput, context) {
        const memories = await this.systems.memory.search?.(userInput);
        
        if (memories && memories.length > 0) {
            let response = "üé≠ **–ò–∑ –ø–∞–º—è—Ç–∏ ShamanAI:**\n\n";
            
            memories.slice(0, 3).forEach(memory => {
                response += `‚Ä¢ ${memory.content} (${new Date(memory.timestamp).toLocaleDateString()})\n`;
            });
            
            return response;
        }
        
        return "–í –º–æ–µ–π –ø–∞–º—è—Ç–∏ –Ω–µ—ÇÁõ∏ÂÖ≥‰ø°ÊÅØ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è!";
    }

    async processAPIRequest(userInput, context) {
        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
        const apiResponse = await this.systems.api.generateWithAPI(userInput, context);
        return `üåê **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:**\n\n${apiResponse}`;
    }

    async processConversationalRequest(userInput, context) {
        const useAdvancedAI = localStorage.getItem('shamanai_api_key') && 
                             localStorage.getItem('shamanai_model') !== 'local';
        
        let response;
        
        if (useAdvancedAI) {
            response = await this.systems.api.generateWithAPI(userInput, this.conversationContext);
        } else {
            response = await this.systems.text.generateIntelligentResponse(userInput, this.conversationContext);
        }
        
        return response;
    }

    async solveFormulas(formulas) {
        let solutions = '';
        
        for (const formula of formulas.slice(0, 3)) {
            try {
                const solution = await this.systems.math.solveProblem(formula);
                solutions += `‚Ä¢ ${formula} ‚Üí ${solution.answer}\n`;
            } catch (error) {
                solutions += `‚Ä¢ ${formula} ‚Üí –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å\n`;
            }
        }
        
        return solutions;
    }

    formatAnalysisData(data) {
        let formatted = '';
        
        switch (data.type) {
            case 'handwritten_mathematics':
                formatted += `‚úçÔ∏è –†—É–∫–æ–ø–∏—Å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞:\n`;
                if (data.equations?.length > 0) {
                    formatted += `–£—Ä–∞–≤–Ω–µ–Ω–∏—è: ${data.equations.join(', ')}\n`;
                }
                break;
                
            case 'physics_diagram':
                formatted += `‚ö° –§–∏–∑–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞:\n`;
                if (data.components?.length > 0) {
                    formatted += `–≠–ª–µ–º–µ–Ω—Ç—ã: ${data.components.join(', ')}\n`;
                }
                break;
                
            case 'screenshot':
                formatted += `üì± –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:\n`;
                if (data.homeworkInfo?.subject) {
                    formatted += `–ü—Ä–µ–¥–º–µ—Ç: ${data.homeworkInfo.subject}\n`;
                }
                break;
        }
        
        return formatted;
    }

    formatFinalResponse(response, requestType) {
        if (typeof response === 'object' && response.graph) {
            // –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä–∞—Ñ–∏–∫
            return response;
        }
        
        const prefixes = {
            'image_analysis': 'üîç',
            'math_problem': 'üßÆ', 
            'graph_request': 'üìä',
            'memory_query': 'üé≠',
            'api_request': 'üåê',
            'conversational': 'üí¨'
        };
        
        const prefix = prefixes[requestType] || 'üí¨';
        return `${prefix} ${response}`;
    }

    handleError(error, userInput, requestType) {
        console.error(`–û—à–∏–±–∫–∞ –≤ ${requestType}:`, error);
        
        const errorMessages = {
            'image_analysis': "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.",
            'math_problem': "‚ùå –û—à–∏–±–∫–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É—Å–ª–æ–≤–∏—è.",
            'graph_request': "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é.",
            'default': "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å."
        };
        
        const errorMessage = errorMessages[requestType] || errorMessages.default;
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
        this.systems.memory.saveError?.(error, userInput, requestType);
        
        return errorMessage;
    }

    updateConversationContext(userInput, aiResponse) {
        this.conversationContext.push({
            role: 'user',
            content: userInput,
            timestamp: new Date()
        }, {
            role: 'assistant', 
            content: aiResponse,
            timestamp: new Date()
        });
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if (this.conversationContext.length > 20) {
            this.conversationContext = this.conversationContext.slice(-20);
        }
    }

    async loadUserPreferences() {
        try {
            const preferences = localStorage.getItem('shamanai_preferences');
            if (preferences) {
                this.userPreferences = JSON.parse(preferences);
            }
        } catch (error) {
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        }
    }

    logSystemStatus() {
        const status = {
            '–¢–µ–∫—Å—Ç–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è': '‚úÖ',
            '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π': this.systems.image.isOCRReady ? '‚úÖ' : '‚ö†Ô∏è',
            '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—à–∞—Ç–µ–ª—å': '‚úÖ',
            '–°–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏': '‚úÖ',
            '–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä': '‚úÖ',
            'API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è': '‚úÖ'
        };
        
        console.log("üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º ShamanAI:");
        Object.entries(status).forEach(([system, stat]) => {
            console.log(`${stat} ${system}`);
        });
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    clearConversation() {
        this.conversationContext = [];
        return "üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω–∞.";
    }

    getSystemInfo() {
        return {
            version: "2.0.0",
            status: this.systemStatus,
            contextLength: this.conversationContext.length,
            features: {
                textGeneration: true,
                imageAnalysis: true,
                mathSolving: true,
                memory: true,
                graphics: true,
                apiIntegration: true
            }
        };
    }

    exportConversation() {
        return {
            timestamp: new Date(),
            context: this.conversationContext,
            userPreferences: this.userPreferences
        };
    }
}

// –°–ò–°–¢–ï–ú–ê –ü–ê–ú–Ø–¢–ò –î–õ–Ø SHAMANAI
class MemorySystem {
    constructor() {
        this.memoryKey = 'shamanai_memory';
        this.maxMemories = 100;
        this.memories = [];
        this.load();
    }

    async saveInteraction(userInput, aiResponse, type) {
        const memory = {
            id: Date.now(),
            timestamp: new Date(),
            type: type,
            userInput: userInput,
            aiResponse: aiResponse,
            tags: this.extractTags(userInput)
        };
        
        this.memories.unshift(memory);
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π
        if (this.memories.length > this.maxMemories) {
            this.memories = this.memories.slice(0, this.maxMemories);
        }
        
        await this.save();
        return memory;
    }

    async search(query, limit = 5) {
        const queryLower = query.toLowerCase();
        
        return this.memories.filter(memory => {
            return memory.userInput.toLowerCase().includes(queryLower) ||
                   memory.aiResponse.toLowerCase().includes(queryLower) ||
                   memory.tags.some(tag => tag.includes(queryLower));
        }).slice(0, limit);
    }

    extractTags(text) {
        const tags = [];
        const words = text.toLowerCase().split(/\s+/);
        
        const keyTopics = ['–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '—Ñ–∏–∑–∏–∫–∞', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', '–Ω–∞—É–∫–∞', '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', 
                          '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '–≥—Ä–∞—Ñ–∏–∫', '—Ñ–æ—Ä–º—É–ª–∞', '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ'];
        
        keyTopics.forEach(topic => {
            if (text.toLowerCase().includes(topic)) {
                tags.push(topic);
            }
        });
        
        return tags.slice(0, 5);
    }

    async saveError(error, userInput, context) {
        const errorMemory = {
            type: 'error',
            timestamp: new Date(),
            error: error.message,
            userInput: userInput,
            context: context,
            stack: error.stack
        };
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        const errors = JSON.parse(localStorage.getItem('shamanai_errors') || '[]');
        errors.unshift(errorMemory);
        
        if (errors.length > 50) {
            errors.pop();
        }
        
        localStorage.setItem('shamanai_errors', JSON.stringify(errors));
    }

    async load() {
        try {
            const saved = localStorage.getItem(this.memoryKey);
            if (saved) {
                this.memories = JSON.parse(saved);
            }
        } catch (error) {
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–º—è—Ç—å:", error);
            this.memories = [];
        }
    }

    async save() {
        try {
            localStorage.setItem(this.memoryKey, JSON.stringify(this.memories));
        } catch (error) {
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å:", error);
        }
    }

    clear() {
        this.memories = [];
        this.save();
    }

    getStats() {
        return {
            totalMemories: this.memories.length,
            lastUpdated: this.memories[0]?.timestamp || null,
            memoryTypes: this.getMemoryTypeCounts()
        };
    }

    getMemoryTypeCounts() {
        const counts = {};
        this.memories.forEach(memory => {
            counts[memory.type] = (counts[memory.type] || 0) + 1;
        });
        return counts;
    }
}

// –°–ò–°–¢–ï–ú–ê –ì–†–ê–§–ò–ö–û–í –ò –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò
class GraphicsRenderer {
    constructor() {
        this.chartInstances = new Map();
    }

    plotFunction(func, options = {}) {
        const canvas = document.createElement('canvas');
        canvas.width = options.width || 600;
        canvas.height = options.height || 400;
        canvas.className = 'shamanai-graph';
        
        const ctx = canvas.getContext('2d');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
        const config = {
            xMin: options.xMin || -10,
            xMax: options.xMax || 10,
            color: options.color || '#8A2BE2',
            lineWidth: options.lineWidth || 3
        };
        
        this.drawFunctionOnCanvas(ctx, func, config, canvas.width, canvas.height);
        
        return canvas;
    }

    drawFunctionOnCanvas(ctx, func, config, width, height) {
        const { xMin, xMax, color, lineWidth } = config;
        const padding = 40;
        const graphWidth = width - 2 * padding;
        const graphHeight = height - 2 * padding;
        
        // –û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ–Ω
        ctx.fillStyle = 'rgba(26, 26, 46, 0.9)';
        ctx.fillRect(0, 0, width, height);
        
        // –û—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        ctx.strokeStyle = '#00CED1';
        ctx.lineWidth = 2;
        
        // –û—Å—å X
        ctx.beginPath();
        ctx.moveTo(0, height - padding);
        ctx.lineTo(width, height - padding);
        ctx.stroke();
        
        // –û—Å—å Y
        ctx.beginPath();
        ctx.moveTo(padding, 0);
        ctx.lineTo(padding, height);
        ctx.stroke();
        
        // –°–µ—Ç–∫–∞
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        
        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
        for (let x = xMin; x <= xMax; x += 2) {
            const pixelX = padding + (x - xMin) * (graphWidth / (xMax - xMin));
            ctx.beginPath();
            ctx.moveTo(pixelX, 0);
            ctx.lineTo(pixelX, height);
            ctx.stroke();
        }
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
        const yRange = 20;
        for (let y = -10; y <= 10; y += 2) {
            const pixelY = height - padding - (y + 10) * (graphHeight / yRange);
            ctx.beginPath();
            ctx.moveTo(0, pixelY);
            ctx.lineTo(width, pixelY);
            ctx.stroke();
        }
        
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏
        ctx.strokeStyle = color;
        ctx.lineWidth = lineWidth;
        ctx.beginPath();
        
        let firstPoint = true;
        
        for (let x = xMin; x <= xMax; x += 0.1) {
            try {
                // –ó–∞–º–µ–Ω—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
                const processedFunc = func
                    .replace(/sin/g, 'Math.sin')
                    .replace(/cos/g, 'Math.cos')
                    .replace(/tan/g, 'Math.tan')
                    .replace(/sqrt/g, 'Math.sqrt')
                    .replace(/log/g, 'Math.log')
                    .replace(/pi/g, 'Math.PI')
                    .replace(/e/g, 'Math.E')
                    .replace(/\^/g, '**');
                
                const y = eval(processedFunc.replace(/x/g, `(${x})`));
                
                if (isNaN(y) || !isFinite(y)) {
                    firstPoint = true;
                    continue;
                }
                
                const pixelX = padding + (x - xMin) * (graphWidth / (xMax - xMin));
                const pixelY = height - padding - (y + 10) * (graphHeight / 20);
                
                if (firstPoint) {
                    ctx.moveTo(pixelX, pixelY);
                    firstPoint = false;
                } else {
                    ctx.lineTo(pixelX, pixelY);
                }
            } catch (error) {
                firstPoint = true;
            }
        }
        
        ctx.stroke();
        
        // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
        ctx.fillStyle = '#F0F8FF';
        ctx.font = '12px Courier New';
        ctx.fillText('x', width - 20, height - padding + 20);
        ctx.fillText('y', padding - 20, 20);
        
        return canvas;
    }

    createPhysicsDiagram(type, parameters) {
        const canvas = document.createElement('canvas');
        canvas.width = 500;
        canvas.height = 300;
        canvas.className = 'shamanai-diagram';
        
        const ctx = canvas.getContext('2d');
        
        switch (type) {
            case 'electrical_circuit':
                this.drawElectricalCircuit(ctx, parameters);
                break;
            case 'mechanical_system':
                this.drawMechanicalSystem(ctx, parameters);
                break;
            case 'optical_diagram':
                this.drawOpticalDiagram(ctx, parameters);
                break;
        }
        
        return canvas;
    }

    drawElectricalCircuit(ctx, params) {
        ctx.fillStyle = 'rgba(26, 26, 46, 0.9)';
        ctx.fillRect(0, 0, 500, 300);
        
        ctx.strokeStyle = '#00CED1';
        ctx.lineWidth = 3;
        ctx.fillStyle = '#F0F8FF';
        ctx.font = '14px Courier New';
        
        // –ë–∞—Ç–∞—Ä–µ—è
        ctx.fillRect(50, 100, 40, 100);
        ctx.fillText('–ë–∞—Ç–∞—Ä–µ—è', 35, 90);
        
        // –†–µ–∑–∏—Å—Ç–æ—Ä—ã
        ctx.fillRect(150, 100, 60, 20);
        ctx.fillText('R1', 170, 90);
        
        ctx.fillRect(150, 180, 60, 20);
        ctx.fillText('R2', 170, 250);
        
        // –ö–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä
        ctx.fillRect(280, 80, 10, 60);
        ctx.fillRect(300, 80, 10, 60);
        ctx.fillText('C1', 285, 70);
        
        // –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        ctx.beginPath();
        ctx.moveTo(90, 100); ctx.lineTo(150, 100);
        ctx.moveTo(210, 110); ctx.lineTo(280, 110);
        ctx.moveTo(310, 110); ctx.lineTo(400, 110);
        ctx.moveTo(50, 200); ctx.lineTo(400, 200);
        ctx.stroke();
    }

    drawMechanicalSystem(ctx, params) {
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã
        ctx.fillStyle = 'rgba(26, 26, 46, 0.9)';
        ctx.fillRect(0, 0, 500, 300);
        
        ctx.strokeStyle = '#FF1493';
        ctx.lineWidth = 3;
        ctx.fillStyle = '#F0F8FF';
        ctx.font = '14px Courier New';
        
        // –ü—Ä—É–∂–∏–Ω–∞
        this.drawSpring(ctx, 100, 150, 200, 150);
        ctx.fillText('–ü—Ä—É–∂–∏–Ω–∞', 150, 140);
        
        // –ú–∞—Å—Å–∞
        ctx.fillRect(200, 130, 60, 40);
        ctx.fillText('–ú–∞—Å—Å–∞ m', 210, 125);
        
        // –û–ø–æ—Ä–∞
        ctx.fillRect(80, 140, 20, 60);
        ctx.fillText('–û–ø–æ—Ä–∞', 60, 220);
    }

    drawSpring(ctx, x1, y1, x2, y2) {
        const segments = 8;
        const dx = (x2 - x1) / segments;
        const amplitude = 10;
        
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        
        for (let i = 1; i < segments; i++) {
            const x = x1 + i * dx;
            const y = y1 + (i % 2 === 0 ? -amplitude : amplitude);
            ctx.lineTo(x, y);
        }
        
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }

    drawOpticalDiagram(ctx, params) {
        ctx.fillStyle = 'rgba(26, 26, 46, 0.9)';
        ctx.fillRect(0, 0, 500, 300);
        
        ctx.strokeStyle = '#8A2BE2';
        ctx.lineWidth = 2;
        ctx.fillStyle = '#F0F8FF';
        ctx.font = '14px Courier New';
        
        // –õ–∏–Ω–∑–∞
        ctx.beginPath();
        ctx.ellipse(250, 150, 20, 80, 0, 0, 2 * Math.PI);
        ctx.stroke();
        ctx.fillText('–õ–∏–Ω–∑–∞', 240, 80);
        
        // –õ—É—á–∏
        ctx.beginPath();
        ctx.moveTo(50, 100); ctx.lineTo(230, 150);
        ctx.moveTo(50, 200); ctx.lineTo(230, 150);
        ctx.moveTo(270, 150); ctx.lineTo(450, 120);
        ctx.moveTo(270, 150); ctx.lineTo(450, 180);
        ctx.stroke();
        
        ctx.fillText('–ü—Ä–µ–¥–º–µ—Ç', 30, 220);
        ctx.fillText('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 400, 220);
    }
}

// –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
let finalShamanAI;

async function initializeFinalShamanAI() {
    try {
        finalShamanAI = new ShamanAIFinal();
        
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        await new Promise(resolve => {
            const checkInit = setInterval(() => {
                if (finalShamanAI.isInitialized) {
                    clearInterval(checkInit);
                    resolve();
                }
            }, 100);
        });
        
        console.log("üéâ ShamanAI 2.0 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!");
        return true;
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ShamanAI:", error);
        return false;
    }
}

// –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï
function setupFinalInterface() {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const toolsPanel = document.querySelector('.tools-panel');
    
    const finalControls = document.createElement('div');
    finalControls.className = 'tool-section';
    finalControls.innerHTML = `
        <h3 class="tool-title">üéõÔ∏è –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–û–ô</h3>
        <button class="button" onclick="showSystemInfo()" style="width: 100%; margin-bottom: 10px;">–ò–ù–§–û –°–ò–°–¢–ï–ú–´</button>
        <button class="button" onclick="exportConversation()" style="width: 100%; margin-bottom: 10px;">–≠–ö–°–ü–û–†–¢ –ß–ê–¢–ê</button>
        <button class="button" onclick="clearAllData()" style="width: 100%; margin-bottom: 10px; background: linear-gradient(45deg, #FF4444, #FF1493);">–û–ß–ò–°–¢–ò–¢–¨ –í–°–Å</button>
        <button class="button" onclick="toggleAdvancedMode()" style="width: 100%; background: linear-gradient(45deg, #00CED1, #20B2AA);">–†–ï–ñ–ò–ú –≠–ö–°–ü–ï–†–¢–ê</button>
    `;
    
    toolsPanel.appendChild(finalControls);
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
    const statusIndicator = document.createElement('div');
    statusIndicator.id = 'systemStatusIndicator';
    statusIndicator.className = 'system-status-panel';
    statusIndicator.innerHTML = `
        <div class="status-item">
            <span>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:</span>
            <span id="currentSystemStatus" class="matrix-text">üîÑ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø</span>
        </div>
    `;
    
    toolsPanel.insertBefore(statusIndicator, toolsPanel.firstChild);
}

// –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
async function showSystemInfo() {
    if (!finalShamanAI) return;
    
    const info = finalShamanAI.getSystemInfo();
    const memoryStats = finalShamanAI.systems.memory.getStats?.() || {};
    
    let message = `ü§ñ **ShamanAI System Information**\n\n`;
    message += `‚Ä¢ –í–µ—Ä—Å–∏—è: ${info.version}\n`;
    message += `‚Ä¢ –°—Ç–∞—Ç—É—Å: ${info.status}\n`;
    message += `‚Ä¢ –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ${info.contextLength} —Å–æ–æ–±—â–µ–Ω–∏–π\n`;
    message += `‚Ä¢ –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π: ${memoryStats.totalMemories || 0}\n\n`;
    message += `**–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**\n`;
    
    Object.entries(info.features).forEach(([feature, enabled]) => {
        message += `‚Ä¢ ${feature}: ${enabled ? '‚úÖ' : '‚ùå'}\n`;
    });
    
    addMessageToChat(message, 'ai');
}

async function exportConversation() {
    if (!finalShamanAI) return;
    
    const data = finalShamanAI.exportConversation();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `shamanai-chat-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    URL.revokeObjectURL(url);
    addMessageToChat("üíæ –ß–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ JSON —Ñ–∞–π–ª", 'ai');
}

async function clearAllData() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) {
        localStorage.clear();
        if (finalShamanAI) {
            finalShamanAI.clearConversation();
            finalShamanAI.systems.memory.clear?.();
        }
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '<div class="message ai-message"><span class="matrix-text">>> –°–ò–°–¢–ï–ú–ê –°–ë–†–û–®–ï–ù–ê</span><br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç–µ.</div>';
        
        document.getElementById('mathOutput').innerHTML = '<span class="matrix-text">>> –°–ò–°–¢–ï–ú–ê –û–ß–ò–©–ï–ù–ê</span><br>–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è...';
    }
}

function toggleAdvancedMode() {
    const advancedMode = localStorage.getItem('shamanai_advanced') === 'true';
    localStorage.setItem('shamanai_advanced', (!advancedMode).toString());
    
    addMessageToChat(
        advancedMode ? 
        "üîí –†–µ–∂–∏–º —ç–∫—Å–ø–µ—Ä—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω" : 
        "üîì <span class='matrix-text'>–†–ï–ñ–ò–ú –≠–ö–°–ü–ï–†–¢–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù</span><br>–î–æ—Å—Ç—É–ø–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.",
        'ai'
    );
}

// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –°–û–û–ë–©–ï–ù–ò–ô
async function processFinalInput() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message && !currentImage) return;
    
    if (message) {
        addMessageToChat(message, 'user');
        input.value = '';
        
        showTypingIndicator();
        
        try {
            const response = await finalShamanAI.processMessage(message, currentImage);
            hideTypingIndicator();
            
            if (typeof response === 'object' && response.graph) {
                // –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä–∞—Ñ–∏–∫
                addMessageToChat(response.text, 'ai');
                addGraphToChat(response.graph);
            } else {
                addMessageToChat(response, 'ai');
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
            document.getElementById('mathOutput').innerHTML = 
                typeof response === 'string' ? response.replace(/\n/g, '<br>') : response.text;
            
        } catch (error) {
            hideTypingIndicator();
            addMessageToChat("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "ai");
            console.error("Final AI Error:", error);
        }
        
        currentImage = null;
        document.getElementById('previewCanvas').style.display = 'none';
    }
}

function addGraphToChat(canvas) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    messageDiv.appendChild(canvas);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –°–ò–°–¢–ï–ú–´
function updateSystemStatus() {
    if (!finalShamanAI) return;
    
    const statusElement = document.getElementById('currentSystemStatus');
    if (statusElement) {
        const status = finalShamanAI.systemStatus;
        const statusText = {
            'initializing': 'üîÑ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø',
            'ready': '‚úÖ –ì–û–¢–û–í',
            'error': '‚ùå –û–®–ò–ë–ö–ê'
        }[status] || '‚ùì –ù–ï–ò–ó–í–ï–°–¢–ù–û';
        
        statusElement.textContent = statusText;
    }
}

// –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
window.addEventListener('load', async function() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
    addMessageToChat("üöÄ <span class='matrix-text'>–ó–ê–ü–£–°–ö SHAMANAI 2.0</span><br>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –ò–ò —Å–∏—Å—Ç–µ–º—ã...", "ai");
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
    const success = await initializeFinalShamanAI();
    
    if (success) {
        addMessageToChat("‚úÖ <span class='matrix-text'>–°–ò–°–¢–ï–ú–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê</span><br>ShamanAI 2.0 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ä–µ—à–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ - —è –ø–æ–º–æ–≥—É —Å–æ –≤—Å–µ–º!", "ai");
        setupFinalInterface();
        updateSystemStatus();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏
        window.sendMessage = processFinalInput;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(updateSystemStatus, 5000);
        
    } else {
        addMessageToChat("‚ùå <span class='matrix-text'>–û–®–ò–ë–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò</span><br>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "ai");
    }
});

// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
let currentImage = null;

// –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
function addMessageToChat(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    messageDiv.innerHTML = message;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            
            const maxWidth = 400;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.style.display = 'block';
            
            currentImage = canvas;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function analyzeImage() {
    if (!currentImage) {
        addMessageToChat("‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", 'ai');
        return;
    }
    
    addMessageToChat("üñºÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...", 'user');
    processFinalInput();
}
</script>

<style>
/* –§–ò–ù–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò SHAMANAI 2.0 */
.shamanai-graph {
    border: 2px solid var(--secondary);
    border-radius: 10px;
    margin: 10px 0;
    background: rgba(26, 26, 46, 0.9);
    box-shadow: var(--neon-glow);
}

.shamanai-diagram {
    border: 2px solid var(--primary);
    border-radius: 10px;
    margin: 10px 0;
    background: rgba(26, 26, 46, 0.9);
}

.system-status-panel {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid var(--matrix);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    backdrop-filter: blur(10px);
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
    border-left: 3px solid var(--matrix);
}

.export-button {
    background: linear-gradient(45deg, var(--secondary), var(--matrix));
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 5px;
}

.export-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 15px var(--matrix);
}

.memory-badge {
    display: inline-block;
    background: rgba(138, 43, 226, 0.3);
    border: 1px solid var(--primary);
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.7em;
    margin-left: 8px;
}

.context-indicator {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid var(--secondary);
    font-size: 0.8em;
    backdrop-filter: blur(5px);
}

.advanced-mode {
    border: 2px solid var(--matrix) !important;
    box-shadow: 0 0 20px var(--matrix) !important;
}

.performance-monitor {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--accent);
    font-size: 0.7em;
    backdrop-filter: blur(5px);
}

.matrix-border {
    position: relative;
    border: 1px solid var(--matrix);
    border-radius: 10px;
    padding: 2px;
    background: linear-gradient(45deg, transparent, rgba(0, 255, 65, 0.1), transparent);
}

@keyframes matrixFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.animated-background {
    background: linear-gradient(-45deg, var(--dark), #16213E, #0F3460, var(--dark));
    background-size: 400% 400%;
    animation: matrixFlow 10s ease infinite;
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
@media (max-width: 768px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
    
    .shaman-title {
        font-size: 2.5rem;
    }
    
    .chat-messages {
        height: 400px;
    }
    
    .context-indicator,
    .performance-monitor {
        position: static;
        margin: 10px;
    }
    
    .shamanai-graph,
    .shamanai-diagram {
        width: 100%;
        height: auto;
    }
}

/* –ê–ù–ò–ú–ê–¶–ò–ò */
@keyframes systemReady {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
}

.system-ready {
    animation: systemReady 0.5s ease-out;
}

@keyframes dataFlow {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.data-flow {
    position: relative;
    overflow: hidden;
}

.data-flow::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--matrix), transparent);
    animation: dataFlow 2s infinite;
}

/* –¢–ï–ú–´ */
.dark-theme {
    --primary: #8A2BE2;
    --secondary: #00CED1;
    --accent: #FF1493;
    --dark: #1A1A2E;
    --light: #F0F8FF;
}

.matrix-theme {
    --primary: #00FF41;
    --secondary: #008F11;
    --accent: #00FF88;
    --dark: #0A0A0A;
    --light: #00FF41;
}

.neon-theme {
    --primary: #FF00FF;
    --secondary: #00FFFF;
    --accent: #FFFF00;
    --dark: #000000;
    --light: #FFFFFF;
}

.theme-selector {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--secondary);
    backdrop-filter: blur(5px);
}

.theme-button {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin: 5px;
    cursor: pointer;
    border: 2px solid transparent;
}

.theme-button.active {
    border-color: white;
}

.theme-dark { background: #8A2BE2; }
.theme-matrix { background: #00FF41; }
.theme-neon { background: #FF00FF; }
</style>

<!-- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê -->
<div class="context-indicator" id="contextIndicator">
    <span class="matrix-text">–ö–æ–Ω—Ç–µ–∫—Å—Ç: </span>
    <span id="contextCount">0</span> —Å–æ–æ–±—â–µ–Ω–∏–π
</div>

<div class="performance-monitor">
    <div>CPU: <span id="cpuUsage">--%</span></div>
    <div>–ü–∞–º—è—Ç—å: <span id="memoryUsage">--MB</span></div>
    <div>–í—Ä–µ–º—è: <span id="responseTime">--ms</span></div>
</div>

<div class="theme-selector">
    <div class="theme-button theme-dark active" onclick="changeTheme('dark')"></div>
    <div class="theme-button theme-matrix" onclick="changeTheme('matrix')"></div>
    <div class="theme-button theme-neon" onclick="changeTheme('neon')"></div>
</div>

<script>
// –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
function updateContextIndicator() {
    if (finalShamanAI) {
        const count = finalShamanAI.conversationContext.length;
        document.getElementById('contextCount').textContent = count;
    }
}

function changeTheme(theme) {
    document.body.className = theme + '-theme';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–µ–º—ã
    document.querySelectorAll('.theme-button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
function startPerformanceMonitoring() {
    setInterval(() => {
        if (performance.memory) {
            const memory = performance.memory.usedJSHeapSize / 1024 / 1024;
            document.getElementById('memoryUsage').textContent = Math.round(memory);
        }
    }, 2000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
setInterval(updateContextIndicator, 1000);

// –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
window.addEventListener('load', startPerformanceMonitoring);
</script>
